<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FuelSkip - Customer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Razorpay Checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      max-width: 800px;
      margin: 0 auto;
      background:#f3f4f6;
      line-height: 1.4;
    }
    h2 { margin-bottom: 12px; font-size: 22px; }
    h3 { margin-top: 0; margin-bottom: 8px; font-size: 18px; }

    .card {
      background:white;
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.06);
      border: 1px solid #e5e7eb;
    }
    .label { font-size: 14px; margin-bottom: 4px; color:#4b5563; }
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }
    button, .btn-secondary, .btn-primary {
      border: none;
      border-radius: 6px;
      padding: 10px 14px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s;
    }
    button:active { transform: scale(0.99); }

    .btn-primary {
      background: #16a34a;
      color: white;
      width: 100%;
    }
    .btn-primary:hover { background:#15803d; }

    .btn-secondary {
      background: #2563eb;
      color: white;
    }
    .btn-secondary:hover { background:#1d4ed8; }

    .btn-small { padding: 6px 10px; font-size: 12px; }

    #voucherBox { display: none; }
    #qrContainer { margin-top: 12px; display: flex; justify-content: center; }

    .history-item {
      border-bottom: 1px solid #e5e7eb;
      padding: 6px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-pending { background: #fef3c7; color:#92400e; }
    .badge-paid { background: #dcfce7; color:#166534; }
    .badge-used { background: #e5e7eb; color:#374151; }
    .badge-failed { background: #fee2e2; color:#b91c1c; }
  </style>
</head>
<body>

  <!-- Header with user + logout -->
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <h2>⛽ FuelSkip - BPCL Siripuram</h2>
    <div style="display:flex; align-items:center; gap:8px;">
      <span id="userDisplay" style="font-size:13px; color:#4b5563;"></span>
      <button class="btn-secondary btn-small" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Login -->
  <div class="card" id="loginBox">
    <h3>Login</h3>
    <div class="label">Phone</div>
    <input id="phone" placeholder="Enter phone (for history)" />
    <div class="label">Name (optional)</div>
    <input id="name" placeholder="Enter name" />
    <button class="btn-primary" onclick="login()">Login</button>
  </div>

  <!-- Create voucher (hidden until login) -->
  <div class="card" id="createBox" style="display:none;">
    <h3>Create voucher</h3>
    <div class="label">Enter amount (₹)</div>
    <input id="amount" type="number" min="1" />
    <div style="text-align:center; margin:4px 0; color:#6b7280;">or</div>
    <div class="label">Enter litres</div>
    <input id="litres" type="number" min="0.1" step="0.01" />
    <button class="btn-primary" onclick="createVoucher()">Create Voucher</button>
    <p id="msg" style="font-size:13px; color:#6b7280; margin-top:8px;"></p>
  </div>

  <!-- Voucher + payment + QR -->
  <div class="card" id="voucherBox">
    <h3>Voucher created</h3>
    <div id="voucherDetails" style="font-size:14px; margin-bottom:8px;"></div>
    <div>
      <p style="margin:4px 0 6px 0;">Payment:</p>
      <button type="button" class="btn-primary" id="payBtn" onclick="payNow()">Pay now</button>
    </div>
    <div id="qrSection" style="margin-top:12px; display:none;">
      <p style="margin:0 0 6px 0; font-size:14px;">Show this QR at pump:</p>
      <div id="qrContainer"></div>
    </div>
  </div>

  <!-- History (hidden until login) -->
  <div class="card" id="historyBox" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0;">My vouchers</h3>
      <button class="btn-secondary btn-small" onclick="loadMyVouchers()">⟲ Refresh</button>
    </div>
    <div id="myVouchers" style="margin-top:8px; font-size:13px; color:#4b5563;">
      Login with phone to see your history.
    </div>
  </div>

<script>
const API = "https://fuelskip-production.up.railway.app";

let lastVoucherId = null;
let razorpayOrderId = null;
let razorpayKeyId = null;
let pollTimer = null;

// --- Helpers ---
function getUserId() {
  return window.localStorage.getItem("fuelskip_user_id");
}
function setUserId(id) {
  window.localStorage.setItem("fuelskip_user_id", id);
}
function setUserName(name) {
  window.localStorage.setItem("fuelskip_user_name", name || "");
}
function setUserPhone(phone) {
  window.localStorage.setItem("fuelskip_user_phone", phone || "");
}

function refreshUserDisplay() {
  const name = window.localStorage.getItem("fuelskip_user_name") || "";
  const phone = window.localStorage.getItem("fuelskip_user_phone") || "";
  const span = document.getElementById("userDisplay");
  if (name || phone) {
    span.textContent = name ? `${name} (${phone})` : phone;
  } else {
    span.textContent = "";
  }
}

function showAfterLogin() {
  document.getElementById("loginBox").style.display = "none";
  document.getElementById("createBox").style.display = "block";
  document.getElementById("historyBox").style.display = "block";
  refreshUserDisplay();
  loadMyVouchers();
}

// --- Logout ---
function logout() {
  window.localStorage.removeItem("fuelskip_user_id");
  window.localStorage.removeItem("fuelskip_user_name");
  window.localStorage.removeItem("fuelskip_user_phone");

  document.getElementById("phone").value = "";
  document.getElementById("name").value = "";
  document.getElementById("amount").value = "";
  document.getElementById("litres").value = "";
  document.getElementById("msg").textContent = "";
  document.getElementById("voucherDetails").textContent = "";
  document.getElementById("qrContainer").innerHTML = "";
  document.getElementById("qrSection").style.display = "none";

  document.getElementById("loginBox").style.display = "block";
  document.getElementById("createBox").style.display = "none";
  document.getElementById("historyBox").style.display = "none";
  document.getElementById("voucherBox").style.display = "none";

  document.getElementById("myVouchers").textContent =
    "Login with phone to see your history.";

  document.getElementById("userDisplay").textContent = "";

  if (pollTimer) {
    clearInterval(pollTimer);
    pollTimer = null;
  }
}

// --- Login ---
async function login() {
  const phone = document.getElementById("phone").value.trim();
  const name = document.getElementById("name").value.trim() || null;
  if (!phone) {
    alert("Enter phone");
    return;
  }
  try {
    const res = await fetch(`${API}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, name })
    });
    if (!res.ok) {
      const err = await res.json();
      alert("Login failed: " + (err.detail || res.status));
      return;
    }
    const data = await res.json();
    setUserId(data.user_id);
    setUserName(data.name || "");
    setUserPhone(data.phone || "");
    showAfterLogin();
  } catch (e) {
    alert("Error: " + e.message);
  }
}

// Auto-restore session on load
window.addEventListener("load", () => {
  if (getUserId()) {
    showAfterLogin();
  } else {
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("createBox").style.display = "none";
    document.getElementById("historyBox").style.display = "none";
    document.getElementById("voucherBox").style.display = "none";
    refreshUserDisplay();
  }
});

// --- Create voucher ---
async function createVoucher() {
  const amountVal = document.getElementById("amount").value;
  const litresVal = document.getElementById("litres").value;
  const userId = getUserId();

  if (!amountVal && !litresVal) {
    alert("Enter amount or litres");
    return;
  }

  const msg = document.getElementById("msg");
  msg.textContent = "Creating voucher...";

  try {
    const res = await fetch(`${API}/create-voucher`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        bunk_id: "BUNK-1",
        amount: amountVal ? Number(amountVal) : null,
        litres: litresVal ? Number(litresVal) : null,
        user_id: userId ? Number(userId) : null
      })
    });
    if (!res.ok) {
      const err = await res.json();
      msg.textContent = "Error: " + (err.detail || res.status);
      return;
    }
    const data = await res.json();
    lastVoucherId = data.voucher_id;
    razorpayOrderId = data.razorpay_order_id;
    razorpayKeyId = data.razorpay_key_id;

    document.getElementById("voucherDetails").textContent =
      `Voucher ID: ${data.voucher_id} | Amount: ₹${data.amount} | Litres: ${data.litres} | Rate: ₹${data.price_per_litre} / L`;

    document.getElementById("voucherBox").style.display = "block";
    document.getElementById("qrSection").style.display = "none";
    document.getElementById("qrContainer").innerHTML = "";

    msg.textContent = "Voucher created. Complete payment to get QR.";
  } catch (e) {
    msg.textContent = "Error: " + e.message;
  }
}

// --- Razorpay payment ---
function payNow() {
  if (!razorpayOrderId || !razorpayKeyId) {
    alert("Payment not ready; create voucher again.");
    return;
  }

  const options = {
    key: razorpayKeyId,
    order_id: razorpayOrderId,
    name: "FuelSkip",
    description: "Fuel voucher " + lastVoucherId,
    redirect: false,
    handler: function (response) {
      console.log("Payment success:", response);
      startPollingStatus();
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();
}

// --- Poll voucher status & show QR ---
function startPollingStatus() {
  if (!lastVoucherId) return;
  if (pollTimer) window.clearInterval(pollTimer);
  pollTimer = window.setInterval(checkVoucherStatus, 3000);
}

async function checkVoucherStatus() {
  if (!lastVoucherId) return;

  try {
    const res = await fetch(`${API}/voucher-status/${lastVoucherId}`);
    if (!res.ok) return;
    const data = await res.json();

    if (data.status === "paid") {
      window.clearInterval(pollTimer);
      showQr();
      loadMyVouchers();
    }
  } catch (e) {
    console.log("Status poll error:", e);
  }
}

function showQr() {
  const qrSection = document.getElementById("qrSection");
  const qrContainer = document.getElementById("qrContainer");
  qrSection.style.display = "block";
  qrContainer.innerHTML = "";

  const attendantUrl = `https://fuelskip-production.up.railway.app/attendant.html?voucher=${encodeURIComponent(lastVoucherId)}`;

  new QRCode(qrContainer, {
    text: attendantUrl,
    width: 200,
    height: 200
  });
}

// --- History ---
function statusBadge(status) {
  status = (status || "").toLowerCase();
  if (status === "paid") return '<span class="badge badge-paid">Paid</span>';
  if (status === "used") return '<span class="badge badge-used">Used</span>';
  if (status === "failed") return '<span class="badge badge-failed">Failed</span>';
  return '<span class="badge badge-pending">Pending</span>';
}

async function loadMyVouchers() {
  const userId = getUserId();
  const container = document.getElementById("myVouchers");
  if (!userId) {
    container.textContent = "Login with phone to see your history.";
    return;
  }

  try {
    const res = await fetch(`${API}/my-vouchers?user_id=${encodeURIComponent(userId)}`);
    if (!res.ok) {
      container.textContent = "Could not load history.";
      return;
    }
    const vouchers = await res.json();
    if (!vouchers.length) {
      container.textContent = "No vouchers yet.";
      return;
    }
    container.innerHTML = vouchers.map(v => {
      const created = v.created_at || "";
      return `
        <div class="history-item">
          <div>
            <div><strong>${v.id}</strong> • ₹${v.amount} • ${v.litres} L</div>
            <div style="font-size:11px; color:#9ca3af;">${created}</div>
          </div>
          <div>${statusBadge(v.status)}</div>
        </div>
      `;
    }).join("");
  } catch (e) {
    container.textContent = "Error loading history.";
  }
}
</script>
</body>
</html>
