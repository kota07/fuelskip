<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FuelSkip - Customer (Analytics + Flow)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Razorpay Checkout -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  margin: 0;
  padding: 12px;
  color: #1e293b;
  line-height: 1.5;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* MAIN LAYOUT WRAPPER */
.app-shell {
  position: relative;
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}

/* Sidebar drawer - Mobile optimized */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 280px;
  max-width: 90vw;
  height: 100vh;
  background: #ffffff;
  border-radius: 0 24px 24px 0;
  box-shadow: 0 25px 50px rgba(0,0,0,0.25);
  padding: 0;
  display: flex;
  flex-direction: column;
  transform: translateX(-100%);
  transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  z-index: 1000;
  backdrop-filter: blur(20px);
}
.sidebar.open {
  transform: translateX(0);
}
.sidebar-header {
  padding: 24px;
  border-bottom: 1px solid #f1f5f9;
  background: linear-gradient(135deg, #667eea15, #764ba215);
}
.sidebar-header h2 {
  margin: 0 0 8px;
  font-size: 20px;
  font-weight: 700;
  color: #1e293b;
}
.sidebar-header small {
  font-size: 13px;
  color: #64748b;
  font-weight: 500;
}
.sidebar-menu {
  list-style: none;
  padding: 0;
  margin: 0;
  flex: 1;
  overflow-y: auto;
}
.sidebar-menu li {
  margin: 0;
}
.sidebar-menu a {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 24px;
  font-size: 15px;
  font-weight: 500;
  color: #64748b;
  text-decoration: none;
  border-left: 4px solid transparent;
  transition: all 0.2s ease;
  position: relative;
}
.sidebar-menu a:hover,
.sidebar-menu a.active {
  background: linear-gradient(135deg, #eef2ff, #e0f2fe);
  border-left-color: #6366f1;
  color: #1e293b;
}
.sidebar-footer {
  padding: 20px 24px;
  border-top: 1px solid #f1f5f9;
}
.sidebar-footer button {
  width: 100%;
  border: none;
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  padding: 14px 20px;
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  border-radius: 12px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 10px;
}
.sidebar-footer button:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 10px 25px rgba(239,68,68,0.3);
}

/* Backdrop */
.backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  z-index: 999;
  backdrop-filter: blur(8px);
}
.backdrop.show {
  opacity: 1;
  pointer-events: auto;
}
.sidebar-hidden {
  display: none !important;
}

/* Main container - Mobile first */
.container {
  max-width: 100%;
  background: rgba(255,255,255,0.97);
  border-radius: 24px;
  padding: 24px 20px 28px;
  box-shadow: 0 25px 50px rgba(0,0,0,0.15);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.3);
  margin-bottom: 20px;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid #f1f5f9;
}

h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 800;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-pill {
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  background: #f8fafc;
  padding: 6px 10px;
  border-radius: 20px;
  white-space: nowrap;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.hamburger {
  border: none;
  background: linear-gradient(135deg, #1e293b, #334155);
  color: #f8fafc;
  border-radius: 12px;
  padding: 8px 12px;
  font-size: 18px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(30,41,59,0.3);
  transition: all 0.2s ease;
  min-width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.hamburger:active {
  transform: scale(0.95);
}

.card {
  background: rgba(255,255,255,0.9);
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  border: 1px solid rgba(248,250,252,0.8);
  transition: all 0.2s ease;
}
.card:last-child {
  margin-bottom: 0;
}

.form-group { 
  margin-bottom: 20px;
  position: relative;
}
.label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #374151;
}
input, select {
  width: 100%;
  padding: 14px 16px;
  border-radius: 14px;
  border: 2px solid #f1f5f9;
  font-size: 16px;
  box-sizing: border-box;
  background: #fafbfc;
  font-weight: 500;
  transition: all 0.2s ease;
}
input:focus, select:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 4px rgba(99,102,241,0.1);
  background: white;
}

input:invalid {
  border-color: #f87171;
}

.vehicle-section {
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  padding: 20px;
  border-radius: 16px;
  margin-bottom: 20px;
  border-left: 5px solid #6366f1;
}
.vehicle-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
  margin-top: 12px;
}

button {
  border: none;
  border-radius: 14px;
  padding: 14px 20px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
  min-height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
}
button:active { 
  transform: scale(0.97); 
}
button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.btn-primary {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  width: 100%;
  margin-top: 8px;
  box-shadow: 0 8px 25px rgba(34,197,94,0.3);
}
.btn-primary:hover:not(:disabled) {
  background: linear-gradient(135deg, #16a34a, #15803d);
  box-shadow: 0 12px 35px rgba(22,163,74,0.4);
  transform: translateY(-1px);
}

.badge { 
  padding: 6px 12px; 
  border-radius: 20px; 
  font-size:12px; 
  font-weight:600;
}
.badge-pending { 
  background: linear-gradient(135deg, #fef3c7, #fde68a); 
  color: #92400e; 
}
.badge-paid { 
  background: linear-gradient(135deg, #dcfce7, #bbf7d0); 
  color: #166534; 
}
.badge-used { 
  background: linear-gradient(135deg, #f1f5f9, #e2e8f0); 
  color: #475569; 
}
.badge-failed { 
  background: linear-gradient(135deg, #fee2e2, #fecaca); 
  color: #b91c1c; 
}

.history-item {
  border-bottom: 1px solid #f1f5f9;
  padding: 16px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 14px;
  transition: all 0.2s ease;
}
.history-item:hover {
  background: #f8fafc;
  padding-left: 8px;
  border-radius: 8px;
}
.history-item:last-child {
  border-bottom: none;
}

#voucherBox { display: none; }
#qrContainer { 
  margin-top: 16px; 
  display: flex; 
  justify-content: center; 
  padding: 20px;
  background: #f8fafc;
  border-radius: 16px;
}

#voucherDetails {
  font-size: 15px; 
  margin-bottom: 20px; 
  padding: 24px; 
  background: linear-gradient(135deg, #ecfdf5, #d1fae5); 
  border-radius: 20px; 
  border-left: 5px solid #22c55e;
  text-align: center;
}

.page-section { display: none; }
.page-section.active { display: block; }

.dash-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.dash-card {
  background: linear-gradient(135deg, #eef2ff, #e0e7ff);
  border: none;
  padding: 20px;
  border-radius: 16px;
  text-align: center;
  transition: all 0.2s ease;
}
.dash-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 30px rgba(99,102,241,0.2);
}

/* Status messages */
.status-msg {
  font-size: 13px;
  margin-top: 12px;
  text-align: center;
  font-weight: 500;
  padding: 12px;
  border-radius: 12px;
}
.status-success { background: #ecfdf5; color: #166534; border: 1px solid #bbf7d0; }
.status-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
.status-info  { background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }

/* Profile cards */
.profile-grid {
  display: grid;
  gap: 16px;
  margin-bottom: 28px;
}
.profile-card {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 20px;
  background: #f8fafc;
  border-radius: 16px;
}

/* Mobile optimizations */
@media (min-width: 480px) {
  .vehicle-grid {
    grid-template-columns: 1fr 1fr;
  }
  .container {
    max-width: 420px;
    padding: 28px 24px 32px;
  }
}

@media (max-width: 360px) {
  body { padding: 8px; }
  .container { padding: 20px 16px 24px; }
  .card { padding: 20px 16px; }
}
</style>
</head>
<body>
<div class="app-shell">

<!-- Backdrop -->
<div id="backdrop" class="backdrop sidebar-hidden" onclick="closeSidebar()"></div>

<!-- Sidebar -->
<aside class="sidebar sidebar-hidden" id="sidebar">
  <div class="sidebar-header">
    <h2>üìä Analytics</h2>
    <small id="sidebarUser">Not logged in</small>
  </div>
  <ul class="sidebar-menu">
    <li><a href="#" onclick="openSection('create');closeSidebar();return false;" id="homeLink">üè† Home</a></li>
    <li><a href="#" onclick="openSection('dashboard');closeSidebar();return false;" id="dashLink">üìà Dashboard</a></li>
    <li><a href="#" onclick="openSection('vehicles');closeSidebar();return false;" id="vehLink">üöó Vehicles</a></li>
    <li><a href="#" onclick="openSection('bunks');closeSidebar();return false;" id="bunkLink">‚õΩ Bunks</a></li>
    <li><a href="#" onclick="openSection('profile');closeSidebar();return false;" id="profLink">üë§ Profile</a></li>
  </ul>
  <div class="sidebar-footer">
    <button onclick="logout()">üö™ Logout</button>
  </div>
</aside>

<!-- Main Container -->
<div class="container">
  <div class="header">
    <h1>üöó FuelSkip</h1>
    <div class="header-right">
      <div class="user-pill" id="userDisplay"></div>
      <button class="hamburger" onclick="toggleSidebar()" title="Menu">‚ò∞</button>
    </div>
  </div>

  <!-- LOGIN + CREATE VOUCHER (DEFAULT) -->
  <div id="create" class="page-section active">
    <!-- Login -->
    <div class="card" id="loginBox">
      <h3 style="margin:0 0 24px 0; font-size:22px; color:#1e293b;">üëã Get Started</h3>
      <div class="form-group">
        <span class="label">üì± Phone number <span style="color:#ef4444;">*</span></span>
        <input id="phone" type="tel" placeholder="98XXXXXXXX" maxlength="10" required>
      </div>
      <div class="form-group">
        <span class="label">üë§ Full Name <span style="color:#ef4444;">*</span></span>
        <input id="name" placeholder="Enter your full name" required>
      </div>
      <div class="form-group">
        <span class="label">üìß Email (optional)</span>
        <input id="email" type="email" placeholder="you@gmail.com">
      </div>
      <button class="btn-primary" onclick="login()">
        üöÄ Continue
      </button>
      <div id="loginMsg" class="status-msg" style="display:none;"></div>
    </div>

    <!-- Create voucher -->
    <div class="card" id="createBox" style="display:none;">
      <h3 style="margin:0 0 24px 0; font-size:22px;">‚ûï Create Voucher</h3>
      
      <div class="vehicle-section">
        <strong style="font-size:14px; font-weight:700;">Vehicle</strong>
        <div class="vehicle-grid">
          <div class="form-group">
            <span class="label">Type</span>
            <select id="vehicleType">
              <option value="Bike">üèçÔ∏è Bike</option>
              <option value="Car" selected>üöó Car</option>
              <option value="Auto">üõ∫ Auto</option>
              <option value="Truck">üöõ Truck</option>
              <option value="Other">üöô Other</option>
            </select>
          </div>
          <div class="form-group">
            <span class="label">Number</span>
            <input id="vehicleNo" type="text" placeholder="AP05AB1234" maxlength="12">
          </div>
        </div>
      </div>

      <div class="form-group">
        <span class="label">‚õΩ Fuel Station</span>
        <select id="bunkSelect">
          <option value="BUNK-1">BPCL Siripuram</option>
          <option value="BUNK-2">Gajuwaka Expressway</option>
        </select>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
        <div class="form-group">
          <span class="label">üí∞ Amount (‚Çπ)</span>
          <input id="amount" type="number" min="50" max="5000" placeholder="500">
        </div>
        <div class="form-group">
          <span class="label">‚õΩ OR Litres</span>
          <input id="litres" type="number" min="5" max="500" step="0.1" placeholder="25">
        </div>
      </div>

      <button class="btn-primary" onclick="createVoucher()">
        ‚ú® Generate Voucher
      </button>
      <div id="createMsg" class="status-msg" style="display:none;"></div>
    </div>

    <!-- Voucher -->
    <div class="card" id="voucherBox" style="display:none;">
      <h3 style="margin:0 0 24px 0; font-size:22px;">‚úÖ Voucher Ready!</h3>
      <div id="voucherDetails"></div>
      <button class="btn-primary" id="payBtn" onclick="payNow()">
        üí≥ Pay Now
      </button>
      <div id="qrSection" style="display:none;">
        <p style="font-size:14px; text-align:center; margin-bottom:16px; color:#374151;">Show QR to attendant</p>
        <div id="qrContainer"></div>
        <div style="text-align:center; margin-top:20px; padding:16px; background:#f8fafc; border-radius:12px;">
          <strong>Voucher ID:</strong><br>
          <span id="voucherIdDisplay" style="font-family:monospace; font-size:18px; color:#6366f1;"></span>
        </div>
      </div>
    </div>

    <!-- History -->
    <div class="card" id="historyBox" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="margin:0; font-size:22px;">üìã My Vouchers</h3>
        <button class="btn-primary" style="width:auto; padding:10px 16px; font-size:14px;" onclick="loadMyVouchers()">
          ‚ü≤ Refresh
        </button>
      </div>
      <div id="myVouchers" style="font-size:14px; color:#64748b;">Loading...</div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="page-section">
    <h3 style="font-size:26px; margin:0 0 28px 0;">üìä Analytics</h3>
    <div class="dash-grid">
      <div class="dash-card">
        <div style="font-size:11px; text-transform:uppercase; color:#64748b;">Total Spend</div>
        <div style="font-size:24px; font-weight:800; color:#1e293b;" id="dashTotalSpend">‚Çπ0</div>
        <div style="font-size:12px; color:#6366f1;">Lifetime</div>
      </div>
      <div class="dash-card" style="background:linear-gradient(135deg,#e0f2fe,#bfdbfe);">
        <div style="font-size:11px; text-transform:uppercase; color:#64748b;">Total Fills</div>
        <div style="font-size:24px; font-weight:800; color:#1e293b;" id="dashTotalFills">0</div>
        <div style="font-size:12px; color:#0ea5e9;">Transactions</div>
      </div>
      <div class="dash-card" style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);">
        <div style="font-size:11px; text-transform:uppercase; color:#64748b;">Avg Fill</div>
        <div style="font-size:24px; font-weight:800; color:#1e293b;" id="dashAvgFill">‚Çπ0</div>
        <div style="font-size:12px; color:#22c55e;">Per Fill</div>
      </div>
    </div>
    <div class="card">
      <p style="font-size:14px; margin:0; color:#64748b;">
        üöó Top vehicle: <strong id="dashTopVehicle" style="color:#1e293b;">-</strong>
      </p>
    </div>
  </div>

  <!-- Vehicles -->
  <div id="vehicles" class="page-section">
    <h3 style="font-size:26px; margin:0 0 28px 0;">üöó Vehicles</h3>
    <div id="vehicleList" class="card" style="padding:32px; text-align:center; color:#64748b;">
      No data available
    </div>
  </div>

  <!-- Bunks -->
  <div id="bunks" class="page-section">
    <h3 style="font-size:26px; margin:0 0 28px 0;">‚õΩ Stations</h3>
    <div id="bunkList" class="card" style="padding:32px; text-align:center; color:#64748b;">
      No data available
    </div>
  </div>

  <!-- Profile -->
  <div id="profile" class="page-section">
    <h3 style="font-size:26px; margin:0 0 28px 0;">üë§ Profile</h3>
    <div id="profileInfo" class="card" style="padding:32px; text-align:center; color:#64748b;">
      Loading...
    </div>
  </div>
</div>

<script>
const API = "https://fuelskip-production.up.railway.app";

let lastVoucherId = null;
let razorpayOrderId = null;
let razorpayKeyId = null;
let pollTimer = null;
let currentVehicle = null;
let isFirstLogin = false;

function getUserId(){ return localStorage.getItem("fuelskip_user_id"); }
function setUserId(id){ localStorage.setItem("fuelskip_user_id", id); }
function setUserName(n){ localStorage.setItem("fuelskip_user_name", n || ""); }
function setUserPhone(p){ localStorage.setItem("fuelskip_user_phone", p || ""); }
function setUserEmail(e){ localStorage.setItem("fuelskip_user_email", e || ""); }
function getUserEmail(){ return localStorage.getItem("fuelskip_user_email") || ""; }

function getAnalyticsKey(){
  const uid = getUserId();
  return uid ? `fuelskip_analytics_${uid}` : null;
}

function clearFreshUserData(){
  const uid = getUserId();
  if(uid){
    localStorage.removeItem(`fuelskip_vehicle_history_${uid}`);
    localStorage.removeItem(`fuelskip_analytics_${uid}`);
    isFirstLogin = true;
  }
}

function showStatus(elementId, message, type = 'info') {
  const el = document.getElementById(elementId);
  el.textContent = message;
  el.className = `status-msg status-${type}`;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 5000);
}

function bunkName(id){
  const names = {
    "BUNK-1": "BPCL Siripuram",
    "BUNK-2": "Gajuwaka Expressway"
  };
  return names[id] || id || "Unknown";
}

function toggleSidebar(){
  const sidebar = document.getElementById("sidebar");
  const backdrop = document.getElementById("backdrop");
  if(sidebar.classList.contains("sidebar-hidden")){
    sidebar.classList.remove("sidebar-hidden");
    backdrop.classList.remove("sidebar-hidden");
    requestAnimationFrame(() => {
      sidebar.classList.add("open");
      backdrop.classList.add("show");
    });
  } else {
    closeSidebar();
  }
}

function closeSidebar(){
  const sidebar = document.getElementById("sidebar");
  const backdrop = document.getElementById("backdrop");
  sidebar.classList.remove("open");
  backdrop.classList.remove("show");
  setTimeout(() => {
    sidebar.classList.add("sidebar-hidden");
    backdrop.classList.add("sidebar-hidden");
  }, 300);
}

function refreshUserDisplay(){
  const n = localStorage.getItem("fuelskip_user_name") || "";
  const p = localStorage.getItem("fuelskip_user_phone") || "";
  const displayText = p ? (n ? `${n.slice(0,15)}${n.length>15?'...':''}` : p.slice(-10)) : "";
  document.getElementById("userDisplay").textContent = displayText;
  document.getElementById("sidebarUser").textContent = p ? (n ? `${n} ‚Ä¢ ${p}` : p) : "Not logged in";
}

function updateActiveMenu(section){
  document.querySelectorAll('.sidebar-menu a').forEach(link => link.classList.remove('active'));
  const activeLink = {
    'create': 'homeLink',
    'dashboard': 'dashLink',
    'vehicles': 'vehLink',
    'bunks': 'bunkLink',
    'profile': 'profLink'
  }[section];
  if(activeLink) document.getElementById(activeLink).classList.add('active');
}

function openSection(id){
  document.querySelectorAll(".page-section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  updateActiveMenu(id);
  if(id === "profile") loadProfile();
  else if(id !== "create") loadAnalytics();
}

function logout(){
  if(!confirm("Logout? All local data will be cleared.")) return;
  
  localStorage.removeItem("fuelskip_user_id");
  localStorage.removeItem("fuelskip_user_name");
  localStorage.removeItem("fuelskip_user_phone");
  localStorage.removeItem("fuelskip_user_email");
  
  Object.keys(localStorage).forEach(key => {
    if(key.includes('fuelskip_')) localStorage.removeItem(key);
  });

  document.getElementById("phone").value   = "";
  document.getElementById("name").value    = "";
  document.getElementById("email").value   = "";
  document.getElementById("amount").value  = "";
  document.getElementById("litres").value  = "";
  document.getElementById("vehicleNo").value = "";

  document.getElementById("loginBox").style.display   = "block";
  document.getElementById("createBox").style.display  = "none";
  document.getElementById("voucherBox").style.display = "none";
  document.getElementById("historyBox").style.display = "none";

  const sidebar  = document.getElementById("sidebar");
  const backdrop = document.getElementById("backdrop");
  sidebar.classList.add("sidebar-hidden");
  backdrop.classList.add("sidebar-hidden");

  openSection("create");
  refreshUserDisplay();
  if(pollTimer) clearInterval(pollTimer);
}

async function login(){
  const phone = document.getElementById("phone").value.trim().replace(/\D/g,'');
  const name  = document.getElementById("name").value.trim();
  const email = document.getElementById("email").value.trim() || null;

  if(!phone || phone.length !== 10){ 
    showStatus("loginMsg", "Enter valid 10-digit phone number", "error");
    document.getElementById("phone").focus();
    return; 
  }
  if(!name || name.length < 2){ 
    showStatus("loginMsg", "Enter your full name (min 2 chars)", "error");
    document.getElementById("name").focus();
    return; 
  }

  showStatus("loginMsg", "üîÑ Logging in...", "info");

  try{
    const res = await fetch(`${API}/login`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({phone, name, email})
    });
    
    if(!res.ok){
      const err = await res.json();
      throw new Error(err.detail || `HTTP ${res.status}`);
    }
    
    const data = await res.json();
    
    setUserId(data.user_id);
    setUserName(name);
    setUserPhone(phone);
    setUserEmail(email || "");

    clearFreshUserData();

    document.getElementById("loginBox").style.display   = "none";
    document.getElementById("createBox").style.display  = "block";
    document.getElementById("historyBox").style.display = "block";

    const sidebar  = document.getElementById("sidebar");
    const backdrop = document.getElementById("backdrop");
    sidebar.classList.remove("sidebar-hidden");
    backdrop.classList.add("sidebar-hidden");

    refreshUserDisplay();
    loadMyVouchers();
    showStatus("loginMsg", `‚úÖ Welcome ${name}!`, "success");
    
  } catch(e){
    showStatus("loginMsg", `‚ùå ${e.message}`, "error");
  }
}

function saveVehicleToAnalytics(vehicle){
  const key = getAnalyticsKey();
  if(!key) return;
  
  try {
    let analytics = JSON.parse(localStorage.getItem(key) || "[]");
    analytics.unshift(vehicle);
    analytics = analytics.slice(0, 100);
    localStorage.setItem(key, JSON.stringify(analytics));
  } catch(e) {
    console.error("Save analytics error:", e);
  }
}

async function createVoucher(){
  const amountVal   = document.getElementById("amount").value;
  const litresVal   = document.getElementById("litres").value;
  const vehicleType = document.getElementById("vehicleType").value;
  const vehicleNo   = document.getElementById("vehicleNo").value.trim().toUpperCase();
  const bunkId      = document.getElementById("bunkSelect").value;
  const userId      = getUserId();

  if(!amountVal && !litresVal){ 
    showStatus("createMsg", "Enter amount OR litres", "error");
    return; 
  }
  if(!vehicleNo || vehicleNo.length < 3){ 
    showStatus("createMsg", "Enter valid vehicle number", "error");
    return; 
  }

  showStatus("createMsg", "‚ú® Creating voucher...", "info");

  try{
    const res = await fetch(`${API}/create-voucher`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        bunk_id: bunkId,
        amount: amountVal ? Number(amountVal) : null,
        litres: litresVal ? Number(litresVal) : null,
        user_id: userId ? Number(userId) : null,
        vehicle_type: vehicleType,
        vehicle_no: vehicleNo
      })
    });
    
    if(!res.ok){
      const err = await res.json();
      throw new Error(err.detail || `HTTP ${res.status}`);
    }
    
    const data = await res.json();
    lastVoucherId   = data.voucher_id;
    razorpayOrderId = data.razorpay_order_id;
    razorpayKeyId   = data.razorpay_key_id;
    
    currentVehicle = {
      vehicleType, vehicleNo, 
      amount: data.amount, 
      litres: data.litres, 
      bunk_id: bunkId, 
      voucher_id: data.voucher_id,
      created_at: new Date().toISOString()
    };

    saveVehicleToAnalytics(currentVehicle);

    document.getElementById("voucherDetails").innerHTML = `
      <div style="font-size:18px; font-weight:800; color:#166534; margin-bottom:12px;">
        ${data.voucher_id}
      </div>
      <div style="display:grid; gap:8px; font-size:15px; color:#374151;">
        <div>üí∞ ‚Çπ<strong>${data.amount?.toLocaleString() || 'TBD'}</strong></div>
        <div>‚õΩ <strong>${data.litres || 'TBD'} L</strong></div>
        <div style="font-size:13px; color:#64748b;">
          ${vehicleType} ${vehicleNo} ‚Ä¢ ${bunkName(bunkId)}
        </div>
      </div>
    `;
    
    document.getElementById("voucherIdDisplay").textContent = data.voucher_id;
    document.getElementById("voucherBox").style.display = "block";
    document.getElementById("qrSection").style.display  = "none";

    // RESET PAY BUTTON FOR NEW VOUCHER
    const payBtn = document.getElementById("payBtn");
    payBtn.disabled = false;
    payBtn.style.display = "block";
    payBtn.innerHTML = "üí≥ Pay Now";
    
    showStatus("createMsg", "‚úÖ Voucher created! Tap Pay Now", "success");
    
  } catch(e){
    showStatus("createMsg", `‚ùå ${e.message}`, "error");
  }
}

function payNow(){
  if(!razorpayOrderId || !razorpayKeyId){ 
    alert("Create voucher first");
    return; 
  }
  
  const options = {
    key:        razorpayKeyId,
    order_id:   razorpayOrderId,
    name:       "FuelSkip",
    description:`Voucher ${lastVoucherId}`,
    currency:   "INR",
    theme:      { color: "#22c55e" },
    redirect:   false,
    handler:    function(response){ startPollingStatus(); },
    modal:      { ondismiss: function(){} }
  };
  
  const rzp = new Razorpay(options);
  rzp.open();
}

function startPollingStatus(){
  if(!lastVoucherId) return;
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(checkVoucherStatus, 2500);
  const btn = document.getElementById("payBtn");
  btn.innerHTML = "‚è≥ Processing...";
  btn.disabled = true;
}

async function checkVoucherStatus(){
  if(!lastVoucherId) return;
  try{
    const res = await fetch(`${API}/voucher-status/${lastVoucherId}`);
    if(!res.ok) return;
    const data = await res.json();
    if(data.status === "paid"){
      clearInterval(pollTimer);
      showQr();
      loadMyVouchers();
      loadAnalytics();

      // HIDE PAY BUTTON AFTER SUCCESS
      const btn = document.getElementById("payBtn");
      btn.style.display = "none";
    }
  } catch(e){
    console.log("Poll error:", e);
  }
}

function showQr(){
  document.getElementById("qrSection").style.display = "block";
  document.getElementById("qrContainer").innerHTML  = "";
  const url = `https://fuelskip-production.up.railway.app/attendant.html?voucher=${encodeURIComponent(lastVoucherId)}`;
  new QRCode(document.getElementById("qrContainer"), {
    text:  url,
    width: 200,
    height:200,
    colorDark:  "#1e293b",
    colorLight: "#f8fafc"
  });
}

function statusBadge(status){
  status = (status || "").toLowerCase();
  const badges = {
    "paid":   '<span class="badge badge-paid">‚úÖ Paid</span>',
    "used":   '<span class="badge badge-used">‚úîÔ∏è Used</span>',
    "failed": '<span class="badge badge-failed">‚ùå Failed</span>'
  };
  return badges[status] || '<span class="badge badge-pending">‚è≥ Pending</span>';
}

async function loadMyVouchers(){
  const userId   = getUserId();
  const container = document.getElementById("myVouchers");
  if(!userId){ 
    container.innerHTML = 'Login required';
    return; 
  }
  
  try{
    const res = await fetch(`${API}/my-vouchers?user_id=${encodeURIComponent(userId)}`);
    if(!res.ok){ 
      container.innerHTML = 'Loading failed';
      return; 
    }
    const vouchers = await res.json();
    if(!vouchers.length){ 
      container.innerHTML = 'No vouchers yet';
      return; 
    }
    container.innerHTML = vouchers.map(v => `
      <div class="history-item">
        <div>
          <div style="font-weight:700; font-size:15px;">${v.id} ‚Ä¢ ‚Çπ${parseFloat(v.amount||0).toLocaleString()}</div>
          <div style="font-size:13px; color:#64748b;">${new Date(v.created_at).toLocaleString()}</div>
        </div>
        <div>${statusBadge(v.status)}</div>
      </div>
    `).join("");
  } catch(e){
    container.innerHTML = 'Error loading';
  }
}

function loadAnalytics(){
  const key = getAnalyticsKey();
  if(!key) return;
  
  try {
    const analytics = JSON.parse(localStorage.getItem(key) || "[]");
    if(!analytics.length) return;

    const total = analytics.reduce((s, f) => s + parseFloat(f.amount || 0), 0);
    document.getElementById("dashTotalSpend").textContent = `‚Çπ${total.toLocaleString()}`;
    document.getElementById("dashTotalFills").textContent = analytics.length;
    document.getElementById("dashAvgFill").textContent   = `‚Çπ${Math.round(total / analytics.length)}`;

    const vehicleStats = {};
    analytics.forEach(f => {
      const vKey = `${f.vehicleType} ${f.vehicleNo}`;
      vehicleStats[vKey] = (vehicleStats[vKey] || 0) + parseFloat(f.amount || 0);
    });

    const topVehicle = Object.entries(vehicleStats).sort(([,a],[,b]) => b-a)[0];
    document.getElementById("dashTopVehicle").textContent = topVehicle ? topVehicle[0] : "-";

    if(document.getElementById("vehicles").classList.contains("active")){
      const vehicleList = document.getElementById("vehicleList");
      vehicleList.innerHTML = Object.entries(vehicleStats).length ? 
        Object.entries(vehicleStats).map(([name, amt]) => 
          `<div class="history-item"><div>${name}</div><div>‚Çπ${amt.toLocaleString()}</div></div>`
        ).join("") : 
        '<div style="padding:24px; text-align:center; color:#64748b;">No vehicles tracked</div>';
    }

  } catch(e) {
    console.error("Analytics error:", e);
  }
}

function loadProfile(){
  const container = document.getElementById("profileInfo");
  const uid   = getUserId();
  const name  = localStorage.getItem("fuelskip_user_name")  || "";
  const phone = localStorage.getItem("fuelskip_user_phone") || "";
  const email = getUserEmail();

  if(!uid){
    container.innerHTML = 'Login required';
    return;
  }

  container.innerHTML = `
    <div class="profile-grid">
      <div class="profile-card">
        <div style="font-size:13px; color:#64748b;">Name</div>
        <div style="font-size:18px; font-weight:700;">${name}</div>
      </div>
      <div class="profile-card">
        <div style="font-size:13px; color:#64748b;">Phone</div>
        <div style="font-size:18px; font-weight:700;">${phone}</div>
      </div>
      <div class="profile-card">
        <div style="font-size:13px; color:#64748b;">Email</div>
        <div style="font-size:18px; font-weight:700;">${email || 'Not set'}</div>
      </div>
    </div>
    <button class="btn-primary" onclick="openProfileEdit()">‚úèÔ∏è Edit Profile</button>
  `;
}

function openProfileEdit(){
  const nameOld  = localStorage.getItem("fuelskip_user_name")  || "";
  const phoneOld = localStorage.getItem("fuelskip_user_phone") || "";
  const emailOld = getUserEmail();

  const name  = prompt("Name:",  nameOld);
  if(!name || name.length < 2) return;
  
  const phone = prompt("Phone:", phoneOld);
  if(!phone || phone.replace(/\D/g,'').length !== 10) return;
  
  const email = prompt("Email:", emailOld) || "";
  
  setUserName(name.trim());
  setUserPhone(phone.replace(/\D/g,''));
  setUserEmail(email.trim());
  
  refreshUserDisplay();
  loadProfile();
}

window.addEventListener("load", () => {
  const sidebar  = document.getElementById("sidebar");
  const backdrop = document.getElementById("backdrop");

  if(getUserId()){
    sidebar.classList.remove("sidebar-hidden");
    backdrop.classList.add("sidebar-hidden");
    document.getElementById("loginBox").style.display  = "none";
    document.getElementById("createBox").style.display = "block";
    document.getElementById("historyBox").style.display= "block";
    refreshUserDisplay();
    loadMyVouchers();
    loadAnalytics();
  } else {
    sidebar.classList.add("sidebar-hidden");
    backdrop.classList.add("sidebar-hidden");
  }
  
  document.addEventListener('touchstart', function(event) {
    if (event.touches.length > 1) event.preventDefault();
  }, { passive: false });
  
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function(event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) event.preventDefault();
    lastTouchEnd = now;
  }, false);
});
</script>
</body>
</html>
