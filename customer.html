<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FuelSkip ‚Äì Customer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#00baf2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="FuelSkip">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link rel="icon" type="image/png" href="/icon-192.png" />

  <!-- QR render -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Razorpay -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    :root{
      --primary:#00baf2;
      --primary2:#009ad0;
      --bg:#f6f8fc;
      --panel:#ffffff;
      --panel2:#f1f5f9;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;
      --success:#16a34a;
      --danger:#ef4444;
      --warn:#f59e0b;
      --gray:#e2e8f0;
    }
    *{ box-sizing:border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      color:var(--text) !important;
      background: var(--bg) !important;
      overflow-x:hidden;
    }
    .app{ display:flex; min-height:100vh; }
    .sidebar{
      width:260px;
      background:var(--panel) !important;
      border-right:1px solid var(--border);
      padding:18px 14px;
      position:sticky;
      top:0;
      height:100vh;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:1000; font-size:18px;
      margin-bottom:14px;
      color: var(--text);
    }
    .brand .mark{
      width:28px; height:28px; border-radius:10px;
      background: rgba(0,186,242,0.12);
      border: 1px solid rgba(0,186,242,0.25);
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
    }
    .brand span{ color:var(--primary2); }
    .userbox{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      margin-bottom:12px;
    }
    .userbox .name{ font-weight:1000; }
    .userbox .phone{ font-size:12px; color:var(--muted); font-weight:800; margin-top:2px; }
    .userbox .bal{ margin-top:10px; display:flex; justify-content:space-between; align-items:center; }
    .userbox .bal .amt{ font-weight:1000; color:var(--success); }

    .nav{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .nav button{
      width:100%;
      background:var(--panel);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
      text-align:left;
    }
    .nav button.active{
      outline:2px solid rgba(0,186,242,0.35);
      background: rgba(0,186,242,0.10);
      border-color: rgba(0,186,242,0.25);
    }
    .logoutBtn{
      margin-top:14px;
      width:100%;
      background:rgba(239,68,68,0.12);
      color:#b91c1c;
      border:1px solid rgba(239,68,68,0.30);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:1000;
    }

    .main{ flex:1; padding:18px; display:flex; justify-content:center; }
    .container{ width:100%; max-width:900px; }

    .card{
      background:var(--panel) !important;
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
      margin-bottom:14px;
      max-width:100%;
    }
    .cardTitle{ font-weight:1000; font-size:18px; margin-bottom:6px; }
    .muted{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.45; }

    label{
      display:block;
      margin-top:10px;
      margin-bottom:6px;
      font-size:12px;
      color:#0284c7;
      font-weight:1000;
    }
    input, select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff !important;
      color:var(--text) !important;
      outline:none;
      font-weight:850;
      max-width:100%;
    }
    input:focus, select:focus{
      border-color: rgba(0,186,242,0.65);
      box-shadow: 0 0 0 4px rgba(0,186,242,0.14);
    }

    .row{ display:flex; gap:12px; }
    .row > div{ flex:1; min-width:0; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--panel2);
      cursor:pointer;
      font-weight:1000;
      user-select:none;
      white-space:nowrap;
      color: var(--text);
    }
    .chip:hover{
      border-color: rgba(0,186,242,0.45);
      background: rgba(0,186,242,0.10);
    }

    .btn{
      border:none;
      border-radius:14px;
      padding:10px 12px;
      font-weight:1000;
      cursor:pointer;
    }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }

    .btnPrimary{ background:var(--primary); color:#001018; }
    .btnPrimary:hover{ background:var(--primary2); }

    .btnGray{
      background: var(--gray);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btnDark{
      background: #111827;
      color: #fff;
    }
    .btnOutline{
      background: transparent;
      border:1px solid rgba(0,186,242,0.55);
      color: var(--text);
    }

    .toggle{ display:flex; gap:10px; margin-top:10px; }
    .toggle .btn{ flex:1; }
    .activePay{
      outline:2px solid rgba(0,186,242,0.35);
      background: rgba(0,186,242,0.10);
    }

    .statusLine{ margin-top:10px; font-weight:950; font-size:13px; }
    .ok{ color:var(--success); }
    .warn{ color:var(--danger); }
    .info{ color:#0284c7; }

    #qrWrap{ display:none; }
    #qrBox{
      background:#fff;
      border-radius:16px;
      padding:12px;
      display:flex;
      justify-content:center;
      margin-top:10px;
      overflow:hidden;
      max-width:100%;
      border:1px solid var(--border);
    }
    code{ color:#0284c7; word-break:break-all; }

    .list{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .item{
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      max-width:100%;
    }
    .item .t{ font-weight:1000; }
    .item .s{ font-size:12px; color:var(--muted); font-weight:850; margin-top:4px; }
    .item .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .pill{ font-size:11px; font-weight:1000; padding:4px 10px; border-radius:999px; }
    .pillPaid{ background: rgba(22,163,74,0.15); color: var(--success); border:1px solid rgba(22,163,74,0.25); }
    .pillUsed{ background: rgba(100,116,139,0.18); color:#334155; border:1px solid rgba(100,116,139,0.25); }
    .pillPending{ background: rgba(245,158,11,0.18); color:#92400e; border:1px solid rgba(245,158,11,0.25); }
    .pillFailed{ background: rgba(239,68,68,0.15); color:#b91c1c; border:1px solid rgba(239,68,68,0.25); }

    .topbar{
      display:none;
      padding:14px 16px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      position:sticky;
      top:0;
      z-index:10;
    }
    .topbar .row1{ display:flex; justify-content:space-between; align-items:center; }
    .hamburger{
      background: var(--panel2);
      border:1px solid var(--border);
      color: var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:1000;
    }
    .sidebar.mobileHidden{ display:none; }

    @media (max-width: 820px){
      .topbar{ display:block; }
      .sidebar{ position: fixed; z-index: 20; left:0; top:0; height:100vh; }
      .main{ padding:10px; }
      .container{ max-width:100%; }
      .card{ padding:14px; border-radius:14px; }
      .row{ flex-direction:column; }
      input, select, button { font-size:15px; }
      #qr canvas{ width:180px !important; height:180px !important; }
      #pageAnalytics > div[style*="grid-template-columns"]{ grid-template-columns: 1fr !important; }
    }

    /* Splash */
    #splash{
      position: fixed;
      inset: 0;
      background: #f6f8fc;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 350ms ease, transform 350ms ease;
    }
    #splash.hide{
      opacity: 0;
      transform: scale(1.02);
      pointer-events: none;
    }
    .splashCard{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius: 22px;
      padding: 28px 34px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.12);
      text-align:center;
      min-width: 260px;
    }
    .splashLogoWrap{
      width: 72px; height: 72px;
      border-radius: 22px;
      margin: 0 auto 12px auto;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,186,242,0.12);
      border:1px solid rgba(0,186,242,0.25);
    }
    .drop{
      width: 30px; height: 40px;
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-radius: 18px 18px 20px 20px;
      position: relative;
      box-shadow: 0 10px 20px rgba(0,186,242,0.22);
    }
    .drop:before{
      content:"";
      position:absolute;
      top:-12px; left:50%;
      width: 22px; height: 22px;
      transform: translateX(-50%) rotate(45deg);
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-radius: 6px;
    }
    .splashText{ font-weight: 1000; font-size: 22px; color: #0f172a; }
    .splashSub{ margin-top: 6px; font-size: 12px; color: #64748b; font-weight: 800; }
  </style>
</head>

<body>
  <div id="splash">
    <div class="splashCard">
      <div class="splashLogoWrap"><div class="drop"></div></div>
      <div class="splashText">FuelSkip</div>
      <div class="splashSub">Fast fuel. No queue.</div>
    </div>
  </div>

  <div class="topbar">
    <div class="row1">
      <div style="font-weight:1000;">FuelSkip</div>
      <button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar mobileHidden" id="sidebar">
      <div class="brand">
        <div class="mark">‚õΩ</div>
        <span>FuelSkip</span>
      </div>

      <div class="userbox">
        <div class="name" id="sbName">Not logged in</div>
        <div class="phone" id="sbPhone"></div>
        <div class="bal">
          <div class="phone">Wallet</div>
          <div class="amt" id="sbBal">‚Çπ0</div>
        </div>
      </div>

      <div class="nav">
        <button id="navDash" class="active" onclick="go('dashboard')">üè† Dashboard</button>
        <button id="navVouchers" onclick="go('vouchers')">üéüÔ∏è Vouchers</button>
        <button id="navVehicles" onclick="go('vehicles')">üöó Vehicles</button>
        <button id="navStations" onclick="go('stations')">‚õΩ Stations</button>
      </div>

      <button class="logoutBtn" onclick="logout()">Logout</button>

      <div class="muted" style="margin-top:12px;">
        Tip: Android Chrome ‚Üí ‚ãÆ ‚Üí ‚ÄúAdd to Home screen‚Äù.
      </div>
    </aside>

    <main class="main">
      <div class="container">

        <!-- LOGIN -->
        <div class="card" id="pageLogin">
          <div class="cardTitle">Login</div>
          <div class="muted">MVP: no OTP. Wallet is linked to phone.</div>

          <label>Phone</label>
          <input id="phone" placeholder="10-digit phone" inputmode="numeric" />

          <label>Name (optional)</label>
          <input id="name" placeholder="Your name" />

          <button class="btn btnPrimary" style="width:100%;margin-top:12px;" onclick="login()">Login</button>
          <div class="statusLine" id="loginStatus"></div>
        </div>

        <!-- DASHBOARD -->
        <div id="pageDashboard" style="display:none;">
          <div class="card">
            <div class="cardTitle">Wallet</div>
            <div class="muted">Load once during non-peak time. At bunk, voucher becomes instant.</div>

            <div class="row" style="margin-top:10px;">
              <div>
                <div class="muted">Balance</div>
                <div style="font-weight:1000;font-size:22px;color:var(--success);" id="balText">‚Çπ0</div>
              </div>
              <div style="display:flex;justify-content:flex-end;align-items:flex-start;">
                <button class="btn btnGray" onclick="refreshAll()">Refresh</button>
              </div>
            </div>

            <label>Top-up amount</label>
            <div class="chips">
              <div class="chip" onclick="setTopup(200)">‚Çπ200</div>
              <div class="chip" onclick="setTopup(500)">‚Çπ500</div>
              <div class="chip" onclick="setTopup(1000)">‚Çπ1000</div>
              <div class="chip" onclick="setTopup(2000)">‚Çπ2000</div>
            </div>
            <input id="topupAmount" placeholder="Custom amount (min ‚Çπ50)" inputmode="decimal" />
            <button class="btn btnPrimary" style="width:100%;margin-top:12px;" onclick="topupWallet()">Add Money</button>
            <div class="statusLine" id="topupStatus"></div>
          </div>

          <div class="card" id="createCard">
            <div class="cardTitle">Create Voucher</div>
            <div class="muted">Prefer Wallet for fastest bunk experience.</div>

            <label>Station</label>
            <select id="bunk"></select>

            <label>Fuel Type</label>
            <select id="fuelType">
              <option value="PETROL">Petrol</option>
              <option value="DIESEL">Diesel</option>
              <option value="CNG">CNG</option>
              <option value="EV">EV (future)</option>
            </select>

            <div class="row">
              <div>
                <label>Amount (‚Çπ)</label>
                <input id="amount" placeholder="e.g. 300" inputmode="decimal" />
              </div>
              <div>
                <label>Litres (L)</label>
                <input id="litres" placeholder="e.g. 3" inputmode="decimal" />
              </div>
            </div>

            <div class="chips">
              <div class="chip" onclick="quickAmount(200)">‚Çπ200</div>
              <div class="chip" onclick="quickAmount(300)">‚Çπ300</div>
              <div class="chip" onclick="quickAmount(500)">‚Çπ500</div>
              <div class="chip" onclick="quickAmount(1000)">‚Çπ1000</div>
            </div>

            <div class="row">
              <div>
                <label>Vehicle Type</label>
                <select id="vehicleType">
                  <option value="">-</option>
                  <option value="Bike">Bike</option>
                  <option value="Car">Car</option>
                  <option value="Auto">Auto</option>
                  <option value="Truck">Truck</option>
                </select>
              </div>
              <div>
                <label>Vehicle No</label>
                <input id="vehicleNo" placeholder="AP.. / TS.." />
              </div>
            </div>

            <div class="muted" id="defaultVehicleHint" style="margin-top:8px;"></div>

            <label>Payment method</label>
            <div class="toggle">
              <button id="btnWallet" class="btn btnPrimary activePay" onclick="setPay('wallet')">Wallet (Fast)</button>
              <button id="btnRzp" class="btn btnOutline" onclick="setPay('razorpay')">Razorpay</button>
            </div>

            <button class="btn btnPrimary" style="width:100%;margin-top:12px;" id="createBtn" onclick="createVoucher()">Generate Voucher</button>
            <div class="statusLine" id="statusLine"></div>

            <div id="qrWrap">
              <div class="cardTitle" style="margin-top:14px;">Your Voucher QR</div>
              <div class="muted">Show this to attendant (they scan inside their page).</div>

              <div id="qrBox"><div id="qr"></div></div>

              <div class="muted" style="margin-top:10px;">
                Station: <b id="qrStationName"></b><br/>
                Fuel: <b id="qrFuelType">‚Äî</b><br/>
                Voucher: <code id="vId"></code><br/>
                Signature: <code id="vSig"></code><br/>
                Link: <code id="vLink"></code>
              </div>

              <div class="row" style="margin-top:10px;">
                <div><button class="btn btnGray" style="width:100%;" onclick="hideQR()">Create another</button></div>
                <div><button class="btn btnGray" style="width:100%;" onclick="copyLink()">Copy link</button></div>
              </div>
            </div>
          </div>
        </div>

        <!-- VOUCHERS -->
        <div class="card" id="pageVouchers" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <div class="cardTitle">My Vouchers</div>
            <button class="btn btnGray" onclick="loadVouchers()">Refresh</button>
          </div>
          <div class="muted">Old voucher QR can be opened anytime (server regenerates signature).</div>
          <div class="list" id="voucherList"></div>
        </div>

        <!-- VEHICLES -->
        <div class="card" id="pageVehicles" style="display:none;">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
            <div>
              <div class="cardTitle">üöó Vehicles</div>
              <div class="muted">Saved on server (works across devices).</div>
            </div>
            <button class="btn btnGray" onclick="renderVehicles()">Refresh</button>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="muted">Add vehicle</div>
            <div class="row" style="margin-top:10px;">
              <div>
                <label>Vehicle Type</label>
                <select id="vehAddType">
                  <option value="Bike">Bike</option>
                  <option value="Car">Car</option>
                  <option value="Auto">Auto</option>
                  <option value="Truck">Truck</option>
                </select>
              </div>
              <div>
                <label>Vehicle No</label>
                <input id="vehAddNo" placeholder="AP09AB1234" />
              </div>
            </div>
            <button class="btn btnPrimary" style="width:100%;margin-top:12px;" onclick="addVehicle()">Save Vehicle</button>
            <div class="statusLine" id="vehStatus"></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <div class="muted">My vehicles</div>
            <div class="list" id="vehList"></div>
          </div>
        </div>

        <!-- STATIONS -->
        <div class="card" id="pageStations" style="display:none;">
          <div class="cardTitle">Stations</div>
          <div class="muted">Select a station to set as default for voucher creation.</div>
          <div class="list" id="stationList"></div>
        </div>

      </div>
    </main>
  </div>

  <script>
    const API = window.location.origin;

    const BUNK_META = {
      "BUNK-1": { name: "BPCL Siripuram", address: "Siripuram, Visakhapatnam" },
      "BUNK-2": { name: "Gajuwaka Expressway", address: "Gajuwaka, Visakhapatnam" }
    };

    function bunkName(id){ return (BUNK_META[id] && BUNK_META[id].name) ? BUNK_META[id].name : id; }
    function bunkAddress(id){ return (BUNK_META[id] && BUNK_META[id].address) ? BUNK_META[id].address : ""; }

    // Session only (server stores the real data)
    let state = {
      user_id: null, phone: "", name: "",
      wallet_balance: 0,
      pay_method: "wallet",
      last_bunk: "BUNK-1",
      last_amount: 300,
      last_vehicle_type: "",
      last_vehicle_no: "",
      default_vehicle_id: "",
      last_fuel_type: "PETROL",
      vehicles: [] // loaded from server
    };

    function saveSession(){
      localStorage.setItem("FUELSKIP_SESSION", JSON.stringify({
        user_id: state.user_id,
        phone: state.phone
      }));
    }
    function loadSession(){
      const raw = localStorage.getItem("FUELSKIP_SESSION");
      if(!raw) return;
      try{
        const s = JSON.parse(raw);
        if(s && s.user_id){ state.user_id = s.user_id; state.phone = s.phone || ""; }
      }catch{}
    }
    function clearSession(){
      localStorage.removeItem("FUELSKIP_SESSION");
    }

    function fmtINR(x){
      const n = Number(x || 0);
      return "‚Çπ" + n.toLocaleString("en-IN", { maximumFractionDigits: 2 });
    }
    function inr0(x){
      const n = Number(x || 0);
      return "‚Çπ" + n.toLocaleString("en-IN", { maximumFractionDigits: 0 });
    }
    function normalizeVehNo(x){
      return String(x||"").toUpperCase().replace(/\s+/g,"").trim();
    }
    function vehicleLabel(v){ return `${v.type} ‚Ä¢ ${v.no}`; }

    function toggleSidebar(){
      document.getElementById("sidebar").classList.toggle("mobileHidden");
    }

    function setSidebarUser(){
      document.getElementById("sbName").textContent = state.name || "User";
      document.getElementById("sbPhone").textContent = state.phone || "";
      document.getElementById("sbBal").textContent = fmtINR(state.wallet_balance);
      const bt = document.getElementById("balText");
      if(bt) bt.textContent = fmtINR(state.wallet_balance);
    }

    function setPay(m){
      state.pay_method = m;
      document.getElementById("btnWallet").classList.toggle("activePay", m === "wallet");
      document.getElementById("btnRzp").classList.toggle("activePay", m === "razorpay");
    }

    function setTopup(v){ document.getElementById("topupAmount").value = String(v); }
    function quickAmount(v){ document.getElementById("amount").value = String(v); document.getElementById("litres").value = ""; }

    function populateBunkDropdown(){
      const sel = document.getElementById("bunk");
      sel.innerHTML = "";
      Object.keys(BUNK_META).forEach(id => {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = `${bunkName(id)} ‚Ä¢ (${id})`;
        sel.appendChild(opt);
      });
    }

    function applyDefaultVehicleToFormIfEmpty(){
      const defId = state.default_vehicle_id;
      const def = (state.vehicles || []).find(v => v.id === defId);

      const vt = document.getElementById("vehicleType");
      const vn = document.getElementById("vehicleNo");
      const hint = document.getElementById("defaultVehicleHint");

      if(def){
        hint.innerHTML = `Default vehicle: <b>${vehicleLabel(def)}</b> (auto-filled if empty)`;
        if(!vt.value) vt.value = def.type;
        if(!vn.value) vn.value = def.no;
      } else {
        hint.textContent = "";
      }
    }

    function applyDefaults(){
      populateBunkDropdown();
      document.getElementById("bunk").value = state.last_bunk || "BUNK-1";
      document.getElementById("amount").value = state.last_amount ? String(state.last_amount) : "";
      document.getElementById("litres").value = "";
      document.getElementById("vehicleType").value = state.last_vehicle_type || "";
      document.getElementById("vehicleNo").value = state.last_vehicle_no || "";

      const ftSel = document.getElementById("fuelType");
      if(ftSel) ftSel.value = (state.last_fuel_type || "PETROL").toUpperCase();

      setPay(state.pay_method || "wallet");
      applyDefaultVehicleToFormIfEmpty();
    }

    function showPage(p){
      ["pageLogin","pageDashboard","pageVouchers","pageVehicles","pageStations"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.style.display = "none";
      });
      if(p==="login") document.getElementById("pageLogin").style.display = "";
      if(p==="dashboard") document.getElementById("pageDashboard").style.display = "";
      if(p==="vouchers") document.getElementById("pageVouchers").style.display = "";
      if(p==="vehicles") document.getElementById("pageVehicles").style.display = "";
      if(p==="stations") document.getElementById("pageStations").style.display = "";
    }

    function setNavActive(id){
      ["navDash","navVouchers","navVehicles","navStations"].forEach(x => document.getElementById(x).classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function go(where){
      if(window.innerWidth <= 820){
        document.getElementById("sidebar").classList.add("mobileHidden");
      }
      if(where==="dashboard"){ setNavActive("navDash"); showPage("dashboard"); applyDefaultVehicleToFormIfEmpty(); }
      if(where==="vouchers"){ setNavActive("navVouchers"); showPage("vouchers"); loadVouchers(); }
      if(where==="vehicles"){ setNavActive("navVehicles"); showPage("vehicles"); renderVehicles(); }
      if(where==="stations"){ setNavActive("navStations"); showPage("stations"); loadStations(); }
    }

    async function login(){
      const phone = (document.getElementById("phone").value || "").trim();
      const name = (document.getElementById("name").value || "").trim();
      const st = document.getElementById("loginStatus");
      st.textContent = "";

      if(!phone || phone.length < 8){
        st.innerHTML = `<span class="warn">‚ùå</span> Enter phone`;
        return;
      }

      st.innerHTML = `<span class="info">‚è≥</span> Logging in‚Ä¶`;
      try{
        const res = await fetch(`${API}/login`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ phone, name })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Login failed");

        state.user_id = data.user_id;
        state.phone = data.phone;
        state.name = data.name || name || "";
        state.wallet_balance = Number(data.wallet_balance || 0);

        state.default_vehicle_id = data.default_vehicle_id || "";
        state.last_bunk = data.last_bunk || "BUNK-1";
        state.last_amount = Number(data.last_amount || 300);
        state.last_vehicle_type = data.last_vehicle_type || "";
        state.last_vehicle_no = data.last_vehicle_no || "";
        state.last_fuel_type = (data.last_fuel_type || "PETROL").toUpperCase();

        saveSession();

        await loadVehiclesFromServer();
        bootAfterLogin();
      }catch(e){
        st.innerHTML = `<span class="warn">‚ùå</span> ${e.message}`;
        alert(e.message);
      }
    }

    function logout(){
      clearSession();
      location.reload();
    }

    async function userUpdateDefaults(partial){
      if(!state.user_id) return;
      try{
        await fetch(`${API}/user/update`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ user_id: state.user_id, ...partial })
        });
      }catch{}
    }

    async function loadVehiclesFromServer(){
      if(!state.user_id) return;
      const res = await fetch(`${API}/user/vehicles?user_id=${encodeURIComponent(state.user_id)}`, { cache:"no-store" });
      const data = await res.json();
      if(res.ok){
        state.default_vehicle_id = data.default_vehicle_id || state.default_vehicle_id || "";
        state.vehicles = Array.isArray(data.vehicles) ? data.vehicles.map(v=>({ id:v.id, type:v.type, no:v.no, is_default:!!v.is_default })) : [];
      }
    }

    async function refreshBalance(){
      if(!state.user_id) return;
      const res = await fetch(`${API}/wallet/balance?user_id=${encodeURIComponent(state.user_id)}`, { cache:"no-store" });
      const data = await res.json();
      if(res.ok){
        state.wallet_balance = Number(data.wallet_balance || 0);
        setSidebarUser();
      }
    }

    async function refreshAll(){
      await refreshBalance();
      await loadVehiclesFromServer();
      applyDefaults();
      await loadVouchers(false);
    }

    async function topupWallet(){
      const status = document.getElementById("topupStatus");
      status.textContent = "";
      if(!state.user_id){ alert("Login first"); return; }

      const amt = Number((document.getElementById("topupAmount").value || "").trim());
      if(!amt || amt < 50){
        status.innerHTML = `<span class="warn">‚ùå</span> Minimum topup is ‚Çπ50`;
        return;
      }

      status.innerHTML = `<span class="info">‚è≥</span> Creating order‚Ä¶`;
      try{
        const res = await fetch(`${API}/wallet/topup/create-order`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ user_id: state.user_id, amount: amt })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Topup create failed");

        status.innerHTML = `<span class="info">‚è≥</span> Opening payment‚Ä¶`;

        const options = {
          key: data.razorpay_key_id,
          amount: Math.round(amt * 100),
          currency: "INR",
          name: "FuelSkip Wallet",
          description: "Wallet Top-up",
          order_id: data.razorpay_order_id,
          handler: async function(){
            status.innerHTML = `<span class="ok">‚úÖ</span> Paid. Updating balance‚Ä¶`;
            await pollBalanceIncrease(amt);
          }
        };
        new Razorpay(options).open();

      }catch(e){
        status.innerHTML = `<span class="warn">‚ùå</span> ${e.message}`;
        alert(e.message);
      }
    }

    async function pollBalanceIncrease(expectedDelta){
      const start = Number(state.wallet_balance || 0);
      const target = start + Number(expectedDelta || 0) * 0.3;
      for(let i=0;i<10;i++){
        await new Promise(r=>setTimeout(r,2000));
        await refreshBalance();
        if(Number(state.wallet_balance || 0) > target) return;
      }
      alert("If balance not updated yet, press Refresh (webhook may be delayed).");
    }

    function statusPill(v){
      const st = String(v.status || "").toLowerCase();
      const used = !!v.used || st === "used";
      if(used) return `<span class="pill pillUsed">USED</span>`;
      if(st === "paid") return `<span class="pill pillPaid">PAID</span>`;
      if(st === "failed") return `<span class="pill pillFailed">FAILED</span>`;
      return `<span class="pill pillPending">${(v.status || "PENDING").toUpperCase()}</span>`;
    }

    function niceFuel(ft){
      const x = String(ft || "PETROL").toUpperCase();
      if(x === "DIESEL") return "Diesel";
      if(x === "CNG") return "CNG";
      if(x === "EV") return "EV";
      return "Petrol";
    }

    async function loadVouchers(showPageAfter=true){
      if(!state.user_id) return;
      const box = document.getElementById("voucherList");
      if(showPageAfter) showPage("vouchers");
      box.innerHTML = `<div class="muted">Loading‚Ä¶</div>`;

      try{
        const res = await fetch(`${API}/my-vouchers?user_id=${encodeURIComponent(state.user_id)}`, { cache:"no-store" });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Failed to load vouchers");

        const list = (data || []).slice(0, 25);
        if(!list.length){
          box.innerHTML = `<div class="muted">No vouchers yet.</div>`;
          return;
        }

        box.innerHTML = "";
        list.forEach(v=>{
          const amount = Number(v.amount || 0);
          const fuel = niceFuel(v.fuel_type);
          const el = document.createElement("div");
          el.className = "item";
          el.innerHTML = `
            <div>
              <div class="t">‚Çπ${amount.toFixed(0)} ‚Ä¢ ${fuel} ‚Ä¢ ${bunkName(v.bunk_id || "-")} (${v.bunk_id || "-"})</div>
              <div class="s">${statusPill(v)} &nbsp; ${v.id}</div>
            </div>
            <div class="right">
              <button class="btn btnGray" onclick="prefillFromVoucher('${v.bunk_id || "BUNK-1"}', ${Math.round(amount)}, '${String(v.fuel_type || "PETROL").toUpperCase()}')">Repeat</button>
              <button class="btn btnPrimary" onclick="showOldVoucherQR('${v.id}')">Show QR</button>
            </div>
          `;
          box.appendChild(el);
        });

      }catch(e){
        box.innerHTML = `<div class="muted"><span class="warn">‚ùå</span> ${e.message}</div>`;
        alert(e.message);
      }
    }

    function prefillFromVoucher(bunk, amount, fuel_type){
      state.last_bunk = bunk || "BUNK-1";
      state.last_amount = Number(amount || 0);
      state.last_fuel_type = (fuel_type || "PETROL").toUpperCase();
      userUpdateDefaults({ last_bunk: state.last_bunk, last_amount: state.last_amount, last_fuel_type: state.last_fuel_type });
      go("dashboard");
      applyDefaults();
      setPay("wallet");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function showOldVoucherQR(voucherId){
      try{
        const res = await fetch(`${API}/voucher-qr/${encodeURIComponent(voucherId)}?user_id=${encodeURIComponent(state.user_id)}`, { cache:"no-store" });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Unable to fetch QR");
        showVoucherQR(voucherId, data.sig, data.bunk_id, data.fuel_type);
        go("dashboard");
        setTimeout(() => document.getElementById("qrWrap")?.scrollIntoView({ behavior:"smooth", block:"start" }), 500);
      }catch(e){
        alert(e.message);
      }
    }

    async function loadStations(){
      const list = document.getElementById("stationList");
      list.innerHTML = "";
      Object.keys(BUNK_META).forEach(id=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <div class="t">${bunkName(id)}</div>
            <div class="s">${id} ‚Ä¢ ${bunkAddress(id)}</div>
          </div>
          <div class="right">
            <button class="btn btnPrimary" onclick="pickStation('${id}')">Select</button>
          </div>
        `;
        list.appendChild(el);
      });
    }

    function pickStation(id){
      state.last_bunk = id;
      userUpdateDefaults({ last_bunk: id });
      applyDefaults();
      go("dashboard");
    }

    function hideQR(){
      document.getElementById("qrWrap").style.display = "none";
      document.getElementById("qr").innerHTML = "";
      document.getElementById("statusLine").innerHTML = "";
    }

    function copyLink(){
      const link = document.getElementById("vLink").textContent || "";
      if(!link) return;
      navigator.clipboard.writeText(link).then(()=>alert("Link copied"));
    }

    function showVoucherQR(voucherId, sig, stationId, fuelType){
      const link = `${window.location.origin}/attendant.html?voucher=${encodeURIComponent(voucherId)}&sig=${encodeURIComponent(sig)}`;
      document.getElementById("vId").textContent = voucherId;
      document.getElementById("vSig").textContent = sig;
      document.getElementById("vLink").textContent = link;
      document.getElementById("qrStationName").textContent = bunkName(stationId || "BUNK-1");
      document.getElementById("qrFuelType").textContent = niceFuel(fuelType || "PETROL");

      const qrEl = document.getElementById("qr");
      qrEl.innerHTML = "";
      new QRCode(qrEl, { text: link, width: 220, height: 220 });
      document.getElementById("qrWrap").style.display = "block";
    }

    async function createVoucher(){
      const status = document.getElementById("statusLine");
      const btn = document.getElementById("createBtn");
      status.textContent = "";
      if(!state.user_id){ alert("Login first"); return; }

      const bunk_id = document.getElementById("bunk").value;
      const fuel_type = (document.getElementById("fuelType").value || "PETROL").toUpperCase();
      const amountStr = (document.getElementById("amount").value || "").trim();
      const litresStr = (document.getElementById("litres").value || "").trim();
      const vehicle_type = document.getElementById("vehicleType").value || "";
      const vehicle_no = normalizeVehNo(document.getElementById("vehicleNo").value || "");

      const payload = {
        bunk_id,
        user_id: state.user_id,
        vehicle_type: vehicle_type || null,
        vehicle_no: vehicle_no || null,
        pay_method: state.pay_method || "wallet",
        fuel_type
      };
      if(amountStr) payload.amount = Number(amountStr);
      if(litresStr) payload.litres = Number(litresStr);

      if(!payload.amount && !payload.litres){
        status.innerHTML = `<span class="warn">‚ùå</span> Enter amount or litres`;
        return;
      }

      if(payload.pay_method === "wallet" && payload.amount && Number(payload.amount) > Number(state.wallet_balance || 0)){
        status.innerHTML = `<span class="warn">‚ùå</span> Insufficient wallet balance`;
        return;
      }

      // Save defaults server-side
      state.last_bunk = bunk_id;
      state.last_fuel_type = fuel_type;
      if(payload.amount) state.last_amount = Number(payload.amount);
      state.last_vehicle_type = vehicle_type || state.last_vehicle_type;
      state.last_vehicle_no = vehicle_no || state.last_vehicle_no;
      userUpdateDefaults({
        last_bunk: state.last_bunk,
        last_amount: state.last_amount,
        last_vehicle_type: state.last_vehicle_type,
        last_vehicle_no: state.last_vehicle_no,
        last_fuel_type: state.last_fuel_type
      });

      btn.disabled = true;
      status.innerHTML = `<span class="info">‚è≥</span> Creating voucher‚Ä¶`;

      try{
        const res = await fetch(`${API}/create-voucher`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Create failed");

        if((data.pay_method || "").toLowerCase() === "wallet"){
          if(typeof data.wallet_balance !== "undefined"){
            state.wallet_balance = Number(data.wallet_balance || state.wallet_balance);
            setSidebarUser();
          }
          status.innerHTML = `<span class="ok">‚úÖ</span> Voucher ready (wallet). Showing QR‚Ä¶`;
          showVoucherQR(data.voucher_id, data.qr_sig, bunk_id, fuel_type);
          btn.disabled = false;
          return;
        }

        status.innerHTML = `<span class="info">‚è≥</span> Opening payment‚Ä¶`;
        const options = {
          key: data.razorpay_key_id,
          amount: Math.round(Number(data.amount) * 100),
          currency: "INR",
          name: "FuelSkip",
          description: "Fuel Voucher",
          order_id: data.razorpay_order_id,
          handler: async function(){
            status.innerHTML = `<span class="ok">‚úÖ</span> Paid. Waiting confirmation‚Ä¶`;
            const ok = await pollVoucherPaid(data.voucher_id);
            if(ok){
              status.innerHTML = `<span class="ok">‚úÖ</span> Voucher confirmed. Showing QR‚Ä¶`;
              showVoucherQR(data.voucher_id, data.qr_sig, bunk_id, fuel_type);
            } else {
              status.innerHTML = `<span class="warn">‚è≥</span> Confirmation delayed. Refresh later.`;
            }
            btn.disabled = false;
          },
          modal:{ ondismiss: function(){ status.innerHTML = `<span class="warn">‚ö†Ô∏è</span> Payment closed.`; btn.disabled = false; } }
        };
        new Razorpay(options).open();

      }catch(e){
        status.innerHTML = `<span class="warn">‚ùå</span> ${e.message}`;
        alert(e.message);
        btn.disabled = false;
      }
    }

    async function pollVoucherPaid(voucher_id){
      for(let i=0;i<12;i++){
        await new Promise(r=>setTimeout(r,2500));
        const res = await fetch(`${API}/voucher-status/${encodeURIComponent(voucher_id)}`, { cache:"no-store" });
        const data = await res.json();
        const st = String(data.status || "").toLowerCase();
        const used = !!data.used || st === "used";
        if(res.ok && (st === "paid" || used)) return true;
      }
      return false;
    }

    async function addVehicle(){
      const st = document.getElementById("vehStatus");
      st.textContent = "";

      const type = document.getElementById("vehAddType").value;
      const no = normalizeVehNo(document.getElementById("vehAddNo").value);

      if(!no || no.length < 6){
        st.innerHTML = `<span class="warn">‚ùå</span> Enter a valid vehicle number`;
        return;
      }

      try{
        const res = await fetch(`${API}/user/vehicles/add`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ user_id: state.user_id, vehicle_type: type, vehicle_no: no })
        });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Failed to save vehicle");

        st.innerHTML = `<span class="ok">‚úÖ</span> Saved`;
        document.getElementById("vehAddNo").value = "";
        await loadVehiclesFromServer();
        applyDefaultVehicleToFormIfEmpty();
        renderVehicles();
      }catch(e){
        st.innerHTML = `<span class="warn">‚ùå</span> ${e.message}`;
      }
    }

    async function setDefaultVehicle(id){
      try{
        const res = await fetch(`${API}/user/vehicles/default?user_id=${encodeURIComponent(state.user_id)}&vehicle_id=${encodeURIComponent(id)}`, { method:"POST" });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Failed");
        await loadVehiclesFromServer();
        state.default_vehicle_id = id;
        userUpdateDefaults({ default_vehicle_id: id });
        renderVehicles();
        applyDefaultVehicleToFormIfEmpty();
      }catch(e){
        alert(e.message);
      }
    }

    async function deleteVehicle(id){
      try{
        const res = await fetch(`${API}/user/vehicles/delete?user_id=${encodeURIComponent(state.user_id)}&vehicle_id=${encodeURIComponent(id)}`, { method:"DELETE" });
        const data = await res.json();
        if(!res.ok) throw new Error(data.detail || "Failed");
        await loadVehiclesFromServer();
        renderVehicles();
        applyDefaultVehicleToFormIfEmpty();
      }catch(e){
        alert(e.message);
      }
    }

    function useVehicle(id){
      const v = (state.vehicles || []).find(x=>x.id===id);
      if(!v) return;
      state.last_vehicle_type = v.type;
      state.last_vehicle_no = v.no;
      userUpdateDefaults({ last_vehicle_type: v.type, last_vehicle_no: v.no, default_vehicle_id: state.default_vehicle_id });
      go("dashboard");
      applyDefaults();
      setTimeout(()=> window.scrollTo({ top: 0, behavior: "smooth" }), 150);
    }

    function renderVehicles(){
      const box = document.getElementById("vehList");
      const list = state.vehicles || [];
      if(!list.length){
        box.innerHTML = `<div class="muted">No vehicles saved yet.</div>`;
        return;
      }
      box.innerHTML = "";
      list.forEach(v=>{
        const isDef = (v.id === state.default_vehicle_id);
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div>
            <div class="t">${vehicleLabel(v)} ${isDef ? '<span class="pill pillPaid">DEFAULT</span>' : ''}</div>
            <div class="s">Use ‚Üí fills voucher form</div>
          </div>
          <div class="right">
            <button class="btn btnGray" onclick="useVehicle('${v.id}')">Use</button>
            <button class="btn btnPrimary" onclick="setDefaultVehicle('${v.id}')">Default</button>
            <button class="btn btnGray" onclick="deleteVehicle('${v.id}')">Delete</button>
          </div>
        `;
        box.appendChild(el);
      });
    }

    function bootAfterLogin(){
      document.getElementById("pageLogin").style.display = "none";
      document.getElementById("sidebar").classList.remove("mobileHidden");
      setSidebarUser();
      applyDefaults();
      go("dashboard");
      loadStations();
      loadVouchers(false);
    }

    // Splash
    window.addEventListener("load", () => {
      setTimeout(() => {
        const s = document.getElementById("splash");
        if(!s) return;
        s.classList.add("hide");
        setTimeout(()=> s.remove(), 450);
      }, 900);
    });

    // Boot
    loadSession();
    if(state.user_id){
      // silent restore: fetch real profile by logging in with stored phone? (MVP)
      // simplest: show login screen if session exists but no phone -> ask login
      if(!state.phone){
        showPage("login");
        document.getElementById("sidebar").classList.add("mobileHidden");
      } else {
        // auto-login by calling /login again (idempotent)
        (async ()=>{
          try{
            const res = await fetch(`${API}/login`, {
              method:"POST",
              headers: {"Content-Type":"application/json"},
              body: JSON.stringify({ phone: state.phone, name: "" })
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.detail || "Login failed");

            state.user_id = data.user_id;
            state.phone = data.phone;
            state.name = data.name || "";
            state.wallet_balance = Number(data.wallet_balance || 0);

            state.default_vehicle_id = data.default_vehicle_id || "";
            state.last_bunk = data.last_bunk || "BUNK-1";
            state.last_amount = Number(data.last_amount || 300);
            state.last_vehicle_type = data.last_vehicle_type || "";
            state.last_vehicle_no = data.last_vehicle_no || "";
            state.last_fuel_type = (data.last_fuel_type || "PETROL").toUpperCase();

            saveSession();
            await loadVehiclesFromServer();
            bootAfterLogin();
          }catch{
            showPage("login");
            document.getElementById("sidebar").classList.add("mobileHidden");
          }
        })();
      }
    } else {
      showPage("login");
      document.getElementById("sidebar").classList.add("mobileHidden");
    }

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/service-worker.js");
    }
  </script>
</body>
</html>
