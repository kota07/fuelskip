<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Razorpay Checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <title>FuelSkip - Customer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 16px; }
    input, button, select { padding: 8px; margin: 4px 0; width: 100%; }
    .box { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin-top: 12px;}
    .btn-primary {
      padding: 10px 14px;
      background: #16a34a;
      color: white;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      display: inline-block;
    }
    #pay-btn {
      display:none;
    }
  </style>
</head>
<body>
<h2>â›½ FuelSkip - Customer</h2>

<!-- Simple login -->
<div class="box" id="loginBox">
  <h3>Login</h3>
  <label>Phone</label>
  <input id="phoneInput" placeholder="Enter phone">
  <label>Name (optional)</label>
  <input id="nameInput" placeholder="Enter name">
  <button onclick="login()">Login</button>
  <p id="loginStatus" style="font-size: 12px; color: #555;"></p>
</div>

<div class="box" id="userInfoBox" style="display:none;">
  <p id="userInfoText"></p>
  <button onclick="logout()" style="background:#ef4444;color:white;border:none;border-radius:6px;padding:6px 10px;width:auto;">
    Logout
  </button>
</div>

<div class="box">
  <button onclick="loadBunks()">Load Nearby Bunks</button>
  <div id="bunks"></div>
</div>

<div class="box" id="amountBox" style="display:none;">
  <h3 id="selectedBunkName"></h3>
  <label>Enter amount (â‚¹):</label>
  <input id="amountInput" type="number" placeholder="500">
  <div style="text-align:center;margin:8px 0;">or</div>
  <label>Enter litres:</label>
  <input id="litresInput" type="number" placeholder="5">
  <button onclick="createVoucher()">Create Voucher</button>
</div>

<div class="box" id="voucherBox" style="display:none;">
  <h3>Voucher Created</h3>
  <p id="voucherInfo"></p>

  <p><strong>Payment:</strong></p>

  <!-- MAIN Pay now button (Razorpay) -->
  <button id="pay-btn" class="btn-primary" onclick="payNow()">Pay now</button>
  <br><br>

  <!-- Optional manual button (for now you can still keep it) -->
  <!-- <button id="paidButton" onclick="showQr()" style="display:none;">
    I have completed the payment
  </button> -->

  <div id="qrSection" style="display:none;margin-top:16px;">
    <p><strong>Show this QR to attendant:</strong></p>
    <div id="qrContainer"></div>
  </div>
</div>

<!-- History -->
<div class="box" id="historyBox" style="display:none;">
  <h3>My vouchers</h3>
  <button onclick="loadMyVouchers()" style="background:#3b82f6;color:white;border:none;border-radius:6px;padding:6px 12px;font-size:12px;margin-bottom:8px;">
    ðŸ”„ Refresh
  </button>
  <div id="myVouchers"></div>
</div>

<script>
const API = "const API = "https://fuelskip-production.up.railway.app";   // your FastAPI IP

let selectedBunkId = null;
let lastVoucherId = null;
let statusTimer = null;
let razorpayOrderId = null;
let razorpayKeyId   = null;

// --- Login helpers ---
function getUserId() {
  return localStorage.getItem("user_id");
}

function setUser(user_id, phone, name) {
  localStorage.setItem("user_id", String(user_id));
  localStorage.setItem("user_phone", phone || "");
  localStorage.setItem("user_name", name || "");
}

function clearUser() {
  localStorage.removeItem("user_id");
  localStorage.removeItem("user_phone");
  localStorage.removeItem("user_name");
}

function updateLoginUI() {
  const uid = getUserId();
  const loginBox = document.getElementById("loginBox");
  const userInfoBox = document.getElementById("userInfoBox");
  const historyBox = document.getElementById("historyBox");

  if (uid) {
    loginBox.style.display = "none";
    userInfoBox.style.display = "block";
    historyBox.style.display = "block";

    const phone = localStorage.getItem("user_phone") || "";
    const name  = localStorage.getItem("user_name") || "";
    const label = name ? `${name} (${phone})` : phone;

    document.getElementById("userInfoText").innerText =
      "Logged in as: " + label;

    loadMyVouchers();
  } else {
    loginBox.style.display = "block";
    userInfoBox.style.display = "none";
    historyBox.style.display = "none";
    document.getElementById("myVouchers").innerHTML = "";
  }
}

async function login() {
  const phone = document.getElementById("phoneInput").value.trim();
  const name  = document.getElementById("nameInput").value.trim();
  const statusEl = document.getElementById("loginStatus");

  if (!phone) {
    statusEl.innerText = "Enter phone.";
    return;
  }

  statusEl.innerText = "Logging in...";

  try {
    const res = await fetch(`${API}/login`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ phone, name: name || null })
    });
    if (!res.ok) {
      statusEl.innerText = "Login failed.";
      return;
    }
    const data = await res.json();
    setUser(data.user_id, data.phone, data.name);
    statusEl.innerText = "Logged in.";
    updateLoginUI();
  } catch (e) {
    statusEl.innerText = "Error logging in.";
  }
}

function logout() {
  clearUser();
  updateLoginUI();
}

// On load, restore login state
updateLoginUI();

// --- Existing logic with user_id added ---
async function loadBunks() {
  const res = await fetch(`${API}/nearby-bunks?lat=17.6868&lon=83.2185`);
  const data = await res.json();
  const div = document.getElementById('bunks');
  div.innerHTML = '';
  data.forEach(b => {
    const btn = document.createElement('button');
    btn.textContent = `Use ${b.name}`;
    btn.onclick = () => selectBunk(b);
    div.appendChild(btn);
  });
}

function selectBunk(bunk) {
  selectedBunkId = bunk.id;
  document.getElementById('selectedBunkName').innerText = bunk.name;
  document.getElementById('amountBox').style.display = 'block';
}

async function createVoucher() {
  if (!selectedBunkId) return;

  const userId = getUserId();
  if (!userId) {
    alert("Please login first.");
    return;
  }

  const amountVal = document.getElementById('amountInput').value;
  const litresVal = document.getElementById('litresInput').value;

  let body = { bunk_id: selectedBunkId, user_id: Number(userId) };
  if (amountVal) body.amount = parseFloat(amountVal);
  if (!amountVal && litresVal) body.litres = parseFloat(litresVal);

  const res = await fetch(`${API}/create-voucher`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  const data = await res.json();

  lastVoucherId   = data.voucher_id;
  razorpayOrderId = data.razorpay_order_id;
  razorpayKeyId   = data.razorpay_key_id;

  document.getElementById('voucherBox').style.display = 'block';

  const info =
    `Voucher ID: ${data.voucher_id} | ` +
    `Amount: â‚¹${data.amount} | ` +
    `Litres: ${data.litres} | ` +
    `Rate: â‚¹${data.price_per_litre} / L`;

  document.getElementById('voucherInfo').innerText = info;

  // show Pay now button
  document.getElementById('pay-btn').style.display = "inline-block";

  // optional manual button
  document.getElementById('paidButton').style.display = "block";

  document.getElementById('qrSection').style.display = "none";
  document.getElementById('qrContainer').innerHTML = "";

  if (statusTimer) clearInterval(statusTimer);
  statusTimer = setInterval(checkVoucherStatus, 3000);

  // refresh history
  loadMyVouchers();
}

function payNow() {
  if (!razorpayOrderId || !razorpayKeyId) {
    alert("Payment not ready");
    return;
  }

  const options = {
    key: razorpayKeyId,
    order_id: razorpayOrderId,
    name: "FuelSkip",
    description: "Fuel voucher " + lastVoucherId,
    handler: function (response) {
      // Payment success; Razorpay webhook will mark voucher as paid.
      // The polling (checkVoucherStatus) will then show the QR.
      console.log("Payment success:", response);
    }
  };

  const rzp = new Razorpay(options);
  rzp.open();
}


// poll backend to see if voucher is paid
async function checkVoucherStatus() {
  if (!lastVoucherId) return;
  try {
    const res = await fetch(`${API}/voucher-status/${lastVoucherId}`);
    if (!res.ok) return;
    const data = await res.json();
    if (data.status === "paid") {
      clearInterval(statusTimer);
      showQr();
      loadMyVouchers();
    }
  } catch (e) {
    // ignore for prototype
  }
}

// create and show QR that opens attendant.html?voucher=...
function showQr() {
  if (!lastVoucherId) return;

  document.getElementById('qrSection').style.display = "block";
  document.getElementById('qrContainer').innerHTML = "";

  const attendantUrl =
    `https://fuelskip-production.up.railway.app/attendant.html?voucher=${encodeURIComponent(lastVoucherId)}`;

  new QRCode(document.getElementById("qrContainer"), {
    text: attendantUrl,
    width: 200,
    height: 200,
  });
}

// Load voucher history for logged-in user - IMPROVED
async function loadMyVouchers() {
  const uid = getUserId();
  if (!uid) return;

  try {
    const res = await fetch(`${API}/my-vouchers?user_id=${encodeURIComponent(uid)}`);
    if (!res.ok) return;
    const vouchers = await res.json();
    const container = document.getElementById("myVouchers");
    
    if (!vouchers.length) {
      container.innerHTML = "<p style='color:#888;'>No vouchers yet.</p>";
      return;
    }
    
    container.innerHTML = vouchers.map(v => {
      const statusBadge = getStatusBadge(v.status);
      const created = new Date(v.created_at).toLocaleString();
      return `
        <div style="border-bottom:1px solid #eee; padding:12px 0; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <b>${v.id}</b><br>
            <small>â‚¹${v.amount} | ${v.litres}L | ${created}</small>
          </div>
          <div>${statusBadge}</div>
        </div>
      `;
    }).join("");
  } catch (e) {
    console.error("History load error:", e);
  }
}

// Helper for colored status badges
function getStatusBadge(status) {
  const badges = {
    "pending": '<span style="background:orange;color:white;padding:4px 8px;border-radius:12px;font-size:12px;">Pending</span>',
    "paid":    '<span style="background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:12px;">Paid</span>',
    "used":    '<span style="background:#6b7280;color:white;padding:4px 8px;border-radius:12px;font-size:12px;">Used</span>',
    "failed":  '<span style="background:#ef4444;color:white;padding:4px 8px;border-radius:12px;font-size:12px;">Failed</span>'
  };
  return badges[status] || `<span style="background:#d1d5db;color:#374151;padding:4px 8px;border-radius:12px;font-size:12px;">${status}</span>`;
}
</script>
</body>
</html>


