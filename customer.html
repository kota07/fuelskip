<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FuelSkip – Customer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QR display -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Razorpay checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; padding: 16px;
      background: #0f172a; color: #e5e7eb;
      display:flex; justify-content:center;
    }
    .wrap { width:100%; max-width: 420px; }
    h2 { margin: 0 0 14px 0; text-align:center; }
    .card {
      background: #020617;
      border: 1px solid #111827;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.35);
      margin-bottom: 12px;
    }
    label { display:block; font-size: 12px; color:#93a4b8; margin: 10px 0 6px; font-weight:700; }
    input, select {
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #0b1220;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
    }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    button {
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      font-size: 14px;
      margin-top: 10px;
    }
    button:active { transform: scale(0.99); }
    .btn-green { background:#22c55e; color:#06240f; }
    .btn-blue  { background:#3b82f6; color:#061628; }
    .btn-gray  { background:#334155; color:#e5e7eb; }
    .btn-red   { background:#ef4444; color:#2a0b0b; }

    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #0b1220;
      color:#e5e7eb;
      font-weight:800;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover { border-color:#334155; }
    .muted { font-size:12px; color:#94a3b8; margin-top: 6px; line-height:1.4; }

    .balance {
      display:flex; justify-content:space-between; align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      background:#0b1220;
      border:1px solid #1f2937;
      margin-top: 10px;
    }
    .bal-amt { font-size: 18px; font-weight: 900; color:#86efac; }
    .small { font-size:12px; color:#94a3b8; font-weight:700; }

    #qrWrap { display:none; }
    #qrBox {
      background:#ffffff;
      border-radius: 16px;
      padding: 12px;
      display:flex;
      justify-content:center;
      margin-top: 10px;
    }
    code { color:#93c5fd; word-break:break-all; }
    .ok { color:#86efac; font-weight:900; }
    .warn { color:#fca5a5; font-weight:900; }
    .toggle {
      display:flex; gap:10px; margin-top: 10px;
    }
    .toggle button {
      margin-top:0;
      width:50%;
    }
    .activePay {
      outline: 2px solid rgba(34,197,94,0.65);
    }
  </style>
</head>

<body>
<div class="wrap">
  <h2>⛽ FuelSkip – Customer</h2>

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <div class="muted" style="margin-top:0;">
      Login once. Wallet balance will be linked to your phone.
    </div>

    <label>Phone</label>
    <input id="phone" placeholder="10-digit phone" inputmode="numeric"/>

    <label>Name (optional)</label>
    <input id="name" placeholder="Your name"/>

    <button class="btn-blue" onclick="login()">Login</button>

    <div class="muted">
      (MVP note: no OTP. For production later we can add silent verification.)
    </div>
  </div>

  <!-- WALLET -->
  <div class="card" id="walletCard" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div style="font-weight:900;">Wallet</div>
      <button class="btn-gray" style="width:auto;margin-top:0;padding:8px 10px;" onclick="refreshBalance()">Refresh</button>
    </div>

    <div class="balance">
      <div>
        <div class="small">Balance</div>
        <div class="bal-amt" id="balText">₹0</div>
      </div>
      <div class="small" id="userText"></div>
    </div>

    <label>Top-up amount</label>
    <div class="chips">
      <div class="chip" onclick="setTopup(200)">₹200</div>
      <div class="chip" onclick="setTopup(500)">₹500</div>
      <div class="chip" onclick="setTopup(1000)">₹1000</div>
      <div class="chip" onclick="setTopup(2000)">₹2000</div>
    </div>
    <input id="topupAmount" placeholder="Custom amount (min ₹50)" inputmode="decimal"/>

    <button class="btn-green" onclick="topupWallet()">Add Money</button>

    <div class="muted">
      Tip: Load once during non-peak time. At bunk, voucher becomes instant (no payment screen).
    </div>
  </div>

  <!-- CREATE VOUCHER -->
  <div class="card" id="voucherCard" style="display:none;">
    <div style="font-weight:900;">Create Voucher</div>
    <div class="muted">
      Choose amount or litres. Prefer Wallet for fastest bunk experience.
    </div>

    <label>Bunk</label>
    <select id="bunk">
      <option value="BUNK-1">BUNK-1</option>
      <option value="BUNK-2">BUNK-2</option>
    </select>

    <div class="row">
      <div>
        <label>Amount (₹)</label>
        <input id="amount" placeholder="e.g. 300" inputmode="decimal"/>
      </div>
      <div>
        <label>Litres (L)</label>
        <input id="litres" placeholder="e.g. 3" inputmode="decimal"/>
      </div>
    </div>

    <div class="chips">
      <div class="chip" onclick="quickAmount(200)">₹200</div>
      <div class="chip" onclick="quickAmount(300)">₹300</div>
      <div class="chip" onclick="quickAmount(500)">₹500</div>
      <div class="chip" onclick="quickAmount(1000)">₹1000</div>
    </div>

    <div class="row">
      <div>
        <label>Vehicle Type</label>
        <select id="vehicleType">
          <option value="">-</option>
          <option value="Bike">Bike</option>
          <option value="Car">Car</option>
          <option value="Auto">Auto</option>
          <option value="Truck">Truck</option>
        </select>
      </div>
      <div>
        <label>Vehicle No</label>
        <input id="vehicleNo" placeholder="AP.. / TS.." />
      </div>
    </div>

    <label>Payment method</label>
    <div class="toggle">
      <button id="btnWallet" class="btn-green activePay" onclick="setPay('wallet')">Wallet (Fast)</button>
      <button id="btnRzp" class="btn-blue" onclick="setPay('razorpay')">Razorpay</button>
    </div>

    <button class="btn-green" onclick="createVoucher()">Generate Voucher</button>

    <div class="muted" id="statusLine"></div>
  </div>

  <!-- QR OUTPUT -->
  <div class="card" id="qrWrap">
    <div style="font-weight:900;">Your Voucher QR</div>
    <div class="muted">
      Show this to attendant (they will scan inside their page).
    </div>

    <div id="qrBox"><div id="qr"></div></div>

    <div class="muted" style="margin-top:10px;">
      Voucher: <code id="vId"></code><br/>
      Signature: <code id="vSig"></code><br/>
      Link: <code id="vLink"></code>
    </div>

    <button class="btn-gray" onclick="resetVoucherUI()">Create another voucher</button>
  </div>
</div>

<script>
  const API = window.location.origin;

  let state = {
    user_id: null,
    phone: "",
    name: "",
    wallet_balance: 0,
    pay_method: "wallet",
  };

  function loadState() {
    const raw = localStorage.getItem("FUELSKIP_USER");
    if (!raw) return;
    try {
      const s = JSON.parse(raw);
      if (s && s.user_id) state = {...state, ...s};
    } catch {}
  }

  function saveState() {
    localStorage.setItem("FUELSKIP_USER", JSON.stringify({
      user_id: state.user_id,
      phone: state.phone,
      name: state.name,
      wallet_balance: state.wallet_balance,
      pay_method: state.pay_method,
    }));
  }

  function fmtINR(x) {
    const n = Number(x || 0);
    return "₹" + n.toLocaleString("en-IN", {maximumFractionDigits: 2});
  }

  function setPay(m) {
    state.pay_method = m;
    saveState();
    document.getElementById("btnWallet").classList.toggle("activePay", m === "wallet");
    document.getElementById("btnRzp").classList.toggle("activePay", m === "razorpay");
  }

  function setTopup(v) {
    document.getElementById("topupAmount").value = String(v);
  }

  function quickAmount(v) {
    document.getElementById("amount").value = String(v);
    document.getElementById("litres").value = "";
  }

  function show(el, on=true) {
    document.getElementById(el).style.display = on ? "" : "none";
  }

  async function login() {
    const phone = (document.getElementById("phone").value || "").trim();
    const name = (document.getElementById("name").value || "").trim();

    if (!phone || phone.length < 8) return alert("Enter phone");

    const res = await fetch(`${API}/login`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({phone, name})
    });

    const data = await res.json();
    if (!res.ok) return alert(data.detail || "Login failed");

    state.user_id = data.user_id;
    state.phone = data.phone;
    state.name = data.name || "";
    state.wallet_balance = Number(data.wallet_balance || 0);

    saveState();

    initAfterLogin();
  }

  async function refreshBalance() {
    if (!state.user_id) return;
    const res = await fetch(`${API}/wallet/balance?user_id=${encodeURIComponent(state.user_id)}`, {cache:"no-store"});
    const data = await res.json();
    if (res.ok) {
      state.wallet_balance = Number(data.wallet_balance || 0);
      saveState();
      renderWallet();
    }
  }

  function renderWallet() {
    document.getElementById("balText").textContent = fmtINR(state.wallet_balance);
    document.getElementById("userText").innerHTML = `
      <div style="font-weight:900;color:#e5e7eb;">${state.name || "User"}</div>
      <div class="small">${state.phone}</div>
    `;
  }

  function initAfterLogin() {
    show("loginCard", false);
    show("walletCard", true);
    show("voucherCard", true);
    show("qrWrap", false);

    renderWallet();
    setPay(state.pay_method || "wallet");
    refreshBalance();
  }

  async function topupWallet() {
    if (!state.user_id) return alert("Login first");

    const amt = Number((document.getElementById("topupAmount").value || "").trim());
    if (!amt || amt < 50) return alert("Minimum topup is ₹50");

    // Create order
    const res = await fetch(`${API}/wallet/topup/create-order`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({user_id: state.user_id, amount: amt})
    });

    const data = await res.json();
    if (!res.ok) return alert(data.detail || "Topup create failed");

    // Open Razorpay
    const options = {
      key: data.razorpay_key_id,
      amount: Math.round(amt * 100),
      currency: "INR",
      name: "FuelSkip Wallet",
      description: "Wallet Top-up",
      order_id: data.razorpay_order_id,
      handler: async function () {
        // Payment success UI; actual credit comes from webhook.
        alert("✅ Payment done. Updating wallet balance…");
        await pollBalanceIncrease(amt);
      },
      modal: {
        ondismiss: function () {
          // nothing
        }
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  }

  async function pollBalanceIncrease(expectedDelta) {
    // Poll wallet balance for up to ~25 seconds
    const start = Number(state.wallet_balance || 0);
    const target = start + Number(expectedDelta || 0) * 0.3; // don't require full delta; just detect increase
    for (let i=0; i<10; i++) {
      await new Promise(r => setTimeout(r, 2500));
      await refreshBalance();
      if (Number(state.wallet_balance || 0) > target) return;
    }
    // If webhook is delayed, user can press Refresh
    alert("If balance not updated yet, press Refresh (webhook may be delayed).");
  }

  function resetVoucherUI() {
    show("qrWrap", false);
    show("voucherCard", true);
    document.getElementById("statusLine").textContent = "";
    document.getElementById("amount").value = "";
    document.getElementById("litres").value = "";
  }

  async function createVoucher() {
    if (!state.user_id) return alert("Login first");

    const bunk_id = document.getElementById("bunk").value;
    const amountStr = (document.getElementById("amount").value || "").trim();
    const litresStr = (document.getElementById("litres").value || "").trim();

    const vehicle_type = document.getElementById("vehicleType").value || "";
    const vehicle_no = (document.getElementById("vehicleNo").value || "").trim();

    const payload = {
      bunk_id,
      user_id: state.user_id,
      vehicle_type: vehicle_type || null,
      vehicle_no: vehicle_no || null,
      pay_method: state.pay_method || "wallet",
    };

    if (amountStr) payload.amount = Number(amountStr);
    if (litresStr) payload.litres = Number(litresStr);

    if (!payload.amount && !payload.litres) return alert("Enter amount or litres");

    const statusLine = document.getElementById("statusLine");
    statusLine.textContent = "Creating voucher…";

    const res = await fetch(`${API}/create-voucher`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) {
      statusLine.innerHTML = `<span class="warn">❌</span> ${data.detail || "Create failed"}`;
      return;
    }

    // WALLET = instant paid → show QR right away
    if ((data.pay_method || "") === "wallet" || (payload.pay_method === "wallet")) {
      if (typeof data.wallet_balance !== "undefined") {
        state.wallet_balance = Number(data.wallet_balance || state.wallet_balance);
        saveState();
        renderWallet();
      }
      statusLine.innerHTML = `<span class="ok">✅</span> Voucher ready (wallet).`;
      showVoucherQR(data.voucher_id, data.qr_sig);
      return;
    }

    // Razorpay flow: open checkout, then poll voucher-status until paid
    statusLine.textContent = "Opening payment…";

    const options = {
      key: data.razorpay_key_id,
      amount: Math.round(Number(data.amount) * 100),
      currency: "INR",
      name: "FuelSkip",
      description: "Fuel Voucher",
      order_id: data.razorpay_order_id,
      handler: async function () {
        statusLine.innerHTML = `<span class="ok">✅</span> Payment done. Waiting for confirmation…`;
        const ok = await pollVoucherPaid(data.voucher_id);
        if (ok) {
          showVoucherQR(data.voucher_id, data.qr_sig);
        } else {
          statusLine.innerHTML = `<span class="warn">⏳</span> Payment received but confirmation delayed. Try again in a few seconds.`;
        }
      },
      modal: {
        ondismiss: function () {
          statusLine.textContent = "Payment cancelled / closed.";
        }
      }
    };

    const rzp = new Razorpay(options);
    rzp.open();
  }

  async function pollVoucherPaid(voucher_id) {
    for (let i=0; i<12; i++) { // ~30s
      await new Promise(r => setTimeout(r, 2500));
      const res = await fetch(`${API}/voucher-status/${encodeURIComponent(voucher_id)}`, {cache:"no-store"});
      const data = await res.json();
      if (res.ok && (data.status === "paid" || data.status === "used")) return true;
    }
    return false;
  }

  function showVoucherQR(voucherId, sig) {
    show("voucherCard", false);
    show("qrWrap", true);

    const link = `${window.location.origin}/attendant.html?voucher=${encodeURIComponent(voucherId)}&sig=${encodeURIComponent(sig)}`;

    document.getElementById("vId").textContent = voucherId;
    document.getElementById("vSig").textContent = sig;
    document.getElementById("vLink").textContent = link;

    const qrEl = document.getElementById("qr");
    qrEl.innerHTML = "";
    new QRCode(qrEl, { text: link, width: 220, height: 220 });
  }

  // Boot
  loadState();
  if (state.user_id) initAfterLogin();
  else {
    // Prefill phone if user had it
    if (state.phone) document.getElementById("phone").value = state.phone;
    if (state.name) document.getElementById("name").value = state.name;
  }
</script>
</body>
</html>
