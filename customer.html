<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FuelSkip - Customer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    *{box-sizing:border-box}
    :root{
      --bg1:#eef4ff;
      --bg2:#f7fbff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --primary:#4f46e5; /* purple */
      --primary2:#3b82f6; /* blue */
      --good:#16a34a;
      --bad:#dc2626;
      --shadow:0 18px 40px rgba(2,6,23,.10);
      --radius:18px;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background:radial-gradient(1200px 600px at 20% -10%, #dbeafe, transparent 60%),
                 radial-gradient(1200px 600px at 80% 0%, #e9d5ff, transparent 60%),
                 linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }

    /* Splash */
    #splash{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, #eff6ff, #f8fafc);
      z-index:9999;
    }
    .splashCard{
      width:min(420px,92vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
      text-align:center;
    }
    .logoRow{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:10px}
    .logoIcon{
      width:54px;height:54px;border-radius:16px;
      display:grid;place-items:center;
      background:linear-gradient(135deg, #60a5fa, #7c3aed);
      color:#fff;font-weight:900;
      box-shadow:0 14px 24px rgba(79,70,229,.22);
      font-size:26px;
    }
    .logoText{font-size:28px;font-weight:900;letter-spacing:.2px}
    .tagline{color:var(--muted);font-weight:700}

    /* Layout */
    .app{
      display:flex;
      gap:16px;
      padding:16px;
    }
    .sidebar{
      width:280px;
      min-width:280px;
      background:rgba(255,255,255,.75);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
      height: calc(100vh - 32px);
      position:sticky; top:16px;
      overflow:auto;
    }
    .brandBox{
      display:flex; gap:12px; align-items:center;
      padding:10px; border-radius:18px;
      border:1px solid var(--line);
      background:#fff;
      margin-bottom:10px;
    }
    .brandBox .miniIcon{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, #60a5fa, #7c3aed);
      display:grid;place-items:center;color:#fff;font-weight:900;font-size:20px;
    }
    .brandBox .b1{font-weight:900}
    .brandBox .b2{font-size:12px;color:var(--muted);font-weight:700}

    .navBtn{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      margin-top:10px;
    }
    .navBtn.active{border-color:#bfdbfe;background:#eff6ff}
    .navBtn span.sub{font-weight:800;color:#94a3b8}

    .sessionBox{
      margin-top:14px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
    }
    .sessionTitle{
      display:flex;align-items:center;justify-content:space-between;
      font-weight:900;margin-bottom:8px;
    }
    .pill{
      display:inline-block;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      font-weight:900;font-size:12px;background:#f8fafc;color:#334155;
    }
    .btn{
      border:none; border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 12px 22px rgba(2,6,23,.10);
    }
    .btn:active{transform:scale(.98)}
    .btnPrimary{background:var(--primary);color:#fff}
    .btnBlue{background:var(--primary2);color:#fff}
    .btnLight{background:#fff;border:1px solid var(--line);color:var(--text);box-shadow:none}
    .btnRed{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;box-shadow:none}
    .btnWide{width:100%}

    .content{
      flex:1;
      min-width:0;
    }
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:14px;
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 8px;font-size:20px}
    .muted{color:var(--muted);font-weight:700;font-size:13px;line-height:1.35}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .field label{display:block;font-weight:900;margin:8px 0 6px;font-size:13px}
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size:15px;
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chipBtn{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:#fff;font-weight:900;cursor:pointer
    }

    .qrWrap{
      display:grid;grid-template-columns:260px 1fr;gap:14px;align-items:start;
      margin-top:12px;
    }
    .qrBox{
      background:#fff;border:1px solid var(--line);border-radius:18px;padding:10px;
    }
    .qrCanvas{
      width:240px;height:240px;margin:0 auto;background:#fff;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
    }
    .badgeRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{
      display:inline-flex;gap:6px;align-items:center;
      padding:6px 10px;border-radius:999px;font-weight:900;font-size:12px;
      border:1px solid var(--line);background:#f8fafc;color:#334155;
    }
    .badge.good{background:#dcfce7;color:#166534;border-color:#bbf7d0}
    .badge.warn{background:#e0f2fe;color:#075985;border-color:#bae6fd}
    .badge.bad{background:#fee2e2;color:#b91c1c;border-color:#fecaca}

    .kvs{font-size:13px;color:#334155;font-weight:800}
    .kvs b{color:#0f172a}
    .sep{height:1px;background:var(--line);margin:12px 0}

    /* Mobile */
    .topBar{
      display:none;
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.9);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:10px 12px;
    }
    .topBar .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .hamb{border:1px solid var(--line);background:#fff;border-radius:14px;padding:10px 12px;font-weight:900}
    .drawerBack{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:50;
    }
    .drawer{
      width:min(320px,86vw);
      height:100%;
      background:rgba(255,255,255,.92);
      border-right:1px solid var(--line);
      box-shadow:0 18px 50px rgba(2,6,23,.18);
      padding:14px;
    }

    @media (max-width: 980px){
      .sidebar{display:none}
      .topBar{display:block}
      .app{padding:12px}
      .qrWrap{grid-template-columns:1fr}
      .qrCanvas{width:220px;height:220px}
    }
    @media (max-width: 520px){
      .grid2{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr}
    }
  </style>
</head>

<body>

<!-- Splash -->
<div id="splash">
  <div class="splashCard">
    <div class="logoRow">
      <div class="logoIcon">‚õΩ</div>
      <div class="logoText">FuelSkip</div>
    </div>
    <div class="tagline">Fast fuel. No queue.</div>
  </div>
</div>

<!-- Mobile Top Bar -->
<div class="topBar">
  <div class="row">
    <button class="hamb" id="openDrawer">‚ò∞ Menu</button>
    <div style="font-weight:900">FuelSkip</div>
    <button class="hamb" id="refreshBtnTop">‚Üª</button>
  </div>
</div>

<!-- Drawer -->
<div class="drawerBack" id="drawerBack">
  <div class="drawer" id="drawer"></div>
</div>

<div class="app">
  <!-- Desktop Sidebar -->
  <aside class="sidebar" id="sidebar"></aside>

  <!-- Main Content -->
  <main class="content">

    <!-- Login Screen -->
    <div class="card" id="loginCard" style="display:none">
      <h2>Login</h2>
      <div class="muted">MVP: no OTP. We use phone as your ID to load your saved data.</div>

      <div class="grid2" style="margin-top:10px">
        <div class="field">
          <label>Phone</label>
          <input id="loginPhone" placeholder="10-digit phone" inputmode="numeric" />
        </div>
        <div class="field">
          <label>Name (optional)</label>
          <input id="loginName" placeholder="Your name" />
        </div>
      </div>

      <div style="margin-top:12px" class="grid2">
        <button class="btn btnPrimary btnWide" id="doLogin">Login</button>
        <button class="btn btnLight btnWide" id="skipLogin">Continue as Walk-in</button>
      </div>
      <div class="muted" style="margin-top:10px">
        Tip: Add to Home Screen for best scanning + saved session.
      </div>
    </div>

    <!-- App Home -->
    <div class="card" id="homeCard" style="display:none">
      <h2>Create Voucher</h2>
      <div class="muted">Choose bunk + fuel type + amount/litres. Pay by wallet or Razorpay.</div>

      <div class="grid2" style="margin-top:10px">
        <div class="field">
          <label>Fuel Type</label>
          <select id="fuelType">
            <option value="PETROL">PETROL</option>
            <option value="DIESEL">DIESEL</option>
            <option value="GAS">GAS</option>
          </select>
        </div>
        <div class="field">
          <label>Nearby Bunks (or pick)</label>
          <select id="bunkSelect"></select>
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Amount (‚Çπ)</label>
          <input id="amount" placeholder="e.g. 500" inputmode="decimal" />
          <div class="chips">
            <button class="chipBtn" onclick="setAmount(200)">‚Çπ200</button>
            <button class="chipBtn" onclick="setAmount(300)">‚Çπ300</button>
            <button class="chipBtn" onclick="setAmount(500)">‚Çπ500</button>
            <button class="chipBtn" onclick="setAmount(1000)">‚Çπ1000</button>
          </div>
        </div>
        <div class="field">
          <label>Or Litres (L)</label>
          <input id="litres" placeholder="e.g. 5" inputmode="decimal" />
        </div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>Vehicle (optional)</label>
          <select id="vehiclePick"></select>
        </div>
        <div class="field">
          <label>Payment Method</label>
          <select id="payMethod">
            <option value="WALLET">Wallet (fast)</option>
            <option value="RAZORPAY">Razorpay</option>
          </select>
        </div>
      </div>

      <div class="grid3" style="margin-top:12px">
        <button class="btn btnPrimary" id="genVoucherBtn">Generate Voucher</button>
        <button class="btn btnLight" id="nearbyBtn">Find Nearby Bunks</button>
        <button class="btn btnLight" id="scrollQRBtn">Scroll to QR</button>
      </div>
    </div>

    <!-- QR -->
    <div class="card" id="qrCard" style="display:none">
      <h2>Latest Voucher QR</h2>
      <div class="muted">This QR is scanned by attendant for instant dispense.</div>

      <div id="noVoucher" class="muted" style="margin-top:8px">No voucher yet.</div>

      <div id="voucherBox" style="display:none">
        <div class="badgeRow" id="badgeRow"></div>
        <div class="sep"></div>

        <div class="qrWrap">
          <div class="qrBox">
            <div class="kvs" style="margin-bottom:8px">Show this to attendant</div>
            <div class="qrCanvas" id="qrCanvas"></div>
          </div>

          <div>
            <div class="kvs" id="voucherMeta"></div>
            <div class="sep"></div>

            <div class="grid2">
              <button class="btn btnPrimary btnWide" id="copyLinkBtn">Copy QR Link</button>
              <button class="btn btnLight btnWide" id="refreshStatusBtn">Refresh Status</button>
            </div>

            <div id="statusMsg" class="muted" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vouchers -->
    <div class="card" id="historyCard" style="display:none">
      <h2>My Vouchers</h2>
      <div class="muted">After dispensing, status becomes USED (auto-refresh updates).</div>
      <div style="margin-top:10px">
        <button class="btn btnLight" id="refreshHistoryBtn">Refresh</button>
      </div>
      <div id="historyList" class="muted" style="margin-top:10px">No vouchers yet.</div>
    </div>

    <!-- Wallet -->
    <div class="card" id="walletCard" style="display:none">
      <h2>Wallet</h2>
      <div class="muted">Load once during non-peak time. At bunk, voucher becomes instant.</div>

      <div class="sep"></div>
      <div class="grid2">
        <div>
          <div class="muted">Balance</div>
          <div style="font-weight:900;font-size:28px;color:var(--good)" id="walletBal">‚Çπ0</div>
        </div>
        <div style="display:flex;justify-content:flex-end;align-items:flex-start">
          <button class="btn btnLight" id="walletRefreshBtn">Refresh</button>
        </div>
      </div>

      <div class="field" style="margin-top:10px">
        <label>Top-up amount</label>
        <div class="chips">
          <button class="chipBtn" onclick="setTopup(200)">‚Çπ200</button>
          <button class="chipBtn" onclick="setTopup(500)">‚Çπ500</button>
          <button class="chipBtn" onclick="setTopup(1000)">‚Çπ1000</button>
          <button class="chipBtn" onclick="setTopup(2000)">‚Çπ2000</button>
        </div>
        <input id="topupAmount" placeholder="Custom amount (min ‚Çπ50)" inputmode="decimal" style="margin-top:8px"/>
      </div>

      <button class="btn btnBlue btnWide" id="addMoneyBtn" style="margin-top:10px">Add Money</button>
      <div class="muted" id="walletMsg" style="margin-top:8px"></div>
    </div>

    <!-- Vehicles -->
    <div class="card" id="vehiclesCard" style="display:none">
      <h2>Vehicles</h2>
      <div class="muted">Save your vehicles for faster voucher creation (default autofill).</div>

      <div class="sep"></div>
      <div class="grid2">
        <div class="field">
          <label>Vehicle Type</label>
          <select id="vehType">
            <option>Bike</option>
            <option>Car</option>
            <option>2-Wheeler</option>
            <option>Truck</option>
            <option>Auto</option>
          </select>
        </div>
        <div class="field">
          <label>Vehicle No</label>
          <input id="vehNo" placeholder="AP09AB1234" />
        </div>
      </div>

      <button class="btn btnBlue btnWide" id="saveVehBtn" style="margin-top:10px">Save Vehicle</button>

      <div class="sep"></div>
      <div id="vehList" class="muted">No vehicles saved.</div>
    </div>

    <!-- Analytics -->
    <div class="card" id="analyticsCard" style="display:none">
      <h2>üìä Analytics</h2>
      <div class="muted">Useful metrics: spend, fuel split, bunk usage, vehicle usage.</div>
      <div class="sep"></div>

      <div class="grid2">
        <div class="card" style="box-shadow:none;margin:0;border-radius:16px">
          <div class="muted">Total Spent</div>
          <div style="font-weight:900;font-size:28px" id="anSpent">‚Çπ0</div>
        </div>
        <div class="card" style="box-shadow:none;margin:0;border-radius:16px">
          <div class="muted">Total Litres</div>
          <div style="font-weight:900;font-size:28px" id="anLitres">0 L</div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div class="card" style="box-shadow:none;margin:0;border-radius:16px">
          <div class="muted">Most Used Bunk</div>
          <div style="font-weight:900;font-size:20px" id="anBunk">‚Äî</div>
        </div>
        <div class="card" style="box-shadow:none;margin:0;border-radius:16px">
          <div class="muted">Most Used Vehicle</div>
          <div style="font-weight:900;font-size:20px" id="anVeh">‚Äî</div>
        </div>
      </div>

      <div class="sep"></div>
      <button class="btn btnLight" id="refreshAnalyticsBtn">Refresh Analytics</button>
      <div class="muted" id="anMsg" style="margin-top:8px"></div>
    </div>

  </main>
</div>

<script>
  const API = window.location.origin;

  // ====== SESSION + STORAGE (per phone) ======
  const LS_ACTIVE_PHONE = "FUELSKIP_ACTIVE_PHONE"; // session pointer
  const LS_ACTIVE_NAME  = "FUELSKIP_ACTIVE_NAME";
  const LS_WALKIN = "FUELSKIP_WALKIN";

  function userKey(phone){ return "FUELSKIP_USERDATA_" + phone; }

  function getActivePhone(){ return (localStorage.getItem(LS_ACTIVE_PHONE)||"").trim(); }
  function isWalkin(){ return localStorage.getItem(LS_WALKIN) === "1"; }

  function loadUserData(){
    const phone = getActivePhone();
    if(!phone) return null;
    try{
      return JSON.parse(localStorage.getItem(userKey(phone))||"null");
    }catch(e){ return null; }
  }

  function saveUserData(data){
    const phone = getActivePhone();
    if(!phone) return;
    localStorage.setItem(userKey(phone), JSON.stringify(data||{}));
  }

  function ensureUserData(){
    let d = loadUserData();
    if(!d){
      d = {
        profile:{ phone:getActivePhone(), name:(localStorage.getItem(LS_ACTIVE_NAME)||"").trim() },
        vehicles:[], defaultVehicle:null,
        lastVoucher:null,
        wallet:{ balance:0 },
        prefs:{ defaultBunk:null, defaultFuel:"PETROL" },
        analyticsCache:{}
      };
      saveUserData(d);
    }
    return d;
  }

  function doLogout(){
    // IMPORTANT: keep user data in storage; only clear session pointer
    localStorage.removeItem(LS_ACTIVE_PHONE);
    localStorage.removeItem(LS_ACTIVE_NAME);
    localStorage.removeItem(LS_WALKIN);
    renderApp();
  }

  // ====== UI ELEMENTS ======
  const splash = document.getElementById("splash");

  const sidebar = document.getElementById("sidebar");
  const drawerBack = document.getElementById("drawerBack");
  const drawer = document.getElementById("drawer");

  const loginCard = document.getElementById("loginCard");
  const homeCard = document.getElementById("homeCard");
  const qrCard = document.getElementById("qrCard");
  const historyCard = document.getElementById("historyCard");
  const walletCard = document.getElementById("walletCard");
  const vehiclesCard = document.getElementById("vehiclesCard");
  const analyticsCard = document.getElementById("analyticsCard");

  const bunkSelect = document.getElementById("bunkSelect");
  const fuelType = document.getElementById("fuelType");
  const amount = document.getElementById("amount");
  const litres = document.getElementById("litres");
  const vehiclePick = document.getElementById("vehiclePick");
  const payMethod = document.getElementById("payMethod");

  const genVoucherBtn = document.getElementById("genVoucherBtn");
  const scrollQRBtn = document.getElementById("scrollQRBtn");
  const nearbyBtn = document.getElementById("nearbyBtn");

  const noVoucher = document.getElementById("noVoucher");
  const voucherBox = document.getElementById("voucherBox");
  const badgeRow = document.getElementById("badgeRow");
  const voucherMeta = document.getElementById("voucherMeta");
  const qrCanvas = document.getElementById("qrCanvas");
  const copyLinkBtn = document.getElementById("copyLinkBtn");
  const refreshStatusBtn = document.getElementById("refreshStatusBtn");
  const statusMsg = document.getElementById("statusMsg");

  const walletBal = document.getElementById("walletBal");
  const topupAmount = document.getElementById("topupAmount");
  const addMoneyBtn = document.getElementById("addMoneyBtn");
  const walletMsg = document.getElementById("walletMsg");
  const walletRefreshBtn = document.getElementById("walletRefreshBtn");

  const vehType = document.getElementById("vehType");
  const vehNo = document.getElementById("vehNo");
  const saveVehBtn = document.getElementById("saveVehBtn");
  const vehList = document.getElementById("vehList");

  const historyList = document.getElementById("historyList");
  const refreshHistoryBtn = document.getElementById("refreshHistoryBtn");

  const anSpent = document.getElementById("anSpent");
  const anLitres = document.getElementById("anLitres");
  const anBunk = document.getElementById("anBunk");
  const anVeh = document.getElementById("anVeh");
  const refreshAnalyticsBtn = document.getElementById("refreshAnalyticsBtn");
  const anMsg = document.getElementById("anMsg");

  // ====== NAV ======
  const tabs = [
    { id:"home", label:"üè† Home", sub:"Voucher" },
    { id:"wallet", label:"üí≥ Wallet", sub:"Topup" },
    { id:"history", label:"üßæ Vouchers", sub:"History" },
    { id:"vehicles", label:"üöó Vehicles", sub:"Saved" },
    { id:"analytics", label:"üìä Analytics", sub:"Insights" }
  ];
  let activeTab = "home";

  function sidebarHTML(){
    const phone = getActivePhone();
    const name = (localStorage.getItem(LS_ACTIVE_NAME)||"").trim();
    const loggedIn = !!phone && !isWalkin();

    const d = phone ? ensureUserData() : null;
    const bal = d ? (d.wallet?.balance || 0) : 0;

    return `
      <div class="brandBox">
        <div class="miniIcon">‚õΩ</div>
        <div style="min-width:0">
          <div class="b1">FuelSkip</div>
          <div class="b2">Prepaid Voucher ‚Ä¢ Fast Dispense</div>
        </div>
      </div>

      ${tabs.map(t=>`
        <button class="navBtn ${activeTab===t.id?'active':''}" onclick="setTab('${t.id}')">
          <div>${t.label}</div><span class="sub">${t.sub}</span>
        </button>
      `).join("")}

      <div class="sessionBox">
        <div class="sessionTitle">
          <span class="pill">${loggedIn ? "Logged in" : (isWalkin() ? "Walk-in" : "Not logged in")}</span>
          <button class="btn btnRed" style="padding:8px 10px;border-radius:14px" onclick="doLogout()">Logout</button>
        </div>
        <div class="muted" style="font-size:12px">
          ${loggedIn ? `${name || "User"}<br>${phone}` : (isWalkin() ? "Walk-in (no saved profile)" : "Login to save & reuse details.")}
        </div>
        <div class="sep"></div>
        <div class="muted" style="display:flex;justify-content:space-between;align-items:center">
          <span>Wallet</span><b style="color:var(--good)">‚Çπ${Number(bal).toLocaleString("en-IN")}</b>
        </div>

        <div style="margin-top:10px" class="grid2">
          <button class="btn btnPrimary btnWide" onclick="openLogin()">Login</button>
          <button class="btn btnLight btnWide" onclick="refreshAll()">Refresh</button>
        </div>

        <div class="muted" style="margin-top:10px;font-size:12px">
          Tip: After creating voucher, show QR instantly to attendant for scanning.
        </div>
      </div>
    `;
  }

  function setTab(id){
    activeTab = id;
    renderApp();
    closeDrawer();
    if(id === "home") return;
    if(id === "wallet") renderWallet();
    if(id === "vehicles") renderVehicles();
    if(id === "history") renderHistory();
    if(id === "analytics") renderAnalytics();
  }

  function openDrawer(){
    drawer.innerHTML = sidebarHTML();
    drawerBack.style.display = "block";
  }
  function closeDrawer(){
    drawerBack.style.display = "none";
  }

  document.getElementById("openDrawer").addEventListener("click", openDrawer);
  document.getElementById("refreshBtnTop").addEventListener("click", ()=> refreshAll());
  drawerBack.addEventListener("click", (e)=>{ if(e.target===drawerBack) closeDrawer(); });

  // ====== BUNKS (demo list) ======
  const BUNKS = [
    { id:"BUNK-1", name:"BPCL Siripuram" },
    { id:"BUNK-2", name:"Gajuwaka Expressway" }
  ];

  function bunkLabel(id){
    const b = BUNKS.find(x=>x.id===id);
    return b ? `${b.name} (${b.id})` : id;
  }

  function populateBunks(){
    bunkSelect.innerHTML = "";
    BUNKS.forEach(b=>{
      const opt = document.createElement("option");
      opt.value = b.id;
      opt.textContent = `${b.name} (${b.id})`;
      bunkSelect.appendChild(opt);
    });

    // Apply default bunk if saved
    const phone = getActivePhone();
    if(phone){
      const d = ensureUserData();
      if(d.prefs?.defaultBunk){
        bunkSelect.value = d.prefs.defaultBunk;
      }
      if(d.prefs?.defaultFuel){
        fuelType.value = d.prefs.defaultFuel;
      }
    }
  }

  // ====== LOGIN FLOW ======
  function openLogin(){
    activeTab = "home";
    localStorage.removeItem(LS_WALKIN);
    renderApp(true);
  }

  document.getElementById("doLogin").addEventListener("click", ()=>{
    const p = (document.getElementById("loginPhone").value||"").trim();
    if(!/^\d{10}$/.test(p)) return alert("Enter a valid 10-digit phone.");
    const n = (document.getElementById("loginName").value||"").trim();

    localStorage.setItem(LS_ACTIVE_PHONE, p);
    localStorage.setItem(LS_ACTIVE_NAME, n);
    localStorage.removeItem(LS_WALKIN);

    ensureUserData();
    renderApp();
  });

  document.getElementById("skipLogin").addEventListener("click", ()=>{
    localStorage.setItem(LS_WALKIN, "1");
    localStorage.removeItem(LS_ACTIVE_PHONE);
    localStorage.removeItem(LS_ACTIVE_NAME);
    renderApp();
  });

  // ====== HOME ACTIONS ======
  function setAmount(v){ amount.value = String(v); }
  window.setAmount = setAmount;

  function scrollToQR(){
    document.getElementById("qrCard").scrollIntoView({behavior:"smooth", block:"start"});
  }

  document.getElementById("scrollQRBtn").addEventListener("click", scrollToQR);

  document.getElementById("nearbyBtn").addEventListener("click", ()=>{
    alert("Pilot: using static bunk list. Next step: GPS-based nearest bunks.");
  });

  // ====== VEHICLES ======
  function renderVehiclePick(){
    vehiclePick.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "None";
    vehiclePick.appendChild(opt0);

    const phone = getActivePhone();
    if(!phone) return;

    const d = ensureUserData();
    (d.vehicles||[]).forEach(v=>{
      const o = document.createElement("option");
      o.value = v.id;
      o.textContent = `${v.type} ‚Ä¢ ${v.no}`;
      vehiclePick.appendChild(o);
    });

    if(d.defaultVehicle){
      vehiclePick.value = d.defaultVehicle;
    }
  }

  function renderVehicles(){
    const phone = getActivePhone();
    if(!phone){
      vehList.textContent = "Login to save vehicles.";
      renderVehiclePick();
      return;
    }
    const d = ensureUserData();
    const list = d.vehicles || [];
    if(!list.length){
      vehList.textContent = "No vehicles saved.";
      renderVehiclePick();
      return;
    }

    vehList.innerHTML = list.map(v=>`
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;
                  border:1px solid var(--line);background:#fff;border-radius:16px;padding:10px;margin-bottom:10px">
        <div style="font-weight:900">${v.type} ‚Ä¢ ${v.no}<div class="muted" style="font-size:12px">Tap ‚ÄúUse‚Äù to fill voucher form</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btnLight" style="padding:10px 12px" onclick="useVehicle('${v.id}')">Use</button>
          <button class="btn btnBlue" style="padding:10px 12px" onclick="setDefaultVehicle('${v.id}')">Default</button>
          <button class="btn btnRed" style="padding:10px 12px" onclick="deleteVehicle('${v.id}')">Delete</button>
        </div>
      </div>
    `).join("");

    renderVehiclePick();
  }

  function useVehicle(id){
    const d = ensureUserData();
    const v = (d.vehicles||[]).find(x=>x.id===id);
    if(!v) return;
    // only used as a reference ‚Äî backend uses fields in voucher create
    alert(`Selected vehicle: ${v.type} ${v.no}`);
  }
  window.useVehicle = useVehicle;

  function setDefaultVehicle(id){
    const d = ensureUserData();
    d.defaultVehicle = id;
    saveUserData(d);
    renderVehicles();
    renderVehiclePick();
  }
  window.setDefaultVehicle = setDefaultVehicle;

  function deleteVehicle(id){
    const d = ensureUserData();
    d.vehicles = (d.vehicles||[]).filter(x=>x.id!==id);
    if(d.defaultVehicle === id) d.defaultVehicle = null;
    saveUserData(d);
    renderVehicles();
  }
  window.deleteVehicle = deleteVehicle;

  saveVehBtn.addEventListener("click", ()=>{
    const phone = getActivePhone();
    if(!phone) return alert("Login to save vehicles.");
    const type = vehType.value;
    const no = (vehNo.value||"").trim().toUpperCase();
    if(!no) return alert("Enter vehicle number.");

    const d = ensureUserData();
    const id = "V" + Math.random().toString(16).slice(2,10);
    d.vehicles = d.vehicles || [];
    d.vehicles.push({ id, type, no, created_at: Date.now() });
    if(!d.defaultVehicle) d.defaultVehicle = id;
    saveUserData(d);

    vehNo.value = "";
    renderVehicles();
    renderVehiclePick();
  });

  // ====== WALLET (pilot local wallet for speed) ======
  function renderWallet(){
    const phone = getActivePhone();
    if(!phone){
      walletBal.textContent = "‚Çπ0";
      walletMsg.textContent = "Login to use wallet balance across sessions.";
      return;
    }
    const d = ensureUserData();
    walletBal.textContent = "‚Çπ" + Number(d.wallet?.balance||0).toLocaleString("en-IN");
    walletMsg.textContent = "";
  }

  function setTopup(v){ topupAmount.value = String(v); }
  window.setTopup = setTopup;

  addMoneyBtn.addEventListener("click", ()=>{
    const phone = getActivePhone();
    if(!phone) return alert("Login to top up wallet.");
    const v = Number(topupAmount.value || 0);
    if(!(v >= 50)) return alert("Min top-up ‚Çπ50");

    const d = ensureUserData();
    d.wallet.balance = Number(d.wallet.balance||0) + v;
    saveUserData(d);
    walletMsg.textContent = "‚úÖ Added. Updating balance‚Ä¶";
    renderWallet();
  });

  walletRefreshBtn.addEventListener("click", renderWallet);

  // ====== VOUCHER CREATE (calls backend) ======
  async function createVoucher(){
    const bunk_id = bunkSelect.value;
    const fuel = fuelType.value;
    const amt = Number(amount.value || 0);
    const lit = Number(litres.value || 0);
    const method = payMethod.value;

    if(!(amt>0) && !(lit>0)) return alert("Enter amount or litres.");

    // Vehicle details
    let vehicle_type = "";
    let vehicle_no = "";
    const phone = getActivePhone();
    if(phone){
      const d = ensureUserData();
      const vid = vehiclePick.value || d.defaultVehicle;
      const v = (d.vehicles||[]).find(x=>x.id===vid);
      if(v){ vehicle_type = v.type; vehicle_no = v.no; }
    }

    // Customer info
    const customer_phone = phone || "";
    const customer_name = (localStorage.getItem(LS_ACTIVE_NAME)||"").trim();

    // Wallet check
    if(method === "WALLET" && phone){
      const d = ensureUserData();
      const need = amt>0 ? amt : 0;
      if(need > 0 && Number(d.wallet.balance||0) < need){
        return alert("Wallet balance low. Top up or use Razorpay.");
      }
      if(need>0){
        d.wallet.balance = Number(d.wallet.balance||0) - need;
        saveUserData(d);
        renderWallet();
      }
    }

    const payload = {
      bunk_id,
      fuel_type: fuel,
      amount: amt>0 ? amt : null,
      litres: lit>0 ? lit : null,
      payment_method: method,
      customer_phone: customer_phone || null,
      customer_name: customer_name || null,
      vehicle_type: vehicle_type || null,
      vehicle_no: vehicle_no || null
    };

    genVoucherBtn.disabled = true;
    genVoucherBtn.textContent = "Generating‚Ä¶";

    const res = await fetch(`${API}/vouchers`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=> ({}));

    genVoucherBtn.disabled = false;
    genVoucherBtn.textContent = "Generate Voucher";

    if(!res.ok){
      alert(data.detail || "Voucher create failed");
      return;
    }

    // Save last voucher in user data (if logged in)
    if(phone){
      const d = ensureUserData();
      d.lastVoucher = data;
      d.prefs.defaultBunk = bunk_id;
      d.prefs.defaultFuel = fuel;
      saveUserData(d);
    }

    renderLatestVoucher(data);
    setTab("home");
    scrollToQR();
  }

  genVoucherBtn.addEventListener("click", createVoucher);

  function renderLatestVoucher(v){
    qrCard.style.display = "block";
    noVoucher.style.display = "none";
    voucherBox.style.display = "block";

    badgeRow.innerHTML = "";
    const addBadge = (txt, cls)=> {
      const s = document.createElement("span");
      s.className = "badge " + (cls||"");
      s.textContent = txt;
      badgeRow.appendChild(s);
    };

    addBadge((v.status||"PAID").toUpperCase(), (String(v.status).toLowerCase()==="used"?"warn":"good"));
    addBadge((v.fuel_type||"PETROL").toUpperCase(), "warn");
    addBadge((v.payment_method||"WALLET").toUpperCase(), "");

    const created = v.created_at ? new Date(v.created_at).toLocaleString("en-IN",{timeZone:"Asia/Kolkata"}) : new Date().toLocaleString("en-IN");
    voucherMeta.innerHTML = `
      <div class="kvs">
        <b>Voucher:</b> ${v.id}<br>
        <b>Bunk:</b> ${bunkLabel(v.bunk_id)} ¬∑ <b>Amount:</b> ‚Çπ${Number(v.amount||0).toLocaleString("en-IN")} ¬∑ <b>Litres:</b> ${Number(v.litres||0).toFixed(2)} L ¬∑ <b>Time:</b> ${created}
      </div>
    `;

    // QR = attendant link with signature
    const sig = v.sig || v.signature || "";
    const link = `${API}/attendant.html?voucher=${encodeURIComponent(v.id)}&sig=${encodeURIComponent(sig)}`;

    qrCanvas.innerHTML = "";
    new QRCode(qrCanvas, { text: link, width: 220, height: 220 });

    copyLinkBtn.onclick = async ()=>{
      await navigator.clipboard.writeText(link);
      statusMsg.textContent = "‚úÖ Copied QR link.";
    };

    refreshStatusBtn.onclick = async ()=>{
      statusMsg.textContent = "Refreshing status‚Ä¶";
      const rr = await fetch(`${API}/vouchers/${encodeURIComponent(v.id)}`, { cache:"no-store" });
      const dd = await rr.json().catch(()=> ({}));
      if(rr.ok){
        statusMsg.textContent = `Status: ${(dd.status||"").toUpperCase()}`;
        // update badge if used
        if(String(dd.status||"").toLowerCase()==="used"){
          addBadge("USED", "warn");
        }
      }else{
        statusMsg.textContent = dd.detail || "Status refresh failed";
      }
    };
  }

  // ====== HISTORY + ANALYTICS ======
  async function renderHistory(){
    const phone = getActivePhone();
    if(!phone){
      historyList.textContent = "Login to see your voucher history.";
      return;
    }
    historyList.textContent = "Loading‚Ä¶";
    const res = await fetch(`${API}/vouchers?customer_phone=${encodeURIComponent(phone)}`, { cache:"no-store" });
    const data = await res.json().catch(()=> ([]));
    if(!res.ok){
      historyList.textContent = data.detail || "Failed to load history";
      return;
    }
    if(!data.length){
      historyList.textContent = "No vouchers yet.";
      return;
    }
    historyList.innerHTML = data.map(v=>{
      const st = String(v.status||"").toLowerCase();
      const pill = st==="used" ? "badge warn" : (st==="paid" ? "badge good":"badge bad");
      return `
        <div style="border:1px solid var(--line);background:#fff;border-radius:16px;padding:10px;margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div style="font-weight:900">${v.id}</div>
            <span class="${pill}">${(v.status||"").toUpperCase()}</span>
          </div>
          <div class="muted" style="margin-top:6px">
            ${bunkLabel(v.bunk_id)} ¬∑ ${(v.fuel_type||"").toUpperCase()} ¬∑ ‚Çπ${Number(v.amount||0).toLocaleString("en-IN")} ¬∑ ${Number(v.litres||0).toFixed(2)} L
          </div>
        </div>
      `;
    }).join("");
  }

  refreshHistoryBtn.addEventListener("click", renderHistory);

  async function renderAnalytics(){
    const phone = getActivePhone();
    if(!phone){
      anMsg.textContent = "Login to generate analytics.";
      anSpent.textContent = "‚Çπ0";
      anLitres.textContent = "0 L";
      anBunk.textContent = "‚Äî";
      anVeh.textContent = "‚Äî";
      return;
    }

    anMsg.textContent = "Loading‚Ä¶";

    const res = await fetch(`${API}/vouchers?customer_phone=${encodeURIComponent(phone)}`, { cache:"no-store" });
    const data = await res.json().catch(()=> ([]));
    if(!res.ok){
      anMsg.textContent = data.detail || "Failed to load analytics";
      return;
    }

    let spent=0, litresSum=0;
    const bunkCount = {};
    data.forEach(v=>{
      spent += Number(v.amount||0);
      litresSum += Number(v.litres||0);
      bunkCount[v.bunk_id] = (bunkCount[v.bunk_id]||0) + 1;
    });

    const topBunkId = Object.keys(bunkCount).sort((a,b)=> bunkCount[b]-bunkCount[a])[0] || "";
    const d = ensureUserData();
    const topVeh = (()=> {
      const defId = d.defaultVehicle;
      const v = (d.vehicles||[]).find(x=>x.id===defId);
      return v ? `${v.type} ${v.no}` : "‚Äî";
    })();

    anSpent.textContent = "‚Çπ" + spent.toLocaleString("en-IN");
    anLitres.textContent = litresSum.toFixed(2) + " L";
    anBunk.textContent = topBunkId ? bunkLabel(topBunkId).split("(")[0].trim() : "‚Äî";
    anVeh.textContent = topVeh;

    anMsg.textContent = "‚úÖ Updated";
  }

  refreshAnalyticsBtn.addEventListener("click", renderAnalytics);

  // ====== RENDER APP ======
  function showOnly(which){
    const all = [loginCard, homeCard, qrCard, historyCard, walletCard, vehiclesCard, analyticsCard];
    all.forEach(x=> x.style.display = "none");
    which.forEach(x=> x.style.display = "block");
  }

  function renderApp(forceLogin=false){
    // Sidebar
    sidebar.innerHTML = sidebarHTML();

    const phone = getActivePhone();
    const walkin = isWalkin();
    const loggedIn = !!phone && !walkin;

    populateBunks();
    renderVehiclePick();

    // If forced login OR not logged in and not walk-in, show login
    if(forceLogin || (!loggedIn && !walkin)){
      showOnly([loginCard]);
      return;
    }

    // Show main app + QR card always
    showOnly([homeCard, qrCard]);

    // Load last voucher if saved
    if(loggedIn){
      const d = ensureUserData();
      renderWallet();
      renderVehicles();

      if(d.lastVoucher){
        renderLatestVoucher(d.lastVoucher);
      }else{
        qrCard.style.display = "block";
        noVoucher.style.display = "block";
        voucherBox.style.display = "none";
      }
    }else{
      // walk-in mode
      qrCard.style.display = "block";
      noVoucher.style.display = "block";
      voucherBox.style.display = "none";
    }

    // Tab displays
    if(activeTab === "wallet"){ walletCard.style.display="block"; renderWallet(); }
    if(activeTab === "history"){ historyCard.style.display="block"; renderHistory(); }
    if(activeTab === "vehicles"){ vehiclesCard.style.display="block"; renderVehicles(); }
    if(activeTab === "analytics"){ analyticsCard.style.display="block"; renderAnalytics(); }
  }

  function refreshAll(){
    renderApp();
    if(activeTab==="wallet") renderWallet();
    if(activeTab==="vehicles") renderVehicles();
    if(activeTab==="history") renderHistory();
    if(activeTab==="analytics") renderAnalytics();
  }
  window.refreshAll = refreshAll;
  window.setTab = setTab;
  window.doLogout = doLogout;
  window.openLogin = openLogin;

  // Splash timing
  window.addEventListener("load", ()=>{
    setTimeout(()=>{
      splash.style.display = "none";
      renderApp(false);
    }, 700);
  });
</script>

</body>
</html>
