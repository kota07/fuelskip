<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FuelSkip - Customer (Analytics + Flow)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- Razorpay Checkout -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<style>
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
margin: 0;
padding: 20px;
color: #333;
line-height: 1.4;
display: flex;
justify-content: center;
}

/* MAIN LAYOUT WRAPPER (so drawer overlays whole screen) */
.app-shell {
position: relative;
width: 100%;
max-width: 960px;
}

/* Sidebar drawer */
.sidebar {
position: fixed;
top: 0;
left: 0;
width: 280px;
max-width: 85%;
height: 100vh;
background: #ffffff;
border-radius: 0 20px 20px 0;
box-shadow: 0 20px 60px rgba(15,23,42,0.25);
padding: 24px 0;
display: flex;
flex-direction: column;
transform: translateX(-100%);
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
z-index: 1000;
backdrop-filter: blur(20px);
}
.sidebar.open {
transform: translateX(0);
}
.sidebar-header {
padding: 24px 24px 20px;
border-bottom: 1px solid #f1f5f9;
background: linear-gradient(135deg, #667eea10, #764ba210);
}
.sidebar-header h2 {
margin: 0 0 8px;
font-size: 20px;
font-weight: 700;
color: #1e293b;
}
.sidebar-header small {
font-size: 13px;
color: #64748b;
font-weight: 500;
}
.sidebar-menu {
list-style: none;
padding: 16px 0;
margin: 0;
flex: 1;
overflow-y: auto;
}
.sidebar-menu li {
margin-bottom: 4px;
}
.sidebar-menu a {
display: flex;
align-items: center;
gap: 12px;
padding: 14px 24px;
font-size: 15px;
font-weight: 500;
color: #64748b;
text-decoration: none;
border-left: 4px solid transparent;
transition: all 0.2s ease;
position: relative;
}
.sidebar-menu a:hover,
.sidebar-menu a.active {
background: linear-gradient(135deg, #eef2ff, #e0f2fe);
border-left-color: #6366f1;
color: #1e293b;
transform: translateX(4px);
}
.sidebar-menu a::before {
content: '';
position: absolute;
right: 20px;
width: 4px;
height: 4px;
background: #6366f1;
border-radius: 50%;
opacity: 0;
transition: opacity 0.2s ease;
}
.sidebar-menu a:hover::before,
.sidebar-menu a.active::before {
opacity: 1;
}
.sidebar-footer {
padding: 20px 24px;
border-top: 1px solid #f1f5f9;
}
.sidebar-footer button {
width: 100%;
border: none;
background: linear-gradient(135deg, #ef4444, #dc2626);
color: white;
text-align: left;
padding: 14px 20px;
cursor: pointer;
font-weight: 600;
font-size: 14px;
border-radius: 12px;
transition: all 0.2s ease;
display: flex;
align-items: center;
gap: 10px;
}
.sidebar-footer button:hover {
transform: translateY(-1px);
box-shadow: 0 10px 25px rgba(239,68,68,0.3);
}

/* Backdrop behind drawer */
.backdrop {
position: fixed;
inset: 0;
background: rgba(15,23,42,0.5);
opacity: 0;
pointer-events: none;
transition: opacity 0.3s ease;
z-index: 999;
backdrop-filter: blur(8px);
}
.backdrop.show {
opacity: 1;
pointer-events: auto;
}

/* Hide sidebar+backdrop before login */
.sidebar-hidden {
display: none !important;
}

/* Main container */
.container {
max-width: 540px;
margin: 0 auto;
background: rgba(255,255,255,0.97);
border-radius: 24px;
padding: 28px 28px 36px;
box-shadow: 0 25px 50px rgba(0,0,0,0.15);
backdrop-filter: blur(20px);
border: 1px solid rgba(255,255,255,0.2);
position: relative;
}

.header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 24px;
padding-bottom: 16px;
border-bottom: 1px solid #f1f5f9;
}

h1 {
margin: 0;
color: #1e293b;
font-size: 26px;
font-weight: 800;
background: linear-gradient(135deg, #6366f1, #8b5cf6);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.header-right {
display: flex;
align-items: center;
gap: 12px;
}

.user-pill {
font-size: 14px;
font-weight: 600;
color: #64748b;
background: #f8fafc;
padding: 6px 12px;
border-radius: 20px;
}

.hamburger {
border: none;
background: linear-gradient(135deg, #1e293b, #334155);
color: #f8fafc;
border-radius: 12px;
padding: 10px 14px;
font-size: 20px;
cursor: pointer;
font-weight: bold;
box-shadow: 0 4px 12px rgba(30,41,59,0.3);
transition: all 0.2s ease;
}
.hamburger:hover {
transform: scale(1.05);
box-shadow: 0 6px 20px rgba(30,41,59,0.4);
}

.card {
background: rgba(255,255,255,0.85);
border-radius: 20px;
padding: 24px;
margin-bottom: 20px;
box-shadow: 0 8px 25px rgba(0,0,0,0.08);
border: 1px solid rgba(248,250,252,0.8);
transition: all 0.2s ease;
position: relative;
overflow: hidden;
}
.card::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 1px;
background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
}
.card:hover {
transform: translateY(-2px);
box-shadow: 0 15px 40px rgba(0,0,0,0.12);
}

.form-group { 
margin-bottom: 20px; 
position: relative;
}
.label {
display: block;
margin-bottom: 8px;
font-size: 14px;
font-weight: 600;
color: #374151;
}
input, select {
width: 100%;
padding: 14px 16px;
border-radius: 14px;
border: 2px solid #f1f5f9;
font-size: 15px;
box-sizing: border-box;
background: #fafbfc;
font-weight: 500;
transition: all 0.2s ease;
}
input:focus, select:focus {
outline: none;
border-color: #6366f1;
box-shadow: 0 0 0 4px rgba(99,102,241,0.1);
background: white;
transform: translateY(-1px);
}

.vehicle-section {
background: linear-gradient(135deg, #f8fafc, #f1f5f9);
padding: 20px;
border-radius: 16px;
margin-bottom: 20px;
border-left: 5px solid #6366f1;
box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}
.vehicle-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 14px;
margin-top: 12px;
}

button {
border: none;
border-radius: 14px;
padding: 14px 20px;
font-size: 15px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
position: relative;
overflow: hidden;
}
button:active { 
transform: scale(0.97); 
}

.btn-primary {
background: linear-gradient(135deg, #22c55e, #16a34a);
color: white;
width: 100%;
margin-top: 8px;
box-shadow: 0 8px 25px rgba(34,197,94,0.3);
font-size: 16px;
position: relative;
}
.btn-primary:hover {
background: linear-gradient(135deg, #16a34a, #15803d);
box-shadow: 0 12px 35px rgba(22,163,74,0.4);
transform: translateY(-2px);
}
.btn-primary::after {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
transition: left 0.5s;
}
.btn-primary:hover::after {
left: 100%;
}

.badge { 
padding: 6px 12px; 
border-radius: 20px; 
font-size:12px; 
font-weight:600;
letter-spacing: 0.5px;
text-transform: uppercase;
}
.badge-pending { 
background: linear-gradient(135deg, #fef3c7, #fde68a); 
color: #92400e; 
box-shadow: 0 2px 8px rgba(245,158,11,0.3);
}
.badge-paid { 
background: linear-gradient(135deg, #dcfce7, #bbf7d0); 
color: #166534; 
box-shadow: 0 2px 8px rgba(34,197,94,0.3);
}
.badge-used { 
background: linear-gradient(135deg, #f1f5f9, #e2e8f0); 
color: #475569; 
box-shadow: 0 2px 8px rgba(71,85,105,0.2);
}
.badge-failed { 
background: linear-gradient(135deg, #fee2e2, #fecaca); 
color: #b91c1c; 
box-shadow: 0 2px 8px rgba(239,68,68,0.3);
}

.history-item {
border-bottom: 1px solid #f1f5f9;
padding: 16px 0;
display: flex;
justify-content: space-between;
align-items: center;
font-size: 14px;
transition: all 0.2s ease;
}
.history-item:hover {
background: #f8fafc;
padding-left: 8px;
border-radius: 8px;
}
.history-item:last-child {
border-bottom: none;
}

#voucherBox { display: none; }
#qrContainer { 
margin-top: 16px; 
display: flex; 
justify-content: center; 
padding: 20px;
background: #f8fafc;
border-radius: 16px;
}

#voucherDetails {
font-size: 15px; 
margin-bottom: 16px; 
padding: 20px; 
background: linear-gradient(135deg, #ecfdf5, #d1fae5); 
border-radius: 16px; 
border-left: 5px solid #22c55e;
box-shadow: 0 4px 12px rgba(34,197,94,0.15);
text-align: center;
}

/* Analytics sections (hidden by default) */
.page-section { display: none; }
.page-section.active { display: block; }

/* Dashboard cards */
.dash-card {
background: linear-gradient(135deg, #eef2ff, #e0e7ff);
border: none;
padding: 20px;
border-radius: 16px;
text-align: center;
transition: all 0.2s ease;
}
.dash-card:hover {
transform: translateY(-4px);
box-shadow: 0 20px 40px rgba(99,102,241,0.2);
}

/* Responsive */
@media (max-width: 900px) {
body { padding: 12px; }
.container {
width: 100%;
max-width: 100%;
padding: 20px 16px 28px;
margin: 8px;
}
.sidebar { width: 300px; max-width: 90%; }
h1 { font-size: 24px; }
.vehicle-grid { grid-template-columns: 1fr; }
}

@media (max-width: 480px) {
.container { padding: 16px 12px 24px; }
.card { padding: 20px 16px; }
}
</style>
</head>
<body>
<div class="app-shell">

<!-- Backdrop for drawer -->
<div id="backdrop" class="backdrop sidebar-hidden" onclick="closeSidebar()"></div>

<!-- LEFT ANALYTICS SIDEBAR (drawer) -->
<aside class="sidebar sidebar-hidden" id="sidebar">
<div class="sidebar-header">
<h2>üìä Analytics Hub</h2>
<small id="sidebarUser">Not logged in</small>
</div>
<ul class="sidebar-menu">
<li><a href="#" onclick="openSection('create');closeSidebar();return false;" id="homeLink">üè† Home</a></li>
<li><a href="#" onclick="openSection('dashboard');closeSidebar();return false;" id="dashLink">üìà Dashboard</a></li>
<li><a href="#" onclick="openSection('vehicles');closeSidebar();return false;" id="vehLink">üöó Vehicles</a></li>
<li><a href="#" onclick="openSection('bunks');closeSidebar();return false;" id="bunkLink">‚õΩ Bunks</a></li>
<li><a href="#" onclick="openSection('profile');closeSidebar();return false;" id="profLink">üë§ Profile</a></li>
</ul>
<div class="sidebar-footer">
<button onclick="logout()">
üö™ Logout
</button>
</div>
</aside>

<!-- MAIN FLOW CONTAINER -->
<div class="container">
<div class="header">
<h1>üöó FuelSkip</h1>
<div class="header-right">
<div class="user-pill" id="userDisplay"></div>
<button class="hamburger" onclick="toggleSidebar()" title="Menu">‚ò∞</button>
</div>
</div>

<!-- 1) LOGIN + CREATE VOUCHER FLOW (DEFAULT) -->
<div id="create" class="page-section active">
<!-- Login -->
<div class="card" id="loginBox">
<h3 style="margin:0 0 24px 0; font-size:22px; color:#1e293b;">üëã Welcome to FuelSkip</h3>
<div class="form-group">
<span class="label">üì± Phone number</span>
<input id="phone" type="tel" placeholder="98XXXXXXXX" maxlength="10">
</div>
<div class="form-group">
<span class="label">üë§ Name (optional)</span>
<input id="name" placeholder="Enter your name">
</div>
<div class="form-group">
<span class="label">üìß Email (optional)</span>
<input id="email" type="email" placeholder="you@gmail.com">
</div>
<button class="btn-primary" onclick="login()">
üöÄ Get Started
</button>
<p style="font-size:13px; color:#64748b; margin-top:16px; text-align:center;">Quick fuel vouchers for your daily commute</p>
</div>

<!-- Create voucher -->
<div class="card" id="createBox" style="display:none;">
<h3 style="margin:0 0 24px 0; font-size:22px;">‚ûï Create Fuel Voucher</h3>

<div class="vehicle-section">
<strong style="font-size:14px; font-weight:700; color:#1e293b;">Vehicle Details</strong>
<div class="vehicle-grid">
<div class="form-group">
<span class="label">Type</span>
<select id="vehicleType">
<option value="Bike">üèçÔ∏è Bike</option>
<option value="Car" selected>üöó Car</option>
<option value="Auto">üõ∫ Auto</option>
<option value="Truck">üöõ Truck</option>
<option value="Other">üöô Other</option>
</select>
</div>
<div class="form-group">
<span class="label">Number</span>
<input id="vehicleNo" type="text" placeholder="AP05AB1234" maxlength="12">
</div>
</div>
</div>

<div class="form-group">
<span class="label">‚õΩ Select Fuel Station</span>
<select id="bunkSelect">
<option value="BUNK-1">BPCL Siripuram</option>
<option value="BUNK-2">Gajuwaka Expressway</option>
</select>
</div>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
<div class="form-group">
<span class="label">üí∞ Amount (‚Çπ)</span>
<input id="amount" type="number" min="50" max="5000" placeholder="500">
</div>
<div class="form-group">
<span class="label">‚õΩ OR Litres</span>
<input id="litres" type="number" min="5" max="500" step="0.1" placeholder="25">
</div>
</div>

<button class="btn-primary" onclick="createVoucher()">
‚ú® Generate Voucher
</button>
<p id="msg" style="font-size:13px; color:#64748b; margin-top:12px; text-align:center; font-weight:500;"></p>
</div>

<!-- Voucher + Pay now + QR -->
<div class="card" id="voucherBox">
<h3 style="margin:0 0 24px 0; font-size:22px;">‚úÖ Your Voucher is Ready!</h3>
<div id="voucherDetails"></div>
<button class="btn-primary" id="payBtn" onclick="payNow()">
üí≥ Pay Now & Get QR
</button>
<div id="qrSection" style="display:none;">
<p style="font-size:14px; text-align:center; margin-bottom:16px; color:#374151; font-weight:500;">Show this QR code to fuel attendant</p>
<div id="qrContainer"></div>
<div style="text-align:center; margin-top:20px; padding:16px; background:#f8fafc; border-radius:12px;">
<strong style="font-size:16px; color:#1e293b;">Voucher ID:</strong><br>
<span id="voucherIdDisplay" style="font-family:monospace; font-size:18px; color:#6366f1; letter-spacing:1px;"></span>
</div>
</div>
</div>

<!-- History -->
<div class="card" id="historyBox" style="display:none;">
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
<h3 style="margin:0; font-size:22px;">üìã My Vouchers</h3>
<button style="width:auto; padding:12px 20px; font-size:14px; background:linear-gradient(135deg,#6366f1,#5856eb); color:white; border-radius:12px; font-weight:600; box-shadow:0 4px 12px rgba(99,102,241,0.3);" onclick="loadMyVouchers()">
‚ü≤ Refresh
</button>
</div>
<div id="myVouchers" style="font-size:14px; color:#64748b;">Login to see your voucher history.</div>
</div>
</div>

<!-- 2) ANALYTICS PAGES (OPEN ONLY FROM LEFT) -->

<div id="dashboard" class="page-section">
<h3 style="font-size:26px; margin:0 0 32px 0; color:#1e293b;">üìä Your Fuel Analytics</h3>
<div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:20px; margin-bottom:28px;">
<div class="dash-card" style="background:linear-gradient(135deg,#eef2ff,#e0e7ff);">
<div style="font-size:11px; text-transform:uppercase; color:#64748b; font-weight:600; margin-bottom:8px;">Total Spend</div>
<div style="font-size:28px; font-weight:800; color:#1e293b; margin-bottom:4px;" id="dashTotalSpend">‚Çπ0</div>
<div style="font-size:13px; color:#6366f1; font-weight:600;">Lifetime</div>
</div>
<div class="dash-card" style="background:linear-gradient(135deg,#e0f2fe,#bfdbfe);">
<div style="font-size:11px; text-transform:uppercase; color:#64748b; font-weight:600; margin-bottom:8px;">Total Fills</div>
<div style="font-size:28px; font-weight:800; color:#1e293b;" id="dashTotalFills">0</div>
<div style="font-size:13px; color:#0ea5e9; font-weight:600;">Transactions</div>
</div>
<div class="dash-card" style="background:linear-gradient(135deg,#dcfce7,#bbf7d0);">
<div style="font-size:11px; text-transform:uppercase; color:#64748b; font-weight:600; margin-bottom:8px;">Avg Fill</div>
<div style="font-size:28px; font-weight:800; color:#1e293b;" id="dashAvgFill">‚Çπ0</div>
<div style="font-size:13px; color:#22c55e; font-weight:600;">Per Fill</div>
</div>
</div>
<div class="card">
<p style="font-size:14px; margin:0 0 12px 0; color:#64748b;">üöó Top vehicle: <strong style="color:#1e293b; font-weight:700;" id="dashTopVehicle">-</strong></p>
<p style="font-size:13px; color:#64748b; margin:0;">Track your fuel patterns and optimize spending</p>
</div>
</div>

<div id="vehicles" class="page-section">
<h3 style="font-size:26px; margin:0 0 28px 0; color:#1e293b;">üöó Your Vehicles</h3>
<div id="vehicleList" class="card" style="font-size:14px; color:#64748b; padding:32px; text-align:center;">
No vehicle data yet. Create some vouchers to see analytics!
</div>
</div>

<div id="bunks" class="page-section">
<h3 style="font-size:26px; margin:0 0 28px 0; color:#1e293b;">‚õΩ Fuel Stations</h3>
<div id="bunkList" class="card" style="font-size:14px; color:#64748b; padding:32px; text-align:center;">
No bunk data yet. Fuel up to see your station preferences!
</div>
</div>

<div id="profile" class="page-section">
<h3 style="font-size:26px; margin:0 0 28px 0; color:#1e293b;">üë§ Profile</h3>
<div id="profileInfo" class="card" style="font-size:14px; color:#64748b; padding:32px; text-align:center;">
Login to view and edit your profile.
</div>
</div>

</div>
</div>

<script>
const API = "https://fuelskip-production.up.railway.app";

let lastVoucherId = null;
let razorpayOrderId = null;
let razorpayKeyId = null;
let pollTimer = null;
let currentVehicle = null;

function getUserId(){ return localStorage.getItem("fuelskip_user_id"); }
function setUserId(id){ localStorage.setItem("fuelskip_user_id", id); }
function setUserName(n){ localStorage.setItem("fuelskip_user_name", n || ""); }
function setUserPhone(p){ localStorage.setItem("fuelskip_user_phone", p || ""); }
function setUserEmail(e){ localStorage.setItem("fuelskip_user_email", e || ""); }
function getUserEmail(){ return localStorage.getItem("fuelskip_user_email") || ""; }

function historyKey(){
const uid = getUserId();
return uid ? `fuelskip_vehicle_history_${uid}` : null;
}

// Enhanced bunk mapping
const BUNK_NAMES = {
"BUNK-1": "BPCL Siripuram",
"BUNK-2": "Gajuwaka Expressway",
"BUNK-3": "HPCL MVP Colony",
"BUNK-4": "IOCL Seethammadhara"
};

function bunkName(id){
return BUNK_NAMES[id] || id || "Unknown Station";
}

/* Enhanced Drawer controls */
function toggleSidebar(){
const sidebar = document.getElementById("sidebar");
const backdrop = document.getElementById("backdrop");
if(sidebar.classList.contains("sidebar-hidden")){
sidebar.classList.remove("sidebar-hidden");
backdrop.classList.remove("sidebar-hidden");
requestAnimationFrame(()=>{
sidebar.classList.add("open");
backdrop.classList.add("show");
});
document.querySelectorAll('.sidebar-menu a').forEach(link => {
link.classList.remove('active');
});
document.getElementById('homeLink').classList.add('active');
} else {
closeSidebar();
}
}

function closeSidebar(){
const sidebar = document.getElementById("sidebar");
const backdrop = document.getElementById("backdrop");
sidebar.classList.remove("open");
backdrop.classList.remove("show");
setTimeout(()=>{
sidebar.classList.add("sidebar-hidden");
backdrop.classList.add("sidebar-hidden");
},300);
}

function refreshUserDisplay(){
const n = localStorage.getItem("fuelskip_user_name") || "";
const p = localStorage.getItem("fuelskip_user_phone") || "";
const displayText = p ? (n ? `${n} (${p})` : p) : "";
document.getElementById("userDisplay").textContent = displayText;
document.getElementById("sidebarUser").textContent = p ? (n ? `${n} ‚Ä¢ ${p}` : p) : "Not logged in";
}

function updateActiveMenu(section){
document.querySelectorAll('.sidebar-menu a').forEach(link => {
link.classList.remove('active');
});
const activeLink = {
'create': 'homeLink',
'dashboard': 'dashLink',
'vehicles': 'vehLink',
'bunks': 'bunkLink',
'profile': 'profLink'
}[section];
if(activeLink) document.getElementById(activeLink).classList.add('active');
}

function openSection(id){
document.querySelectorAll(".page-section").forEach(s=>s.classList.remove("active"));
document.getElementById(id).classList.add("active");
updateActiveMenu(id);
if(id === "profile"){
loadProfile();
} else if(id !== "create"){
loadAnalytics();
}
}

function logout(){
if(!confirm("Logout and clear all data?")) return;
localStorage.removeItem("fuelskip_user_id");
localStorage.removeItem("fuelskip_user_name");
localStorage.removeItem("fuelskip_user_phone");
localStorage.removeItem("fuelskip_user_email");

document.getElementById("phone").value="";
document.getElementById("name").value="";
document.getElementById("email").value="";
document.getElementById("amount").value="";
document.getElementById("litres").value="";
document.getElementById("vehicleNo").value="";

document.getElementById("loginBox").style.display="block";
document.getElementById("createBox").style.display="none";
document.getElementById("voucherBox").style.display="none";
document.getElementById("historyBox").style.display="none";

const sidebar = document.getElementById("sidebar");
const backdrop = document.getElementById("backdrop");
sidebar.classList.add("sidebar-hidden");
backdrop.classList.add("sidebar-hidden");
sidebar.classList.remove("open");
backdrop.classList.remove("show");

openSection("create");
refreshUserDisplay();
if(pollTimer) clearInterval(pollTimer);
}

async function login(){
const phone = document.getElementById("phone").value.trim().replace(/\D/g,'');
const name = document.getElementById("name").value.trim() || null;
const email = document.getElementById("email").value.trim() || null;

if(!phone || phone.length < 10){ 
alert("Please enter a valid 10-digit phone number"); 
document.getElementById("phone").focus();
return; 
}

const msg = document.getElementById("msg");
msg.textContent = "üîÑ Logging you in...";
msg.style.color = "#6366f1";

try{
const res = await fetch(`${API}/login`,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({phone,name,email})
});
if(!res.ok){
const err = await res.json();
throw new Error(err.detail || `HTTP ${res.status}`);
}
const data = await res.json();
setUserId(data.user_id);
setUserName(data.name || name || "");
setUserPhone(phone);
setUserEmail(data.email || email || "");

document.getElementById("loginBox").style.display="none";
document.getElementById("createBox").style.display="block";
document.getElementById("historyBox").style.display="block";

// enable drawer
const sidebar = document.getElementById("sidebar");
const backdrop = document.getElementById("backdrop");
sidebar.classList.remove("sidebar-hidden");
backdrop.classList.add("sidebar-hidden");
sidebar.classList.remove("open");
backdrop.classList.remove("show");

refreshUserDisplay();
loadVehicleHistory();
loadMyVouchers();
msg.textContent = "‚úÖ Login successful! Create your first voucher.";
msg.style.color = "#22c55e";
}catch(e){ 
msg.textContent = `‚ùå ${e.message}`;
msg.style.color = "#ef4444";
}
}

function saveVehicleHistory(vehicle){
const key = historyKey();
if (!key) return;
try {
let history = JSON.parse(localStorage.getItem(key) || "[]");
history.unshift(vehicle);
history = history.slice(0, 50); // Keep last 50 entries
localStorage.setItem(key, JSON.stringify(history));
} catch(e) {
console.error("Failed to save vehicle history:", e);
}
}

function loadVehicleHistory(){
const key = historyKey();
if (!key) return;
try {
const history = JSON.parse(localStorage.getItem(key) || "[]");
if(history.length > 0){
const last = history[0];
document.getElementById("vehicleType").value = last.vehicleType || "Car";
document.getElementById("vehicleNo").value = last.vehicleNo || "";
}
} catch(e) {
console.error("Failed to load vehicle history:", e);
}
}

async function createVoucher(){
const amountVal = document.getElementById("amount").value;
const litresVal = document.getElementById("litres").value;
const vehicleType = document.getElementById("vehicleType").value;
const vehicleNo = document.getElementById("vehicleNo").value.trim().toUpperCase();
const bunkId = document.getElementById("bunkSelect").value;
const userId = getUserId();

if(!amountVal && !litresVal){ 
alert("Please enter amount OR litres"); 
return; 
}
if(!vehicleNo || vehicleNo.length < 5){ 
alert("Please enter a valid vehicle number (min 5 chars)"); 
return; 
}

const msg = document.getElementById("msg");
msg.textContent = "‚ú® Creating your voucher...";
msg.style.color = "#6366f1";

try{
const res = await fetch(`${API}/create-voucher`,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
bunk_id: bunkId,
amount: amountVal ? Number(amountVal) : null,
litres: litresVal ? Number(litresVal) : null,
user_id: userId ? Number(userId) : null,
vehicle_type: vehicleType,
vehicle_no: vehicleNo
})
});
if(!res.ok){
const err = await res.json();
throw new Error(err.detail || `HTTP ${res.status}`);
}
const data = await res.json();
lastVoucherId = data.voucher_id;
razorpayOrderId = data.razorpay_order_id;
razorpayKeyId = data.razorpay_key_id;
currentVehicle = {
vehicleType, vehicleNo, 
amount: data.amount, 
litres: data.litres, 
bunk_id: bunkId, 
voucher_id: data.voucher_id
};

// Save to history immediately
saveVehicleHistory(currentVehicle);

document.getElementById("voucherDetails").innerHTML = `
<div style="font-size:18px; font-weight:800; color:#166534; margin-bottom:12px;">
${data.voucher_id}
</div>
<div style="display:grid; grid-template-columns:1fr auto; gap:20px; font-size:15px; color:#374151;">
<div>üí∞ ‚Çπ<strong>${data.amount?.toLocaleString() || 'TBD'}</strong></div>
<div>‚õΩ <strong>${data.litres || 'TBD'} L</strong></div>
</div>
<div style="font-size:14px; color:#64748b; margin-top:16px;">
${vehicleType} ${vehicleNo} ‚Ä¢ ${bunkName(bunkId)}
</div>
`;
document.getElementById("voucherIdDisplay").textContent = data.voucher_id;
document.getElementById("voucherBox").style.display = "block";
document.getElementById("qrSection").style.display = "none";
document.getElementById("qrContainer").innerHTML = "";
msg.textContent = "‚úÖ Voucher created! Tap Pay Now to complete.";
msg.style.color = "#22c55e";
}catch(e){ 
msg.textContent = `‚ùå ${e.message}`;
msg.style.color = "#ef4444";
}
}

function payNow(){
if(!razorpayOrderId || !razorpayKeyId){ 
alert("Please create voucher again."); 
return; 
}
const options = {
key: razorpayKeyId,
order_id: razorpayOrderId,
name: "FuelSkip",
description: `Fuel voucher ${lastVoucherId}`,
currency: "INR",
theme: {
color: "#22c55e"
},
redirect: false,
handler: function(response){
console.log("Payment successful:", response);
startPollingStatus();
},
modal: {
ondismiss: function(){
console.log("Payment modal dismissed");
}
}
};
const rzp = new Razorpay(options);
rzp.open();
}

function startPollingStatus(){
if(!lastVoucherId) return;
if(pollTimer) clearInterval(pollTimer);
pollTimer = setInterval(checkVoucherStatus, 2500);
document.getElementById("payBtn").textContent = "‚è≥ Processing payment...";
document.getElementById("payBtn").disabled = true;
}

async function checkVoucherStatus(){
if(!lastVoucherId) return;
try{
const res = await fetch(`${API}/voucher-status/${lastVoucherId}`);
if(!res.ok) return;
const data = await res.json();
if(data.status === "paid"){
clearInterval(pollTimer);
showQr();
loadMyVouchers();
document.getElementById("payBtn").style.display = "none";
}
}catch(e){ 
console.log("Poll error:", e); 
}
}

function showQr(){
document.getElementById("qrSection").style.display = "block";
const qrContainer = document.getElementById("qrContainer");
qrContainer.innerHTML = "";
const url = `https://fuelskip-production.up.railway.app/attendant.html?voucher=${encodeURIComponent(lastVoucherId)}`;
new QRCode(qrContainer, {
text: url,
width: 200,
height: 200,
colorDark: "#1e293b",
colorLight: "#f8fafc"
});
}

function statusBadge(status){
status = (status || "").toLowerCase();
const badges = {
"paid": '<span class="badge badge-paid">‚úÖ Paid</span>',
"used": '<span class="badge badge-used">‚úîÔ∏è Used</span>',
"failed": '<span class="badge badge-failed">‚ùå Failed</span>'
};
return badges[status] || '<span class="badge badge-pending">‚è≥ Pending</span>';
}

async function loadMyVouchers(){
const userId = getUserId();
const container = document.getElementById("myVouchers");
if(!userId){ 
container.innerHTML = '<div style="padding:24px; color:#64748b; font-weight:500;">Login to see your voucher history.</div>';
return; 
}
try{
const res = await fetch(`${API}/my-vouchers?user_id=${encodeURIComponent(userId)}`);
if(!res.ok){ 
container.innerHTML = '<div style="padding:24px; color:#ef4444;">Could not load vouchers.</div>';
return; 
}
const vouchers = await res.json();
if(!vouchers.length){ 
container.innerHTML = '<div style="padding:24px; color:#64748b;">No vouchers created yet. Create your first one above! üéâ</div>';
return; 
}
container.innerHTML = vouchers.map(v => `
<div class="history-item">
<div>
<div style="font-weight:700; font-size:15px; color:#1e293b; margin-bottom:4px;">
${v.id} ‚Ä¢ ‚Çπ${parseFloat(v.amount || 0).toLocaleString()} 
<span style="font-size:13px; color:#6366f1;">‚Ä¢ ${parseFloat(v.litres || 0).toFixed(1)} L</span>
</div>
<div style="font-size:13px; color:#64748b;">
${new Date(v.created_at).toLocaleDateString('en-IN', {weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'})}
</div>
</div>
<div style="min-width:80px;">${statusBadge(v.status)}</div>
</div>
`).join("");
}catch(e){ 
container.innerHTML = '<div style="padding:24px; color:#ef4444;">Error loading vouchers.</div>';
}
}

function loadAnalytics(){
const key = historyKey();
if (!key) return;
try {
const history = JSON.parse(localStorage.getItem(key) || "[]");
if(!history.length) return;

const totalSpend = history.reduce((sum, f) => sum + parseFloat(f.amount || 0), 0);
document.getElementById("dashTotalSpend").textContent = "‚Çπ" + totalSpend.toLocaleString();
document.getElementById("dashTotalFills").textContent = history.length;
document.getElementById("dashAvgFill").textContent = "‚Çπ" + Math.round(totalSpend / history.length);

const vehicleStats = {};
const bunkStats = {};
history.forEach(f => {
const vKey = `${f.vehicleType} ${f.vehicleNo}`;
const amt = parseFloat(f.amount || 0);
const lit = parseFloat(f.litres || 0);

vehicleStats[vKey] = (vehicleStats[vKey] || 0) + amt;

if(!bunkStats[f.bunk_id]) {
bunkStats[f.bunk_id] = {amount: 0, litres: 0, count: 0};
}
bunkStats[f.bunk_id].amount += amt;
bunkStats[f.bunk_id].litres += lit;
bunkStats[f.bunk_id].count += 1;
});

const topVehicle = Object.entries(vehicleStats)
.sort(([,a], [,b]) => b - a)[0];
document.getElementById("dashTopVehicle").textContent = topVehicle ? topVehicle[0] : "-";

const vehicleList = document.getElementById("vehicleList");
vehicleList.innerHTML = Object.entries(vehicleStats).length ? 
Object.entries(vehicleStats).map(([name, amt]) => `
<div class="history-item">
<div style="font-weight:600; color:#1e293b;">${name}</div>
<div style="font-weight:700; color:#6366f1;">‚Çπ${amt.toLocaleString()}</div>
</div>
`).join("") : 
'<div style="padding:24px; text-align:center; color:#64748b;">No vehicle data yet</div>';

const bunkList = document.getElementById("bunkList");
bunkList.innerHTML = Object.entries(bunkStats).length ? 
Object.entries(bunkStats).map(([id, stats]) => `
<div class="history-item">
<div>
<div style="font-weight:700; font-size:15px; color:#1e293b;">${bunkName(id)}</div>
<div style="font-size:13px; color:#64748b;">${id}</div>
</div>
<div style="text-align:right;">
<div style="font-weight:700; font-size:15px; color:#22c55e;">‚Çπ${stats.amount.toLocaleString()}</div>
<div style="font-size:13px; color:#64748b;">${stats.litres.toFixed(1)} L</div>
</div>
</div>
`).join("") : 
'<div style="padding:24px; text-align:center; color:#64748b;">No station data yet</div>';

} catch(e) {
console.error("Analytics load error:", e);
}
}

function loadProfile(){
const container = document.getElementById("profileInfo");
const uid = getUserId();
const name = localStorage.getItem("fuelskip_user_name") || "";
const phone = localStorage.getItem("fuelskip_user_phone") || "";
const email = getUserEmail();

if(!uid){
container.innerHTML = '<div style="padding:40px 24px; text-align:center; color:#64748b;">Login to view and manage your profile.</div>';
return;
}

container.innerHTML = `
<div style="display:grid; gap:24px; margin-bottom:28px;">
<div style="display:flex; flex-direction:column; gap:8px; padding:20px; background:#f8fafc; border-radius:16px;">
<div style="font-size:13px; color:#64748b; font-weight:600;">üë§ Name</div>
<div style="font-size:18px; font-weight:700; color:#1e293b;">${name || 'Not set'}</div>
</div>
<div style="display:flex; flex-direction:column; gap:8px; padding:20px; background:#f8fafc; border-radius:16px;">
<div style="font-size:13px; color:#64748b; font-weight:600;">üì± Phone</div>
<div style="font-size:18px; font-weight:700; color:#1e293b;">${phone || 'Not set'}</div>
</div>
<div style="display:flex; flex-direction:column; gap:8px; padding:20px; background:#f8fafc; border-radius:16px;">
<div style="font-size:13px; color:#64748b; font-weight:600;">üìß Email</div>
<div style="font-size:18px; font-weight:700; color:#1e293b;">${email || 'Not set'}</div>
</div>
</div>
<div style="text-align:center;">
<button onclick="openProfileEdit()" style="padding:16px 32px; font-size:16px; border-radius:14px; border:none; background:linear-gradient(135deg,#6366f1,#5856eb); color:white; font-weight:700; cursor:pointer; box-shadow:0 8px 25px rgba(99,102,241,0.3); transition:all 0.2s ease;">
‚úèÔ∏è Edit Profile
</button>
</div>
`;
}

function openProfileEdit(){
const nameOld = localStorage.getItem("fuelskip_user_name") || "";
const phoneOld = localStorage.getItem("fuelskip_user_phone") || "";
const emailOld = getUserEmail();

const nameNew = prompt("Update your name:", nameOld) || nameOld;
const phoneNew = prompt("Update your phone:", phoneOld) || phoneOld;
const emailNew = prompt("Update your email:", emailOld) || emailOld;

setUserName(nameNew.trim());
setUserPhone(phoneNew.replace(/\D/g,''));
setUserEmail(emailNew.trim());

refreshUserDisplay();
loadProfile();
}

// Enhanced initialization
window.addEventListener("load",()=>{
const sidebar = document.getElementById("sidebar");
const backdrop = document.getElementById("backdrop");

if(getUserId()){
sidebar.classList.remove("sidebar-hidden");
backdrop.classList.add("sidebar-hidden");
document.getElementById("loginBox").style.display = "none";
document.getElementById("createBox").style.display = "block";
document.getElementById("historyBox").style.display = "block";
refreshUserDisplay();
loadVehicleHistory();
loadMyVouchers();
loadAnalytics();
updateActiveMenu('create');
} else {
sidebar.classList.add("sidebar-hidden");
backdrop.classList.add("sidebar-hidden");
updateActiveMenu('create');
}

// Prevent zoom on iOS
document.addEventListener('touchstart', function(event) {
if (event.touches.length > 1) {
event.preventDefault();
}
});
});
</script>
</body>
</html>
