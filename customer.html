<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FuelSkip - Customer (Analytics + Flow)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Razorpay Checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      color: #333;
      line-height: 1.4;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: #f9fafb;
      border-radius: 16px;
      padding: 20px 0;
      box-shadow: 0 10px 30px rgba(15,23,42,0.15);
      margin-right: 16px;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px);
    }
    .sidebar-header {
      padding: 0 20px 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    .sidebar-header h2 {
      margin: 0 0 4px;
      font-size: 18px;
      color: #111827;
    }
    .sidebar-header small {
      font-size: 12px;
      color: #6b7280;
    }
    .sidebar-menu {
      list-style: none;
      padding: 8px 0;
      margin: 0;
      flex: 1;
    }
    .sidebar-menu li {
      margin-bottom: 2px;
    }
    .sidebar-menu a {
      display: block;
      padding: 10px 20px;
      font-size: 14px;
      color: #4b5563;
      text-decoration: none;
      border-left: 3px solid transparent;
    }
    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background: linear-gradient(90deg,#eef2ff,#e0f2fe);
      border-left-color: #6366f1;
      color: #1f2937;
    }
    .sidebar-footer {
      padding: 12px 20px 0;
      border-top: 1px solid #e5e7eb;
      font-size: 13px;
    }
    .sidebar-footer button {
      width: 100%;
      border: none;
      background: none;
      color: #b91c1c;
      text-align: left;
      padding: 8px 0;
      cursor: pointer;
      font-weight: 500;
    }

    /* Main container */
    .container {
      flex: 1;
      max-width: 520px;
      margin: 0 auto;
      background: rgba(255,255,255,0.95);
      border-radius: 20px;
      padding: 24px 24px 32px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    h1 {
      margin: 0;
      color: #111827;
      font-size: 22px;
    }

    .user-pill {
      font-size: 13px;
      color: #4b5563;
    }

    .card {
      background: rgba(255,255,255,0.9);
      border-radius: 15px;
      padding: 18px 18px 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid rgba(229,231,235,0.9);
    }

    .form-group { margin-bottom: 14px; }
    .label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
    }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99,102,241,0.4);
    }

    .vehicle-section {
      background: linear-gradient(135deg, #f9fafb, #eef2ff);
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 14px;
      border-left: 4px solid #6366f1;
    }
    .vehicle-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }
    button:active { transform: scale(0.98); }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      width: 100%;
      margin-top: 4px;
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, #16a34a, #15803d);
      box-shadow: 0 8px 18px rgba(22,163,74,0.3);
    }

    .badge { padding: 3px 8px; border-radius: 999px; font-size:11px; font-weight:500; }
    .badge-pending { background:#fef3c7; color:#92400e; }
    .badge-paid { background:#dcfce7; color:#166534; }
    .badge-used { background:#e5e7eb; color:#374151; }
    .badge-failed { background:#fee2e2; color:#b91c1c; }

    .history-item {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 0;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }

    #voucherBox { display: none; }
    #qrContainer { margin-top: 10px; display:flex; justify-content:center; }

    .expense-tracker {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      padding: 14px;
      border-radius: 12px;
      text-align: center;
      margin-top: 6px;
    }
    .expense-tracker .total-expense {
      font-size: 18px;
      font-weight: 700;
      color:#b91c1c;
      margin: 4px 0;
    }

    /* Analytics sections (hidden by default) */
    .page-section { display: none; }
    .page-section.active { display: block; }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
        padding: 10px;
      }
    
      .sidebar {
        width: 100%;
        height: auto;
        margin: 0 0 10px 0;
        border-radius: 16px;
      }
    
      .container {
        width: 100%;
        max-width: 100%;
        margin: 0;
        padding: 16px 12px 24px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      }
    }

      }
    }
  </style>
</head>
<body>

  <!-- LEFT ANALYTICS SIDEBAR (hidden before login) -->
  <aside class="sidebar" id="sidebar" style="display:none;">
    <div class="sidebar-header">
      <h2>üìä Analytics</h2>
      <small id="sidebarUser">Not logged in</small>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" id="navDashboard" onclick="openSection('dashboard');return false;">Dashboard</a></li>
      <li><a href="#" id="navVehicles" onclick="openSection('vehicles');return false;">Vehicles</a></li>
      <li><a href="#" id="navBunks" onclick="openSection('bunks');return false;">Bunks</a></li>
      <li><a href="#" id="navProfile" onclick="openSection('profile');return false;">Profile</a></li>
    </ul>
    <div class="sidebar-footer">
      <button onclick="openSection('create')">+ Create Voucher</button>
      <button onclick="logout()">Logout</button>
    </div>
  </aside>

  <!-- MAIN FLOW CONTAINER -->
  <div class="container">
    <div class="header">
      <h1>üöó FuelSkip</h1>
      <div class="user-pill" id="userDisplay"></div>
    </div>

    <!-- 1) LOGIN + CREATE VOUCHER FLOW (DEFAULT) -->
    <div id="create" class="page-section active">
      <!-- Login -->
      <div class="card" id="loginBox">
        <h3>üëã Get started</h3>
        <div class="form-group">
          <span class="label">Phone number</span>
          <input id="phone" type="tel" placeholder="98XXXXXXXX">
        </div>
        <div class="form-group">
          <span class="label">Name (optional)</span>
          <input id="name" placeholder="Your name">
        </div>
        <div class="form-group">
          <span class="label">Email (optional)</span>
          <input id="email" type="email" placeholder="you@gmail.com">
        </div>
        <button class="btn-primary" onclick="login()">Continue</button>
      </div>

      <!-- Create voucher -->
      <div class="card" id="createBox" style="display:none;">
        <h3>‚ûï Create voucher</h3>

        <div class="vehicle-section">
          <strong style="font-size:13px;">Vehicle</strong>
          <div class="vehicle-grid" style="margin-top:8px;">
            <div class="form-group">
              <span class="label">Type</span>
              <select id="vehicleType">
                <option value="Bike">üèçÔ∏è Bike</option>
                <option value="Car">üöó Car</option>
                <option value="Auto">üõ∫ Auto</option>
                <option value="Truck">üöõ Truck</option>
                <option value="Other">üöô Other</option>
              </select>
            </div>
            <div class="form-group">
              <span class="label">Number</span>
              <input id="vehicleNo" type="text" placeholder="AP05AB1234">
            </div>
          </div>
        </div>

        <div class="form-group">
          <span class="label">Select bunk</span>
          <select id="bunkSelect">
            <option value="BUNK-1">BPCL Siripuram</option>
            <option value="BUNK-2">Gajuwaka Expressway</option>
          </select>
        </div>

        <div class="form-group">
          <span class="label">Amount (‚Çπ)</span>
          <input id="amount" type="number" min="50" placeholder="500">
        </div>
        <div class="form-group">
          <span class="label">OR litres</span>
          <input id="litres" type="number" min="5" step="0.1" placeholder="25">
        </div>

        <button class="btn-primary" onclick="createVoucher()">Create voucher</button>
        <p id="msg" style="font-size:12px; color:#6b7280; margin-top:6px; text-align:center;"></p>
      </div>

      <!-- Voucher + Pay now + QR -->
      <div class="card" id="voucherBox">
        <h3>‚úÖ Voucher</h3>
        <div id="voucherDetails" style="font-size:14px; margin-bottom:10px; padding:8px 10px; background:#ecfdf5; border-radius:10px;"></div>
        <button class="btn-primary" id="payBtn" onclick="payNow()">üí≥ Pay now</button>
        <div id="qrSection" style="display:none; margin-top:12px;">
          <p style="font-size:13px; text-align:center; margin-bottom:8px;">Show this QR to attendant</p>
          <div id="qrContainer"></div>
          <p style="text-align:center; font-size:12px; margin-top:8px;">Voucher ID: <strong id="voucherIdDisplay"></strong></p>
        </div>
      </div>

      <!-- Simple tracker below (same vehicle) -->
      <div class="card" id="expenseTracker" style="display:none;">
        <div class="expense-tracker">
          <h4 style="margin:0;">Vehicle tracker</h4>
          <p class="total-expense" id="totalExpense">‚Çπ0</p>
          <p id="recentFills" style="font-size:12px; margin:4px 0 0;">No fills yet</p>
        </div>
      </div>

      <!-- History -->
      <div class="card" id="historyBox" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0;">My vouchers</h3>
          <button style="width:auto; padding:6px 10px; font-size:12px; background:#2563eb; color:white; border-radius:8px;" onclick="loadMyVouchers()">‚ü≤ Refresh</button>
        </div>
        <div id="myVouchers" style="font-size:13px; color:#4b5563;">Login to see history.</div>
      </div>
    </div>

    <!-- 2) ANALYTICS PAGES (OPEN ONLY FROM LEFT) -->

    <div id="dashboard" class="page-section">
      <h3>Your Fuel Analytics</h3>
      <div class="card">
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;">
          <div class="expense-tracker" style="background:linear-gradient(135deg,#eef2ff,#e0e7ff); border:none;">
            <div style="font-size:10px; text-transform:uppercase;">Total Spend</div>
            <div class="total-expense" id="dashTotalSpend">‚Çπ0</div>
          </div>
          <div class="expense-tracker" style="background:linear-gradient(135deg,#e0f2fe,#bfdbfe); border:none;">
            <div style="font-size:10px; text-transform:uppercase;">Total Fills</div>
            <div class="total-expense" id="dashTotalFills">0</div>
          </div>
          <div class="expense-tracker" style="background:linear-gradient(135deg,#dcfce7,#bbf7d0); border:none;">
            <div style="font-size:10px; text-transform:uppercase;">Avg Fill</div>
            <div class="total-expense" id="dashAvgFill">‚Çπ0</div>
          </div>
        </div>
        <p style="font-size:12px; margin-top:10px;">Top vehicle: <strong id="dashTopVehicle">-</strong></p>
      </div>
    </div>

    <div id="vehicles" class="page-section">
      <h3>Vehicles</h3>
      <div id="vehicleList" class="card" style="font-size:13px; color:#4b5563;">No data yet.</div>
    </div>

    <div id="bunks" class="page-section">
      <h3>Bunks</h3>
      <div id="bunkList" class="card" style="font-size:13px; color:#4b5563;">No data yet.</div>
    </div>

    <div id="profile" class="page-section">
      <h3>Profile</h3>
      <div id="profileInfo" class="card" style="font-size:13px; color:#4b5563;">Login to view profile.</div>
    </div>

  </div>

<script>
const API = "https://fuelskip-production.up.railway.app";

let lastVoucherId = null;
let razorpayOrderId = null;
let razorpayKeyId = null;
let pollTimer = null;
let currentVehicle = null;

function getUserId(){ return localStorage.getItem("fuelskip_user_id"); }
function setUserId(id){ localStorage.setItem("fuelskip_user_id", id); }
function setUserName(n){ localStorage.setItem("fuelskip_user_name", n || ""); }
function setUserPhone(p){ localStorage.setItem("fuelskip_user_phone", p || ""); }
function setUserEmail(e){ localStorage.setItem("fuelskip_user_email", e || ""); }
function getUserEmail(){ return localStorage.getItem("fuelskip_user_email") || ""; }

function historyKey(){
  const uid = getUserId();
  return uid ? `fuelskip_vehicle_history_${uid}` : null;
}

// bunk id -> display name
const BUNK_NAMES = {
  "BUNK-1": "BPCL Siripuram",
  "BUNK-2": "Gajuwaka Expressway"
};
function bunkName(id){
  return BUNK_NAMES[id] || id || "Unknown bunk";
}

function refreshUserDisplay(){
  const n = localStorage.getItem("fuelskip_user_name") || "";
  const p = localStorage.getItem("fuelskip_user_phone") || "";
  document.getElementById("userDisplay").textContent = p ? (n ? `${n} (${p})` : p) : "";
  document.getElementById("sidebarUser").textContent = p ? (n ? `${n} ‚Ä¢ ${p}` : p) : "Not logged in";
}

function openSection(id){
  document.querySelectorAll(".page-section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id === "profile"){
    loadProfile();
  } else if(id !== "create"){
    loadAnalytics();
  }
}

function logout(){
  localStorage.removeItem("fuelskip_user_id");
  localStorage.removeItem("fuelskip_user_name");
  localStorage.removeItem("fuelskip_user_phone");
  localStorage.removeItem("fuelskip_user_email");

  document.getElementById("phone").value="";
  document.getElementById("name").value="";
  document.getElementById("email").value="";
  document.getElementById("amount").value="";
  document.getElementById("litres").value="";
  document.getElementById("vehicleNo").value="";

  document.getElementById("loginBox").style.display="block";
  document.getElementById("createBox").style.display="none";
  document.getElementById("voucherBox").style.display="none";
  document.getElementById("historyBox").style.display="none";
  document.getElementById("expenseTracker").style.display="none";

  document.getElementById("sidebar").style.display="none";

  openSection("create");
  refreshUserDisplay();
  if(pollTimer) clearInterval(pollTimer);
}

async function login(){
  const phone=document.getElementById("phone").value.trim();
  const name=document.getElementById("name").value.trim() || null;
  const email=document.getElementById("email").value.trim() || null;
  if(!phone){ alert("Enter phone"); return; }
  try{
    const res=await fetch(`${API}/login`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({phone,name,email})
    });
    if(!res.ok){
      const err=await res.json();
      alert("Login failed: "+(err.detail||res.status));
      return;
    }
    const data=await res.json();
    setUserId(data.user_id);
    setUserName(data.name || name || "");
    setUserPhone(data.phone || phone || "");
    setUserEmail(data.email || email || "");

    document.getElementById("loginBox").style.display="none";
    document.getElementById("createBox").style.display="block";
    document.getElementById("historyBox").style.display="block";
    document.getElementById("expenseTracker").style.display="block";

    document.getElementById("sidebar").style.display="flex";

    refreshUserDisplay();
    loadVehicleHistory();
    loadMyVouchers();
  }catch(e){ alert("Error: "+e.message); }
}

function loadVehicleHistory(){
  const key = historyKey();
  if (!key) return;
  const history = JSON.parse(localStorage.getItem(key) || "[]");
  if(history.length>0){
    const last=history[0];
    document.getElementById("vehicleType").value=last.vehicleType||"Car";
    document.getElementById("vehicleNo").value=last.vehicleNo||"";
    updateExpenseTracker(last.vehicleNo);
  } else {
    document.getElementById("vehicleNo").value="";
    document.getElementById("totalExpense").textContent="‚Çπ0";
    document.getElementById("recentFills").textContent="No fills yet";
  }
}

function updateExpenseTracker(vehicleNo=null){
  const key = historyKey();
  if (!key) return;
  const history = JSON.parse(localStorage.getItem(key) || "[]");
  const fills=vehicleNo?history.filter(f=>f.vehicleNo===vehicleNo):history;
  const total=fills.reduce((s,f)=>s+(parseFloat(f.amount)||0),0);
  document.getElementById("totalExpense").textContent="‚Çπ"+total.toLocaleString();
  const recent=fills.slice(-5).reverse().map(f=>`‚Çπ${f.amount} (${new Date(f.timestamp).toLocaleDateString("en-IN")})`).join(", ");
  document.getElementById("recentFills").textContent=recent||"No fills yet";
}

function saveVehicleFill(v){
  const key = historyKey();
  if (!key) return;
  const history = JSON.parse(localStorage.getItem(key) || "[]");
  history.unshift({
    vehicleType:v.vehicleType,
    vehicleNo:v.vehicleNo,
    amount:v.amount,
    litres:v.litres,
    voucherId:v.voucher_id,
    bunkId:v.bunk_id,
    timestamp:new Date().toISOString()
  });
  localStorage.setItem(key,JSON.stringify(history.slice(0,200)));
  updateExpenseTracker(v.vehicleNo);
}

async function createVoucher(){
  const amountVal=document.getElementById("amount").value;
  const litresVal=document.getElementById("litres").value;
  const vehicleType=document.getElementById("vehicleType").value;
  const vehicleNo=document.getElementById("vehicleNo").value.trim();
  const bunkId=document.getElementById("bunkSelect").value;
  const userId=getUserId();

  if(!amountVal && !litresVal){ alert("Enter amount or litres"); return; }
  if(!vehicleNo){ alert("Enter vehicle number"); return; }

  const msg=document.getElementById("msg");
  msg.textContent="Creating voucher...";

  try{
    const res=await fetch(`${API}/create-voucher`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        bunk_id:bunkId,
        amount:amountVal?Number(amountVal):null,
        litres:litresVal?Number(litresVal):null,
        user_id:userId?Number(userId):null,
        vehicle_type:vehicleType,
        vehicle_no:vehicleNo
      })
    });
    if(!res.ok){
      const err=await res.json();
      msg.textContent="Error: "+(err.detail||res.status);
      return;
    }
    const data=await res.json();
    lastVoucherId=data.voucher_id;
    razorpayOrderId=data.razorpay_order_id;
    razorpayKeyId=data.razorpay_key_id;
    currentVehicle={vehicleType,vehicleNo,amount:data.amount,litres:data.litres,bunk_id:bunkId,voucher_id:data.voucher_id};

    document.getElementById("voucherDetails").innerHTML=
      `<strong>${data.voucher_id}</strong><br>`+
      `‚Çπ${data.amount} ‚Ä¢ ${data.litres} L<br>`+
      `${vehicleType} ${vehicleNo}`;
    document.getElementById("voucherIdDisplay").textContent=data.voucher_id;
    document.getElementById("voucherBox").style.display="block";
    document.getElementById("qrSection").style.display="none";
    document.getElementById("qrContainer").innerHTML="";
    msg.textContent="Tap Pay now to complete payment.";
  }catch(e){ msg.textContent="Error: "+e.message; }
}

function payNow(){
  if(!razorpayOrderId || !razorpayKeyId){ alert("Create voucher again."); return; }
  const options={
    key:razorpayKeyId,
    order_id:razorpayOrderId,
    name:"FuelSkip",
    description:`Fuel voucher ${lastVoucherId}`,
    redirect:false,
    handler:function(){ startPollingStatus(); }
  };
  new Razorpay(options).open();
}

function startPollingStatus(){
  if(!lastVoucherId)return;
  if(pollTimer)clearInterval(pollTimer);
  pollTimer=setInterval(checkVoucherStatus,3000);
}

async function checkVoucherStatus(){
  if(!lastVoucherId)return;
  try{
    const res=await fetch(`${API}/voucher-status/${lastVoucherId}`);
    if(!res.ok)return;
    const data=await res.json();
    if(data.status==="paid"){
      clearInterval(pollTimer);
      showQr();
      loadMyVouchers();
      if(currentVehicle) saveVehicleFill(currentVehicle);
    }
  }catch(e){ console.log("poll error",e); }
}

function showQr(){
  document.getElementById("qrSection").style.display="block";
  const qrContainer=document.getElementById("qrContainer");
  qrContainer.innerHTML="";
  const url=`https://fuelskip-production.up.railway.app/attendant.html?voucher=${encodeURIComponent(lastVoucherId)}`;
  new QRCode(qrContainer,{text:url,width:180,height:180});
}

function statusBadge(status){
  status=(status||"").toLowerCase();
  if(status==="paid")return '<span class="badge badge-paid">Paid</span>';
  if(status==="used")return '<span class="badge badge-used">Used</span>';
  if(status==="failed")return '<span class="badge badge-failed">Failed</span>';
  return '<span class="badge badge-pending">Pending</span>';
}

async function loadMyVouchers(){
  const userId=getUserId();
  const c=document.getElementById("myVouchers");
  if(!userId){ c.textContent="Login to see history."; return; }
  try{
    const res=await fetch(`${API}/my-vouchers?user_id=${encodeURIComponent(userId)}`);
    if(!res.ok){ c.textContent="Could not load history."; return; }
    const v=await res.json();
    if(!v.length){ c.textContent="No vouchers yet."; return; }
    c.innerHTML=v.map(x=>`
      <div class="history-item">
        <div>
          <div><strong>${x.id}</strong> ‚Ä¢ ‚Çπ${x.amount} ‚Ä¢ ${x.litres} L</div>
          <div style="font-size:11px; color:#9ca3af;">${x.created_at||""}</div>
        </div>
        <div>${statusBadge(x.status)}</div>
      </div>`).join("");
  }catch(e){ c.textContent="Error loading history."; }
}

function loadAnalytics(){
  const key = historyKey();
  if (!key) return;
  const history=JSON.parse(localStorage.getItem(key)||"[]");
  if(!history.length)return;

  const total=history.reduce((s,f)=>s+(parseFloat(f.amount)||0),0);
  document.getElementById("dashTotalSpend").textContent="‚Çπ"+total.toLocaleString();
  document.getElementById("dashTotalFills").textContent=history.length;
  document.getElementById("dashAvgFill").textContent="‚Çπ"+(total/history.length).toFixed(0);

  const vehicleStats={};
  const bunkStats={};
  history.forEach(f=>{
    const vKey=`${f.vehicleType} ${f.vehicleNo}`;
    const amt=parseFloat(f.amount||0);
    const lit=parseFloat(f.litres||0);

    vehicleStats[vKey]=(vehicleStats[vKey]||0)+amt;

    if(!bunkStats[f.bunkId]) bunkStats[f.bunkId]={amount:0,litres:0};
    bunkStats[f.bunkId].amount += amt;
    bunkStats[f.bunkId].litres += lit;
  });
  const topVehicle=Object.entries(vehicleStats).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById("dashTopVehicle").textContent=topVehicle?topVehicle[0]:"-";

  const vehicleList=document.getElementById("vehicleList");
  vehicleList.innerHTML=Object.entries(vehicleStats).map(([name,val])=>`
    <div class="history-item">
      <div>${name}</div>
      <div>‚Çπ${val.toLocaleString()}</div>
    </div>`).join("");

  const bunkList=document.getElementById("bunkList");
  bunkList.innerHTML=Object.entries(bunkStats).map(([id,stat])=>`
    <div class="history-item">
      <div>
        <div style="font-weight:600;">${bunkName(id)}</div>
        <div style="font-size:11px; color:#9ca3af;">${id}</div>
      </div>
      <div style="text-align:right;">
        <div>‚Çπ${stat.amount.toLocaleString()}</div>
        <div style="font-size:11px; color:#9ca3af;">${stat.litres.toFixed(1)} L</div>
      </div>
    </div>`).join("");
}

function loadProfile(){
  const c = document.getElementById("profileInfo");
  const uid   = getUserId();
  const name  = localStorage.getItem("fuelskip_user_name")  || "";
  const phone = localStorage.getItem("fuelskip_user_phone") || "";
  const email = getUserEmail();

  if(!uid){
    c.innerHTML = '<div style="padding:20px; font-size:13px; color:#6b7280;">Login to view profile.</div>';
    return;
  }

  c.innerHTML = `
    <div style="padding:20px; display:flex; flex-direction:column; gap:12px;">
      <div>
        <div style="font-size:12px; color:#9ca3af;">Name</div>
        <div style="font-size:15px; font-weight:600; color:#111827;">${name || '-'}</div>
      </div>
      <div>
        <div style="font-size:12px; color:#9ca3af;">Phone</div>
        <div style="font-size:15px; font-weight:600; color:#111827;">${phone || '-'}</div>
      </div>
      <div>
        <div style="font-size:12px; color:#9ca3af;">Email</div>
        <div style="font-size:15px; font-weight:600; color:#111827;">${email || '-'}</div>
      </div>
      <button onclick="openProfileEdit()" style="margin-top:8px; padding:10px 14px; border-radius:10px; border:none; background:#2563eb; color:white; font-weight:600; cursor:pointer;">
        Edit profile
      </button>
    </div>
  `;
}

function openProfileEdit(){
  const nameOld  = localStorage.getItem("fuelskip_user_name")  || "";
  const phoneOld = localStorage.getItem("fuelskip_user_phone") || "";
  const emailOld = getUserEmail();

  const nameNew  = prompt("Enter name",  nameOld);
  if(nameNew === null) return;
  const phoneNew = prompt("Enter phone", phoneOld);
  if(phoneNew === null) return;
  const emailNew = prompt("Enter email", emailOld);

  setUserName(nameNew);
  setUserPhone(phoneNew);
  setUserEmail(emailNew);

  refreshUserDisplay();
  loadProfile();
}

window.addEventListener("load",()=>{
  if(getUserId()){
    document.getElementById("sidebar").style.display="flex";
    document.getElementById("loginBox").style.display="none";
    document.getElementById("createBox").style.display="block";
    document.getElementById("historyBox").style.display="block";
    document.getElementById("expenseTracker").style.display="block";
    refreshUserDisplay();
    loadVehicleHistory();
    loadMyVouchers();
  } else {
    document.getElementById("sidebar").style.display="none";
  }
});
</script>
</body>
</html>

