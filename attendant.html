<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FuelSkip – Attendant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; padding: 16px;
      background: #0f172a;
      display: flex; justify-content: center;
    }
    .wrap { width: 100%; max-width: 420px; }
    h2 { margin: 0 0 16px 0; color: #e5e7eb; text-align: center; }

    .box {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      margin-top: 12px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.25);
    }

    .input-row {
      display: flex; gap: 8px; align-items: center;
    }

    input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      font-size: 14px;
    }

    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.15s ease;
    }

    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-blue   { background: #3b82f6; color: #fff; }
    .btn-green  { background: #10b981; color: #fff; width: 100%; margin-top: 10px; }
    .btn-red    { background: #ef4444; color: #fff; }
    .btn-dark   { background: #111827; color: #fff; }

    .status-chip {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
    }
    .paid { background: #16a34a; }
    .used { background: #6b7280; }
    .pend { background: #f97316; }
    .bad  { background: #ef4444; }

    #voucherData p {
      margin: 4px 0;
      font-size: 14px;
      color: #374151;
    }
    #voucherData strong { color: #111827; }

    #statusMsg {
      margin-top: 10px;
      font-size: 14px;
      font-weight: 600;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h2>⛽ FuelSkip – Attendant</h2>

  <!-- INPUT -->
  <div class="box">
    <div class="input-row">
      <input id="voucherInput" placeholder="Paste voucher ID or scan QR">
      <button class="btn-blue" onclick="loadVoucher()">Check</button>
    </div>

    <p style="margin:8px 0 0;font-size:12px;color:#6b7280;">
      Tip: Scan customer QR — voucher + signature auto-loads.
    </p>

    <!-- TOKEN CONTROLS -->
    <div style="margin-top:10px;display:flex;gap:8px;">
      <button class="btn-red" onclick="resetToken()">Reset Token</button>
      <button class="btn-dark" onclick="setToken()">Set Token</button>
    </div>

    <p style="margin:8px 0 0;font-size:12px;color:#94a3b8;">
      Use Reset if you see “Unauthorized”.
    </p>
  </div>

  <!-- VOUCHER DETAILS -->
  <div class="box" id="voucherInfo" style="display:none;">
    <h3 style="margin:0 0 8px 0;">Voucher Details</h3>
    <div id="voucherData"></div>
    <div id="statusMsg"></div>
    <button id="dispenseBtn" class="btn-green" onclick="validateAndDispense()" style="display:none;">
      ✅ Dispense Fuel
    </button>
  </div>
</div>

<script>
const API = window.location.origin;

let currentVoucherId = null;
let currentSig = "";

/* ---------- TOKEN HANDLING ---------- */
function getAttendantToken() {
  let tok = localStorage.getItem("FUELSKIP_ATTENDANT_TOKEN");
  if (!tok) {
    tok = prompt("Enter Attendant Token:");
    if (tok) localStorage.setItem("FUELSKIP_ATTENDANT_TOKEN", tok.trim());
  }
  return tok ? tok.trim() : "";
}

function resetToken() {
  localStorage.removeItem("FUELSKIP_ATTENDANT_TOKEN");
  alert("Attendant token cleared. Tap Set Token to enter again.");
}

function setToken() {
  const tok = prompt("Enter Attendant Token:");
  if (tok) {
    localStorage.setItem("FUELSKIP_ATTENDANT_TOKEN", tok.trim());
    alert("Token saved.");
  }
}

/* ---------- URL PARAMS ---------- */
function getParams() {
  const p = new URLSearchParams(window.location.search);
  return {
    voucher: p.get("voucher") || "",
    sig: p.get("sig") || ""
  };
}

window.addEventListener("load", () => {
  const p = getParams();
  if (p.voucher) {
    document.getElementById("voucherInput").value = p.voucher;
    currentSig = p.sig || "";
    loadVoucher();
  }
});

/* ---------- UI HELPERS ---------- */
function statusChip(status, used) {
  if (used) return '<span class="status-chip used">USED</span>';
  if (status === "paid") return '<span class="status-chip paid">PAID</span>';
  if (status === "pending") return '<span class="status-chip pend">PENDING</span>';
  return '<span class="status-chip bad">INVALID</span>';
}

/* ---------- LOAD VOUCHER ---------- */
async function loadVoucher() {
  const id = document.getElementById("voucherInput").value.trim();
  if (!id) return alert("Enter voucher ID");

  const p = getParams();
  if (p.voucher === id) currentSig = p.sig || currentSig;

  const box = document.getElementById("voucherInfo");
  const data = document.getElementById("voucherData");
  const msg = document.getElementById("statusMsg");
  const btn = document.getElementById("dispenseBtn");

  box.style.display = "none";
  btn.style.display = "none";
  msg.textContent = "";

  try {
    const res = await fetch(`${API}/voucher/${id}`);
    if (!res.ok) throw new Error("Voucher not found");

    const v = await res.json();
    currentVoucherId = id;

    data.innerHTML = `
      <p><strong>ID:</strong> ${v.id}</p>
      <p><strong>Customer:</strong> ${v.user_name || "Walk-in"} (${v.user_phone || "-"})</p>
      <p><strong>Amount:</strong> ₹${v.amount}</p>
      <p><strong>Litres:</strong> ${v.litres} L</p>
      <p><strong>Vehicle:</strong> ${v.vehicle_type || "-"} • ${v.vehicle_no || "-"}</p>
      <p><strong>Status:</strong> ${statusChip(v.status, v.used)}</p>
      <p><strong>QR Signature:</strong>
        ${currentSig ? "<span style='color:#16a34a'>OK</span>" :
                       "<span style='color:#ef4444'>MISSING</span>"}
      </p>
    `;

    box.style.display = "block";

    if (v.status === "paid" && !v.used) {
      if (!currentSig) {
        msg.innerHTML = "❌ QR signature missing. Scan customer QR.";
        return;
      }
      msg.innerHTML = "✅ Ready to dispense.";
      btn.style.display = "block";
      btn.disabled = false;
    } else if (v.used) {
      msg.innerHTML = "⚠️ Voucher already used.";
    } else {
      msg.innerHTML = "⏳ Payment pending or failed.";
    }
  } catch (e) {
    alert(e.message);
  }
}

/* ---------- VALIDATE & DISPENSE ---------- */
async function validateAndDispense() {
  const btn = document.getElementById("dispenseBtn");
  const msg = document.getElementById("statusMsg");

  btn.disabled = true;
  btn.textContent = "⏳ Validating...";

  try {
    const res = await fetch(
      `${API}/validate/${currentVoucherId}?sig=${encodeURIComponent(currentSig)}`,
      {
        method: "POST",
        headers: {
          "X-ATTENDANT-TOKEN": getAttendantToken()
        }
      }
    );

    const data = await res.json();

    if (!res.ok) throw new Error(data.detail || "Unauthorized");

    if (data.already_used) {
      msg.innerHTML = "⚠️ Already used.";
      btn.textContent = "✔️ Used";
    } else {
      msg.innerHTML = "✅ Fuel Dispensed";
      btn.textContent = "✔️ Dispensed";
    }
  } catch (e) {
    msg.innerHTML = `❌ ${e.message}`;
    btn.disabled = false;
    btn.textContent = "✅ Dispense Fuel";
  }
}
</script>
</body>
</html>
