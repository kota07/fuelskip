<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FuelSkip - Attendant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0; padding: 16px;
      background: #0f172a;
      display: flex; justify-content: center;
    }
    .wrap { width: 100%; max-width: 420px; }
    h2 { margin: 0 0 16px 0; color: #e5e7eb; text-align: center; }

    .card {
      background: #ffffff;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.25);
      margin-bottom: 12px;
    }

    .row { display: flex; gap: 10px; align-items: center; }
    .row + .row { margin-top: 10px; }
    .space { justify-content: space-between; }
    .muted { color:#6b7280; font-size: 12px; line-height: 1.35; margin: 8px 0 0; }

    input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #d4d4d8;
      font-size: 15px;
    }
    input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59,130,246,0.25);
    }

    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.12s ease;
    }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn-dark { background:#111827; color:#fff; width:100%; }
    .btn-blue { background:#3b82f6; color:#fff; }
    .btn-red { background:#ef4444; color:#fff; }
    .btn-green { background:#10b981; color:#fff; width:100%; }
    .btn-gray { background:#6b7280; color:#fff; width:100%; }

    .pill {
      display:inline-block; padding: 4px 10px; border-radius:999px;
      font-size: 11px; font-weight: 900; letter-spacing:0.04em;
      text-transform: uppercase;
    }
    .p-ok { background:#dcfce7; color:#166534; }
    .p-bad { background:#fee2e2; color:#991b1b; }

    .kv p { margin: 6px 0; font-size: 14px; color:#374151; }
    .kv strong { color:#111827; }

    /* Modal scanner */
    .modal {
      position: fixed; inset: 0;
      background: rgba(2,6,23,0.55);
      display: none; align-items: flex-end; justify-content: center;
      padding: 14px;
      z-index: 999;
    }
    .sheet {
      width: 100%; max-width: 520px;
      background: #fff;
      border-radius: 18px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(2,6,23,0.45);
    }
    .sheet-head {
      background:#111827; color:#fff;
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      font-weight: 900;
    }
    .sheet-body { padding: 12px 14px; }
    video {
      width: 100%;
      background: #0b1220;
      border-radius: 14px;
    }
    .tip { font-size: 12px; color:#6b7280; margin-top: 8px; }
    .closeBtn { background:#ef4444; color:#fff; padding: 10px 12px; border-radius: 12px; }

    .divider { height:1px; background:#e5e7eb; margin: 12px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>‚õΩ FuelSkip ‚Äì Attendant</h2>

    <!-- Pair status -->
    <div class="card">
      <div class="row space">
        <div style="font-weight:900; font-size:16px;">
          Device:
          <span id="pairPill" class="pill p-bad">NOT PAIRED</span>
        </div>
        <button class="btn-red" id="resetBtn">Reset</button>
      </div>
      <div class="muted" id="pairInfo">
        Pair once using Owner QR (contains <b>dt=...</b>). After that, scan voucher QR inside this page (don‚Äôt open new tabs).
      </div>

      <div class="row" style="margin-top:12px; gap:10px;">
        <button class="btn-dark" id="scanPairBtn">üîó Scan Owner Pair QR</button>
        <button class="btn-dark" id="scanVoucherBtn">üì∑ Scan Voucher QR</button>
      </div>

      <div class="muted" id="originLine" style="margin-top:10px;"></div>
    </div>

    <!-- Manual + Check -->
    <div class="card">
      <div class="row" style="gap:10px;">
        <input id="voucherInput" placeholder="Paste voucher ID or scan QR" />
        <button class="btn-blue" id="checkBtn">Check</button>
      </div>
      <div class="muted">
        Supports both formats:
        <br/>‚Ä¢ Compact: <b>voucherId|sig</b>
        <br/>‚Ä¢ URL: <b>.../attendant.html?voucher=...&sig=...</b>
      </div>
    </div>

    <!-- Voucher details -->
    <div class="card" id="voucherCard" style="display:none;">
      <div style="font-weight:900; font-size:18px; color:#111827;">Voucher Details</div>
      <div class="divider"></div>
      <div class="kv" id="voucherKV"></div>
      <div id="statusMsg" style="margin-top:10px; font-size:15px;"></div>
      <button id="dispenseBtn" class="btn-green" style="display:none; margin-top:12px;">‚úÖ Dispense Fuel</button>
    </div>
  </div>

  <!-- Scanner modal -->
  <div class="modal" id="scannerModal">
    <div class="sheet">
      <div class="sheet-head">
        <div id="scannerTitle">Scan QR</div>
        <button class="closeBtn" id="closeScanner">Close</button>
      </div>
      <div class="sheet-body">
        <div class="muted" id="scannerHint" style="margin-top:0;">
          Point camera at QR‚Ä¶
        </div>
        <div style="margin-top:10px;">
          <video id="video" autoplay playsinline></video>
        </div>
        <div class="tip" id="scannerTip">
          Tip: Use Home Screen app (PWA) for stable camera + pairing.
        </div>
      </div>
    </div>
  </div>

<script>
  const API = window.location.origin; // same origin (Railway)
  const LS_DEVICE = "FUELSKIP_DEVICE_TOKEN";

  let deviceToken = localStorage.getItem(LS_DEVICE) || "";
  let currentVoucherId = null;
  let currentSig = null;

  const elPairPill = document.getElementById("pairPill");
  const elOriginLine = document.getElementById("originLine");
  const elResetBtn = document.getElementById("resetBtn");

  const modal = document.getElementById("scannerModal");
  const video = document.getElementById("video");
  const scannerTitle = document.getElementById("scannerTitle");
  const scannerHint = document.getElementById("scannerHint");

  let stream = null;
  let scanMode = "voucher"; // "pair" | "voucher"
  let detector = null;
  let scanTimer = null;

  function setPairedUI() {
    const paired = !!deviceToken;
    elPairPill.className = "pill " + (paired ? "p-ok" : "p-bad");
    elPairPill.textContent = paired ? "PAIRED" : "NOT PAIRED";
    elOriginLine.innerHTML =
      `Origin: <b>${location.origin}</b> ‚Ä¢ Token: <b>${paired ? (deviceToken.slice(0,8) + "‚Ä¶") : "‚Äî"}</b>`;
  }

  // --- Parse QR / input text ---
  function parsePayload(text) {
    const t = (text || "").trim();
    if (!t) return { voucher: null, sig: null, dt: null };

    // 1) compact: voucher|sig
    if (t.includes("|") && !t.includes("http")) {
      const parts = t.split("|").map(x => x.trim()).filter(Boolean);
      return { voucher: parts[0] || null, sig: parts[1] || null, dt: null };
    }

    // 2) URL with params
    try {
      const u = new URL(t);
      return {
        voucher: u.searchParams.get("voucher"),
        sig: u.searchParams.get("sig"),
        dt: u.searchParams.get("dt")
      };
    } catch {
      // 3) fallback: maybe just voucher id
      return { voucher: t, sig: null, dt: null };
    }
  }

  // Allow auto-pair via ?dt=... in URL
  function consumeDtFromUrl() {
    const params = new URLSearchParams(location.search);
    const dt = params.get("dt");
    if (dt) {
      deviceToken = dt;
      localStorage.setItem(LS_DEVICE, deviceToken);
      // Clean URL (remove dt) so it doesn't keep re-applying
      params.delete("dt");
      const newQs = params.toString();
      const cleanUrl = location.pathname + (newQs ? ("?" + newQs) : "");
      history.replaceState({}, "", cleanUrl);
    }
  }

  // Allow prefill voucher via ?voucher=...&sig=...
  function consumeVoucherFromUrl() {
    const params = new URLSearchParams(location.search);
    const v = params.get("voucher");
    const s = params.get("sig");
    if (v) {
      document.getElementById("voucherInput").value = s ? `${v}|${s}` : v;
      // Clean URL (keep page clean)
      params.delete("voucher"); params.delete("sig");
      const newQs = params.toString();
      const cleanUrl = location.pathname + (newQs ? ("?" + newQs) : "");
      history.replaceState({}, "", cleanUrl);
      // Auto-check
      loadVoucher();
    }
  }

  // --- Scanner ---
  function scannerSupported() {
    return ("BarcodeDetector" in window) && navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
  }

  async function openScanner(mode) {
    scanMode = mode;
    scannerTitle.textContent = mode === "pair" ? "Scan Owner Pair QR" : "Scan Voucher QR";
    scannerHint.textContent  = mode === "pair"
      ? "Point camera at Owner Pair QR (contains dt=...)."
      : "Point camera at Voucher QR (contains voucher|sig OR voucher=...&sig=...).";

    if (!scannerSupported()) {
      alert("Scanner not supported on this browser. Use latest Safari/Chrome, or paste manually.");
      return;
    }

    if (!detector) detector = new BarcodeDetector({ formats: ["qr_code"] });

    modal.style.display = "flex";

    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      video.srcObject = stream;

      // Poll detector
      scanTimer = setInterval(async () => {
        try {
          const barcodes = await detector.detect(video);
          if (barcodes && barcodes.length) {
            const raw = barcodes[0].rawValue || "";
            handleScannedText(raw);
          }
        } catch {
          // ignore transient
        }
      }, 250);
    } catch (e) {
      closeScanner();
      alert("Camera permission blocked. Please allow camera access for FuelSkip in Safari/Chrome settings.");
    }
  }

  function closeScanner() {
    modal.style.display = "none";
    if (scanTimer) { clearInterval(scanTimer); scanTimer = null; }
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      video.srcObject = null;
    }
  }

  function handleScannedText(raw) {
    const p = parsePayload(raw);

    if (scanMode === "pair") {
      if (!p.dt) return; // ignore non-pair QR
      deviceToken = p.dt;
      localStorage.setItem(LS_DEVICE, deviceToken);
      setPairedUI();
      closeScanner();
      alert("‚úÖ Device paired successfully.");
      return;
    }

    // voucher mode
    if (!p.voucher) return;
    const payloadText = p.sig ? `${p.voucher}|${p.sig}` : p.voucher;
    document.getElementById("voucherInput").value = payloadText;
    closeScanner();
    loadVoucher();
  }

  // --- Voucher actions ---
  function statusChip(status) {
    const s = (status || "").toUpperCase();
    if (s === "PAID") return `<span class="pill p-ok">PAID</span>`;
    if (s === "USED") return `<span class="pill" style="background:#e5e7eb;color:#111827;">USED</span>`;
    return `<span class="pill p-bad">${s || "INVALID"}</span>`;
  }

  async function fetchJsonTry(url, options) {
    const res = await fetch(url, options);
    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  async function loadVoucher() {
    const raw = document.getElementById("voucherInput").value.trim();
    if (!raw) return alert("Enter or scan a voucher.");

    const p = parsePayload(raw);
    currentVoucherId = p.voucher;
    currentSig = p.sig;

    if (!currentVoucherId) return alert("Voucher ID missing.");

    const card = document.getElementById("voucherCard");
    const kv = document.getElementById("voucherKV");
    const statusMsg = document.getElementById("statusMsg");
    const dispenseBtn = document.getElementById("dispenseBtn");

    card.style.display = "none";
    kv.innerHTML = "";
    statusMsg.innerHTML = "";
    dispenseBtn.style.display = "none";

    // Preferred: verify endpoint (if your backend has it)
    let voucher = null;

    // 1) If we have sig, try /voucher/verify?voucher=...&sig=...
    if (currentSig) {
      const r1 = await fetchJsonTry(`${API}/voucher/verify?voucher=${encodeURIComponent(currentVoucherId)}&sig=${encodeURIComponent(currentSig)}`, {
        headers: deviceToken ? { "X-DEVICE-TOKEN": deviceToken } : {}
      });

      if (r1.ok) voucher = r1.data;
      // If endpoint doesn't exist (404), fallback below
    }

    // 2) fallback: /voucher/{id}
    if (!voucher) {
      const r2 = await fetchJsonTry(`${API}/voucher/${encodeURIComponent(currentVoucherId)}`, {
        headers: deviceToken ? { "X-DEVICE-TOKEN": deviceToken } : {}
      });
      if (!r2.ok) {
        alert("Voucher not found / verify failed.");
        return;
      }
      voucher = r2.data;
    }

    // Render
    card.style.display = "block";
    const used = !!voucher.used || (String(voucher.status || "").toLowerCase() === "used");

    kv.innerHTML = `
      <p><strong>ID:</strong> ${voucher.id || currentVoucherId}</p>
      <p><strong>Customer:</strong> ${voucher.user_name ? `${voucher.user_name} (${voucher.user_phone || "-"})` : "Walk-in (-)"}</p>
      <p><strong>Fuel Type:</strong> ${voucher.fuel_type || voucher.fuel || "‚Äî"}</p>
      <p><strong>Amount:</strong> ‚Çπ${Number(voucher.amount || 0).toFixed(2)}</p>
      <p><strong>Litres:</strong> ${Number(voucher.litres || 0).toFixed(2)} L</p>
      <p><strong>Vehicle:</strong> ${(voucher.vehicle_type || "‚Äî")} ¬∑ ${(voucher.vehicle_no || "-")}</p>
      <p><strong>Status:</strong> ${statusChip(used ? "USED" : (voucher.status || "UNKNOWN"))}</p>
      <p><strong>QR Signature:</strong> ${
        currentSig ? `<span class="pill p-ok">OK</span>` : `<span class="pill" style="background:#e5e7eb;color:#111827;">N/A</span>`
      }</p>
    `;

    // rules
    const canDispense = (String(voucher.status || "").toLowerCase() === "paid") && !used;

    if (canDispense) {
      statusMsg.innerHTML = `<div style="color:#16a34a; font-weight:900;">‚úÖ Ready to dispense.</div>`;
      dispenseBtn.textContent = "‚úÖ Dispense Fuel";
      dispenseBtn.className = "btn-green";
      dispenseBtn.disabled = false;
      dispenseBtn.style.display = "block";
    } else if (used) {
      statusMsg.innerHTML = `<div style="color:#6b7280; font-weight:900;">‚ö†Ô∏è Voucher already used.</div>`;
    } else if (String(voucher.status || "").toLowerCase() === "pending") {
      statusMsg.innerHTML = `<div style="color:#f97316; font-weight:900;">‚è≥ Payment pending.</div>`;
    } else {
      statusMsg.innerHTML = `<div style="color:#ef4444; font-weight:900;">‚ùå Invalid / not payable.</div>`;
    }

    // Auto-scroll so attendant immediately sees status
    setTimeout(() => {
      card.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 80);
  }

  async function dispense() {
    if (!currentVoucherId) return;

    if (!deviceToken) {
      alert("Device not paired. Scan Owner Pair QR first.");
      return;
    }

    const dispenseBtn = document.getElementById("dispenseBtn");
    const statusMsg = document.getElementById("statusMsg");

    dispenseBtn.disabled = true;
    dispenseBtn.textContent = "‚è≥ Dispensing...";

    const res = await fetchJsonTry(`${API}/validate/${encodeURIComponent(currentVoucherId)}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-DEVICE-TOKEN": deviceToken,
        ...(currentSig ? { "X-QR-SIG": currentSig } : {})
      }
    });

    if (res.ok) {
      // ‚úÖ UX: change big button to Done + disable
      statusMsg.innerHTML = `<div style="color:#10b981; font-weight:900; font-size:16px;">‚úÖ DONE ‚Äì Voucher marked USED</div>`;
      dispenseBtn.textContent = "‚úî Done";
      dispenseBtn.className = "btn-gray";
      dispenseBtn.disabled = true;

      // Auto-refresh voucher view (shows USED)
      setTimeout(loadVoucher, 350);

      // Auto-scroll to status confirmation
      setTimeout(() => {
        document.getElementById("statusMsg").scrollIntoView({ behavior: "smooth", block: "center" });
      }, 120);

    } else {
      statusMsg.innerHTML = `<div style="color:#ef4444; font-weight:900;">‚ùå Dispense failed: ${res.data.detail || "Unknown"}</div>`;
      dispenseBtn.disabled = false;
      dispenseBtn.textContent = "‚úÖ Dispense Fuel";
    }
  }

  // --- Events ---
  document.getElementById("scanPairBtn").addEventListener("click", () => openScanner("pair"));
  document.getElementById("scanVoucherBtn").addEventListener("click", () => openScanner("voucher"));
  document.getElementById("closeScanner").addEventListener("click", closeScanner);
  document.getElementById("checkBtn").addEventListener("click", loadVoucher);
  document.getElementById("dispenseBtn").addEventListener("click", dispense);

  elResetBtn.addEventListener("click", () => {
    if (!confirm("Reset pairing on this device?")) return;
    localStorage.removeItem(LS_DEVICE);
    deviceToken = "";
    setPairedUI();
    alert("Pairing cleared.");
  });

  // Init
  window.addEventListener("load", () => {
    consumeDtFromUrl();
    setPairedUI();
    consumeVoucherFromUrl();
  });
</script>
</body>
</html>
