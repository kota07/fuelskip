<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FuelSkip ‚Äì Attendant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- iPhone-friendly QR scanner -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      margin:0; padding:16px;
      background:#0f172a;
      display:flex; justify-content:center;
    }
    .wrap{ width:100%; max-width:460px; }
    h2{ margin:0 0 14px; text-align:center; color:#e5e7eb; }

    .card{
      background:#ffffff; border-radius:18px;
      padding:14px; margin:12px 0;
      box-shadow:0 10px 25px rgba(15,23,42,0.25);
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row-between{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }

    .muted{ color:#6b7280; font-size:13px; line-height:1.4; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }

    input{
      flex:1;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid #d4d4d8;
      font-size:14px;
      min-width: 180px;
    }
    input:focus{
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 3px rgba(37,99,235,0.18);
    }

    button{
      padding:11px 14px;
      border:none; border-radius:12px;
      font-weight:800; cursor:pointer;
      transition:transform 0.12s ease, opacity 0.12s ease;
      white-space:nowrap;
    }
    button:active{ transform:scale(0.98); }
    button:disabled{ opacity:0.6; cursor:not-allowed; }

    .btn-primary{ background:#2563eb; color:#fff; }
    .btn-dark{ background:#0b1220; color:#fff; }
    .btn-green{ background:#10b981; color:#fff; width:100%; font-size:16px; padding:14px 14px; }
    .btn-red{ background:#ef4444; color:#fff; }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      letter-spacing:0.04em;
    }
    .ok{ background:#dcfce7; color:#166534; }
    .bad{ background:#fee2e2; color:#991b1b; }
    .warn{ background:#ffedd5; color:#9a3412; }
    .gray{ background:#e5e7eb; color:#111827; }

    #voucherBox h3{ margin:0 0 10px; color:#111827; }
    #voucherData p{ margin:6px 0; color:#374151; font-size:14px; }
    #voucherData p strong{ color:#111827; }

    #statusMsg{ margin-top:10px; font-size:15px; font-weight:800; }
    .hint{ margin-top:8px; font-size:12px; color:#64748b; }

    /* scanner modal */
    #scanModal{
      position:fixed; inset:0;
      background:rgba(2,6,23,0.72);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modalCard{
      width:100%; max-width:520px;
      background:#fff; border-radius:18px;
      overflow:hidden;
      box-shadow:0 20px 50px rgba(0,0,0,0.35);
    }
    .modalHead{
      padding:12px 14px;
      background:#0b1220; color:#fff;
      display:flex; justify-content:space-between; align-items:center;
      font-weight:900;
      gap:10px;
    }
    .modalBody{ padding:12px 14px; }
    /* IMPORTANT: iPhone needs height, otherwise it looks like camera didn't start */
    #qrReader{
      width:100%;
      height: 360px;
      background:#0b1220;
      border-radius:14px;
      overflow:hidden;
    }
    .modalFoot{
      padding:12px 14px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      align-items:center;
      border-top:1px solid #e5e7eb;
    }

    .tinyWarn{
      margin-top:10px;
      font-size:12px;
      color:#92400e;
      background:#fffbeb;
      border:1px solid #fde68a;
      padding:10px;
      border-radius:12px;
      display:none;
      white-space:pre-line;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>‚õΩ FuelSkip ‚Äì Attendant</h2>

    <!-- Pairing status -->
    <div class="card" id="pairCard">
      <div class="row-between">
        <div style="font-size:18px; font-weight:900; color:#111827;">
          Device: <span id="pairStatus" class="pill bad">NOT PAIRED</span>
        </div>
        <button class="btn-red" id="resetBtn" style="display:none;">Reset</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Pair once using Owner QR (dt=...). After that, scan voucher QR inside this page (don‚Äôt open new tabs).
      </div>

      <div class="hint">
        Origin: <span class="mono" id="originTxt"></span> ‚Ä¢ Token: <span class="mono" id="tokShort">‚Äî</span>
      </div>

      <div class="tinyWarn" id="storageWarn"></div>

      <div class="row" style="margin-top:12px;">
        <button class="btn-dark" id="scanPairBtn" style="flex:1;">üîó Scan Owner Pair QR</button>
        <button class="btn-dark" id="scanVoucherBtn" style="flex:1;">üì∑ Scan Voucher QR</button>
      </div>
    </div>

    <!-- Enter voucher -->
    <div class="card">
      <div class="row">
        <input id="voucherInput" placeholder="Paste voucher ID (or scan QR)" />
        <button class="btn-primary" id="checkBtn">Check</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Customer QR contains a link like: <span class="mono">/attendant.html?voucher=...&sig=...</span>
      </div>
    </div>

    <!-- Voucher details -->
    <div class="card" id="voucherBox" style="display:none;">
      <h3>Voucher Details</h3>
      <div id="voucherData"></div>
      <div id="statusMsg"></div>
      <button id="dispenseBtn" class="btn-green" style="display:none;">‚úÖ Dispense Fuel</button>
    </div>
  </div>

  <!-- Scanner modal -->
  <div id="scanModal">
    <div class="modalCard">
      <div class="modalHead">
        <div id="scanTitle">Scan</div>
        <button class="btn-red" id="closeScan" style="padding:8px 12px; border-radius:10px;">Close</button>
      </div>
      <div class="modalBody">
        <div class="muted" id="scanHelp" style="margin-bottom:10px;"></div>
        <div id="qrReader"></div>
        <div class="muted mono" id="scanHint" style="margin-top:10px;"></div>
      </div>
      <div class="modalFoot">
        <div class="muted">Tip: Use the Home Screen app (PWA) for stable pairing.</div>
      </div>
    </div>
  </div>

<script>
  const API = window.location.origin;

  const LS_DEVICE_TOKEN = "FUELSKIP_DEVICE_TOKEN";
  const LS_PAIR_MARK    = "FUELSKIP_PAIR_MARK";
  const COOKIE_NAME     = "fuelskip_dt";

  let currentVoucher = null;
  let html5Qr = null;
  let isScanning = false;

  function qs(name){
    return new URLSearchParams(window.location.search).get(name);
  }
  function setPill(el, text, cls){
    el.textContent = text;
    el.className = "pill " + cls;
  }
  function shortTok(t){
    if(!t) return "‚Äî";
    return t.slice(0, 8) + "‚Ä¶";
  }

  // ---- cookie helpers (backup to avoid iOS clearing localStorage sometimes) ----
  function setCookie(name, value, days){
    const maxAge = days * 24 * 60 * 60;
    document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
  }
  function getCookie(name){
    const n = encodeURIComponent(name) + "=";
    const parts = document.cookie.split(";").map(s=>s.trim());
    for(const p of parts){
      if(p.startsWith(n)) return decodeURIComponent(p.slice(n.length));
    }
    return "";
  }
  function clearCookie(name){
    document.cookie = `${encodeURIComponent(name)}=; Max-Age=0; Path=/; SameSite=Lax`;
  }

  function getDeviceToken(){
    // 1) localStorage
    let t = (localStorage.getItem(LS_DEVICE_TOKEN) || "").trim();
    if(t) return t;

    // 2) cookie backup
    t = (getCookie(COOKIE_NAME) || "").trim();
    if(t){
      // restore back to localStorage
      localStorage.setItem(LS_DEVICE_TOKEN, t);
      return t;
    }

    // 3) sessionStorage (rare)
    t = (sessionStorage.getItem(LS_DEVICE_TOKEN) || "").trim();
    if(t) return t;

    return "";
  }
  function setDeviceToken(t){
    const tok = (t || "").trim();
    if(!tok) return;
    localStorage.setItem(LS_DEVICE_TOKEN, tok);
    localStorage.setItem(LS_PAIR_MARK, String(Date.now()));
    sessionStorage.setItem(LS_DEVICE_TOKEN, tok);
    setCookie(COOKIE_NAME, tok, 180); // 6 months
  }
  function clearDeviceToken(){
    localStorage.removeItem(LS_DEVICE_TOKEN);
    localStorage.removeItem(LS_PAIR_MARK);
    sessionStorage.removeItem(LS_DEVICE_TOKEN);
    clearCookie(COOKIE_NAME);
  }

  function scrollToStatus(){
    const box = document.getElementById("voucherBox");
    const st  = document.getElementById("statusMsg");
    if (box && box.style.display !== "none") {
      box.scrollIntoView({ behavior:"smooth", block:"start" });
      setTimeout(()=>st.scrollIntoView({ behavior:"smooth", block:"start" }), 220);
    } else if (st) {
      st.scrollIntoView({ behavior:"smooth", block:"start" });
    }
  }

  function extractPairToken(scannedText){
    const s = (scannedText || "").trim();
    if(!s) return null;
    try{
      const u = new URL(s);
      const dt = u.searchParams.get("dt");
      if(dt) return dt;
    }catch(e){}
    const m = s.match(/dt=([a-zA-Z0-9_-]+)/);
    return m ? m[1] : null;
  }

  function extractVoucherId(scannedText){
    const s = (scannedText || "").trim();
    if(!s) return null;
    try{
      const u = new URL(s);
      const v = u.searchParams.get("voucher");
      if(v) return v;
    }catch(e){}
    const m = s.match(/voucher=([a-zA-Z0-9_-]+)/);
    if(m && m[1]) return m[1];
    if(/^[a-z0-9]{6,32}$/i.test(s)) return s;
    return null;
  }

  function isInAppBrowser(){
    const ua = navigator.userAgent || "";
    return /FBAN|FBAV|Instagram|Line|Twitter|LinkedIn|Snapchat/i.test(ua);
  }

  // --- init pairing from URL dt= (Owner QR opened as link) ---
  (function initPairFromUrl(){
    const dt = qs("dt");
    if(dt){
      setDeviceToken(dt);
      const url = new URL(window.location.href);
      url.searchParams.delete("dt");
      history.replaceState({}, "", url.toString());
    }
  })();

  function refreshPairUI(){
    document.getElementById("originTxt").textContent = window.location.origin;
    const tok = getDeviceToken();
    const pill = document.getElementById("pairStatus");
    const resetBtn = document.getElementById("resetBtn");
    document.getElementById("tokShort").textContent = shortTok(tok);

    if(tok){
      setPill(pill, "PAIRED", "ok");
      resetBtn.style.display = "inline-block";
    }else{
      setPill(pill, "NOT PAIRED", "bad");
      resetBtn.style.display = "none";
    }

    const warn = document.getElementById("storageWarn");
    const hadPairMark = !!localStorage.getItem(LS_PAIR_MARK);
    const inApp = isInAppBrowser();

    // show helpful warnings
    let msg = "";
    if(inApp){
      msg += "‚ö†Ô∏è You are in an in-app browser. Camera often fails here.\nOpen FuelSkip in Safari/Chrome or add to Home Screen (PWA).\n\n";
    }
    if(!tok && hadPairMark){
      msg += "‚ö†Ô∏è Pairing disappeared (storage cleared).\nFix on iPhone: Settings ‚Üí Safari ‚Üí Advanced ‚Üí Website Data ‚Üí remove railway.app\nThen open FuelSkip again and Add to Home Screen.\n";
    }

    warn.textContent = msg.trim();
    warn.style.display = msg ? "block" : "none";
  }

  // --- Scanner modal using html5-qrcode ---
  function ensureSecureContextOrWarn(hintEl){
    // Camera requires HTTPS or localhost
    if (!window.isSecureContext) {
      hintEl.textContent =
        "Camera blocked: not a secure context. Open the https:// URL only.";
      return false;
    }
    return true;
  }

  async function openScanner(mode){
    const modal = document.getElementById("scanModal");
    const title = document.getElementById("scanTitle");
    const help  = document.getElementById("scanHelp");
    const hint  = document.getElementById("scanHint");

    title.textContent = (mode === "pair") ? "Scan Owner Pair QR" : "Scan Voucher QR";
    help.textContent  = (mode === "pair")
      ? "Point camera at Owner Pair QR (contains dt=...)."
      : "Point camera at Voucher QR (contains voucher=...).";
    hint.textContent = "";

    modal.style.display = "flex";

    // Make sure container is empty (prevents iOS black screen sometimes)
    document.getElementById("qrReader").innerHTML = "";

    if(!ensureSecureContextOrWarn(hint)) return;

    // Create fresh instance each time for iOS stability
    html5Qr = new Html5Qrcode("qrReader");

    try{
      // Check cameras first (gives clearer error on iPhone)
      const cams = await Html5Qrcode.getCameras();
      if(!cams || !cams.length){
        hint.textContent = "No camera found. Open in Safari/Chrome and allow camera.";
        return;
      }

      const config = {
        fps: 10,
        qrbox: { width: 240, height: 240 }
      };

      isScanning = true;

      await html5Qr.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          if(mode === "pair"){
            const dt = extractPairToken(decodedText);
            if(dt){
              setDeviceToken(dt);
              refreshPairUI();
              hint.textContent = "Paired ‚úì token saved";
              closeScanner();
              return;
            }
            hint.textContent = "QR detected but dt= not found.";
          }else{
            const v = extractVoucherId(decodedText);
            if(v){
              document.getElementById("voucherInput").value = v;
              hint.textContent = "Captured voucher: " + v;
              closeScanner();
              loadVoucher();
              return;
            }
            hint.textContent = "QR detected but voucher= not found.";
          }
        },
        (_err) => { /* ignore */ }
      );
    }catch(e){
      const msg = (e && e.message) ? e.message : String(e);
      hint.textContent =
        "Camera did not start.\n" +
        "Fix:\n" +
        "1) iPhone: Settings ‚Üí Safari ‚Üí Camera ‚Üí Allow\n" +
        "2) Safari: aA ‚Üí Website Settings ‚Üí Camera ‚Üí Allow\n" +
        "3) Close other apps using camera (WhatsApp/Instagram)\n" +
        "4) If in-app browser, open in Safari/Chrome\n" +
        "Error: " + msg;
    }
  }

  async function closeScanner(){
    const modal = document.getElementById("scanModal");
    try{
      if(html5Qr && isScanning){
        await html5Qr.stop();
      }
    }catch(e){}
    try{
      if(html5Qr){
        await html5Qr.clear();
      }
    }catch(e){}
    html5Qr = null;
    isScanning = false;
    modal.style.display = "none";
  }

  // --- API calls ---
  async function loadVoucher(){
    const voucherId = document.getElementById("voucherInput").value.trim();
    if(!voucherId){
      alert("Voucher ID missing");
      return;
    }

    const box = document.getElementById("voucherBox");
    const dataDiv = document.getElementById("voucherData");
    const statusDiv = document.getElementById("statusMsg");
    const btn = document.getElementById("dispenseBtn");

    box.style.display = "none";
    dataDiv.innerHTML = "";
    statusDiv.innerHTML = "";
    btn.style.display = "none";

    // reset button state for new voucher
    btn.disabled = false;
    btn.textContent = "‚úÖ Dispense Fuel";
    btn.style.opacity = "1";

    try{
      const res = await fetch(`${API}/voucher/${encodeURIComponent(voucherId)}`, { cache:"no-store" });
      const v = await res.json();
      if(!res.ok) throw new Error(v.detail || "Voucher not found");

      currentVoucher = v;

      const userLine = (v.user_name && v.user_phone)
        ? `${v.user_name} (${v.user_phone})`
        : (v.user_name ? v.user_name : "Walk-in (-)");

      const fuelLine = v.fuel_type ? v.fuel_type : (v.fuel || "‚Äî");
      const used = !!v.used;

      const statusPill = used
        ? `<span class="pill gray">USED</span>`
        : (v.status === "paid"
          ? `<span class="pill ok">PAID</span>`
          : (v.status === "pending"
            ? `<span class="pill warn">PENDING</span>`
            : `<span class="pill bad">${String(v.status || "INVALID").toUpperCase()}</span>`));

      dataDiv.innerHTML = `
        <p><strong>ID:</strong> ${v.id}</p>
        <p><strong>Customer:</strong> ${userLine}</p>
        <p><strong>Fuel Type:</strong> ${fuelLine}</p>
        <p><strong>Amount:</strong> ‚Çπ${Number(v.amount || 0).toLocaleString("en-IN")}</p>
        <p><strong>Litres:</strong> ${Number(v.litres || 0)} L</p>
        <p><strong>Vehicle:</strong> ${(v.vehicle_type || "‚Äî")} ‚Ä¢ ${(v.vehicle_no || "‚Äî")}</p>
        <p><strong>Status:</strong> ${statusPill}</p>
        <p><strong>QR Signature:</strong> <span class="pill ok">OK</span></p>
      `;

      box.style.display = "block";

      if(v.status === "paid" && !used){
        statusDiv.innerHTML = `<span class="pill ok">‚úÖ Ready to dispense.</span>`;
        btn.style.display = "block";
      }else if(used){
        statusDiv.innerHTML = `<span class="pill gray">‚ö†Ô∏è Voucher already used.</span>`;
      }else if(v.status === "pending"){
        statusDiv.innerHTML = `<span class="pill warn">‚è≥ Payment pending.</span>`;
      }else{
        statusDiv.innerHTML = `<span class="pill bad">‚ùå Not valid.</span>`;
      }

      scrollToStatus();
    }catch(e){
      alert("Error: " + e.message);
    }
  }

  async function dispenseFuel(){
    if(!currentVoucher?.id) return;

    const tok = getDeviceToken();
    if(!tok){
      alert("Not paired. Scan Owner Pair QR first (dt=...).");
      return;
    }

    const btn = document.getElementById("dispenseBtn");
    const statusDiv = document.getElementById("statusMsg");

    btn.disabled = true;
    btn.textContent = "‚è≥ Dispensing...";

    try{
      const res = await fetch(`${API}/validate/${encodeURIComponent(currentVoucher.id)}`, {
        method: "POST",
        headers: { "X-DEVICE-TOKEN": tok }
      });

      const data = await res.json().catch(()=>({}));
      if(!res.ok){
        btn.disabled = false;
        btn.textContent = "‚úÖ Dispense Fuel";
        statusDiv.innerHTML = `<span class="pill bad">‚ùå ${data.detail || "Validation failed"}</span>`;
        scrollToStatus();
        return;
      }

      // SUCCESS UI (what you asked)
      statusDiv.innerHTML = `<span class="pill ok">‚úÖ DONE ‚Äì Voucher marked USED</span>`;
      btn.textContent = "‚úî Done";
      btn.disabled = true;
      btn.style.opacity = "0.85";
      scrollToStatus();

      // refresh voucher after a short moment (to show USED pill)
      setTimeout(() => { loadVoucher(); }, 500);
    }catch(e){
      btn.disabled = false;
      btn.textContent = "‚úÖ Dispense Fuel";
      statusDiv.innerHTML = `<span class="pill bad">‚ùå ${e.message}</span>`;
      scrollToStatus();
    }
  }

  // --- wire up ---
  window.addEventListener("load", () => {
    refreshPairUI();

    document.getElementById("resetBtn").addEventListener("click", () => {
      if(confirm("Reset pairing on this device?")){
        clearDeviceToken();
        refreshPairUI();
        alert("Pairing reset. Re-scan Owner QR to pair again.");
      }
    });

    document.getElementById("checkBtn").addEventListener("click", loadVoucher);
    document.getElementById("dispenseBtn").addEventListener("click", dispenseFuel);

    document.getElementById("scanPairBtn").addEventListener("click", () => openScanner("pair"));
    document.getElementById("scanVoucherBtn").addEventListener("click", () => openScanner("voucher"));
    document.getElementById("closeScan").addEventListener("click", closeScanner);

    // if opened from voucher QR link (customer opens URL)
    const v = qs("voucher");
    if(v){
      document.getElementById("voucherInput").value = v;
      loadVoucher();
    }
  });
</script>
</body>
</html>
