<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FuelSkip ‚Äì Attendant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- QR decode library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; padding: 16px;
      background: #0f172a;
      display: flex; justify-content: center;
    }
    .wrap { width: 100%; max-width: 420px; }
    h2 { margin: 0 0 16px 0; color: #e5e7eb; text-align: center; }

    .box {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      margin-top: 12px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.25);
    }

    .row-top { display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .mini { margin-top: 8px; font-size: 12px; color: #6b7280; }
    .debug { margin-top: 8px; font-size: 12px; color: #64748b; word-break: break-all; }

    .input-row { display: flex; gap: 8px; align-items: center; margin-top: 10px; }
    input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      font-size: 14px;
    }

    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-blue  { background: #3b82f6; color: #fff; }
    .btn-green { background: #10b981; color: #fff; width: 100%; margin-top: 10px; }
    .btn-red   { background: #ef4444; color: #fff; }
    .btn-dark  { background: #111827; color: #fff; width:100%; }
    .btn-gray  { background: #e5e7eb; color: #111827; width:100%; }

    .status-chip {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 800;
      color: #fff;
    }
    .paid { background: #16a34a; }
    .used { background: #6b7280; }
    .pend { background: #f97316; }

    #voucherData p { margin: 4px 0; font-size: 14px; color: #374151; }
    #voucherData strong { color: #111827; }
    #statusMsg { margin-top: 10px; font-size: 14px; font-weight: 800; }

    /* Scanner modal-ish UI */
    #scannerWrap { display:none; margin-top: 12px; }
    .scanHeader { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
    .scanTitle { font-weight:900; color:#111827; }
    #video {
      width: 100%;
      border-radius: 12px;
      background: #000;
      min-height: 220px;
    }
    #scanHint {
      margin-top: 8px;
      font-size: 12px;
      color: #374151;
      font-weight: 700;
    }

    /* Scroll highlight after dispense */
    .flash {
      outline: 3px solid rgba(16,185,129,0.35);
      transition: outline 0.2s ease;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h2>‚õΩ FuelSkip ‚Äì Attendant</h2>

  <!-- PAIRING STATUS -->
  <div class="box">
    <div class="row-top">
      <div style="font-size:13px;font-weight:900;">
        Device:
        <span id="pairState" style="font-weight:900;color:#ef4444;">NOT PAIRED</span>
      </div>
      <button class="btn-red" onclick="resetPairing()">Reset</button>
    </div>

    <div class="mini">
      Pair once using Owner QR (dt=...). After pairing, scan voucher QR inside this page (don‚Äôt open new tabs).
    </div>

    <div class="input-row" style="margin-top:12px;">
      <button class="btn-dark" onclick="startOwnerScan()">üîó Scan Owner Pair QR</button>
    </div>

    <div class="debug" id="debugLine"></div>
  </div>

  <!-- VOUCHER SCAN / INPUT -->
  <div class="box">
    <button class="btn-dark" onclick="startVoucherScan()">
      üì∑ Scan Voucher QR
    </button>

    <div id="scannerWrap">
      <div class="scanHeader">
        <div class="scanTitle" id="scanModeTitle">Scan</div>
        <button class="btn-red" onclick="stopScan()">Close</button>
      </div>
      <video id="video" playsinline muted></video>
      <div id="scanHint">Point camera at QR‚Ä¶</div>
      <div class="mini" id="scanTip" style="margin-top:10px;">
        Tip: Use the Home Screen app (PWA) for stable camera + pairing.
      </div>
    </div>

    <div class="input-row">
      <input id="voucherInput" placeholder="Paste voucher ID (or scan QR)">
      <button class="btn-blue" onclick="loadVoucher()">Check</button>
    </div>

    <div class="mini">
      Customer QR contains a link like:
      <div style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace;">
        /attendant.html?voucher=...&sig=...
      </div>
    </div>
  </div>

  <!-- VOUCHER DETAILS -->
  <div class="box" id="voucherInfo" style="display:none;">
    <h3 style="margin:0 0 8px 0;">Voucher Details</h3>
    <div id="voucherData"></div>
    <div id="statusMsg"></div>
    <button id="dispenseBtn" class="btn-green" onclick="validateAndDispense()" style="display:none;">
      ‚úÖ Dispense Fuel
    </button>
  </div>
</div>

<script>
const API = window.location.origin;

let currentVoucherId = null;
let currentSig = "";

let scanStream = null;
let scanLoopId = null;
let scanMode = "voucher"; // "owner" | "voucher"

/* ---------------- Cookie helpers ---------------- */
function setCookie(name, value, days=365) {
  const maxAge = days * 24 * 60 * 60;
  const secure = (location.protocol === "https:") ? "; Secure" : "";
  document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax${secure}`;
}
function getCookie(name) {
  const cookies = document.cookie.split(";").map(c => c.trim());
  for (const c of cookies) {
    if (c.startsWith(name + "=")) return decodeURIComponent(c.substring(name.length + 1));
  }
  return "";
}

/* ---------------- Device token store (persist pairing) ---------------- */
function saveDeviceToken(token) {
  const t = (token || "").trim();
  if (!t) return;
  try { sessionStorage.setItem("FUELSKIP_DEVICE_TOKEN", t); } catch(e){}
  try { localStorage.setItem("FUELSKIP_DEVICE_TOKEN", t); } catch(e){}
  setCookie("fuelskip_dt", t, 365);
}
function getDeviceToken() {
  let t = "";
  try { t = (sessionStorage.getItem("FUELSKIP_DEVICE_TOKEN") || "").trim(); } catch(e){}
  if (!t) { try { t = (localStorage.getItem("FUELSKIP_DEVICE_TOKEN") || "").trim(); } catch(e){} }
  if (!t) t = (getCookie("fuelskip_dt") || "").trim();
  return t;
}
function setPairState() {
  const t = getDeviceToken();
  const paired = !!t;
  const el = document.getElementById("pairState");
  el.textContent = paired ? "PAIRED" : "NOT PAIRED";
  el.style.color = paired ? "#16a34a" : "#ef4444";
  document.getElementById("debugLine").textContent =
    `Origin: ${window.location.origin} ‚Ä¢ Token: ${paired ? (t.slice(0,8)+"‚Ä¶") : "‚Äî"}`;
}
function resetPairing() {
  try { sessionStorage.removeItem("FUELSKIP_DEVICE_TOKEN"); } catch(e){}
  try { localStorage.removeItem("FUELSKIP_DEVICE_TOKEN"); } catch(e){}
  setCookie("fuelskip_dt", "", -1);
  alert("Pairing removed. Scan Owner Pair QR again.");
  setPairState();
}

/* ---------------- URL params (pairing via dt in query) ---------------- */
function getParams() {
  const p = new URLSearchParams(window.location.search);
  return { dt: p.get("dt") || "", voucher: p.get("voucher") || "", sig: p.get("sig") || "" };
}

window.addEventListener("load", () => {
  const p = getParams();

  // If opened with dt=... (pair link), save it then clean URL
  if (p.dt) {
    saveDeviceToken(p.dt);
    history.replaceState({}, "", window.location.pathname);
    alert("‚úÖ Device paired successfully!");
  }

  // If opened with voucher&sig (rare case: QR opened as link), preload it
  if (p.voucher && p.sig) {
    currentSig = p.sig;
    document.getElementById("voucherInput").value = p.voucher;
    // Keep URL clean (prevents ‚Äúopen in new tab‚Äù confusion)
    history.replaceState({}, "", window.location.pathname);
    loadVoucher();
  }

  setPairState();
});

/* ---------------- Voucher UI helpers ---------------- */
function statusChip(status, used) {
  if (used) return '<span class="status-chip used">USED</span>';
  if ((status || "").toLowerCase() === "paid") return '<span class="status-chip paid">PAID</span>';
  return '<span class="status-chip pend">PENDING</span>';
}

/* ---------------- Load voucher ---------------- */
async function loadVoucher() {
  const id = document.getElementById("voucherInput").value.trim();
  if (!id) return alert("Enter voucher ID");

  const box = document.getElementById("voucherInfo");
  const data = document.getElementById("voucherData");
  const msg = document.getElementById("statusMsg");
  const btn = document.getElementById("dispenseBtn");

  box.style.display = "none";
  btn.style.display = "none";
  msg.textContent = "";

  try {
    const res = await fetch(`${API}/voucher/${encodeURIComponent(id)}`, { cache: "no-store" });
    const v = await res.json();
    if (!res.ok) throw new Error(v.detail || "Voucher not found");

    currentVoucherId = id;

    data.innerHTML = `
      <p><strong>ID:</strong> ${v.id}</p>
      <p><strong>Customer:</strong> ${v.user_name || "Walk-in"} (${v.user_phone || "-"})</p>
      <p><strong>Fuel Type:</strong> ${v.fuel_type || "-"}</p>
      <p><strong>Amount:</strong> ‚Çπ${v.amount}</p>
      <p><strong>Litres:</strong> ${v.litres} L</p>
      <p><strong>Vehicle:</strong> ${v.vehicle_type || "-"} ‚Ä¢ ${v.vehicle_no || "-"}</p>
      <p><strong>Status:</strong> ${statusChip(v.status, v.used)}</p>
      <p><strong>QR Signature:</strong>
        ${currentSig ? "<span style='color:#16a34a;font-weight:900;'>OK</span>" :
                       "<span style='color:#ef4444;font-weight:900;'>MISSING</span>"}
      </p>
    `;

    box.style.display = "block";

    const isPaid = (v.status || "").toLowerCase() === "paid";
    if (isPaid && !v.used) {
      if (!currentSig) { msg.innerHTML = "‚ùå Missing signature. Scan voucher QR."; return; }
      if (!getDeviceToken()) { msg.innerHTML = "‚ùå Device not paired. Scan Owner Pair QR."; return; }
      msg.innerHTML = "‚úÖ Ready to dispense.";
      btn.style.display = "block";
      btn.disabled = false;
      btn.textContent = "‚úÖ Dispense Fuel";
    } else if (v.used) {
      msg.innerHTML = "‚ö†Ô∏è Voucher already used.";
    } else {
      msg.innerHTML = "‚è≥ Payment pending or failed.";
    }

    // Auto-scroll to voucher info after load (attendant sees immediately)
    box.scrollIntoView({ behavior: "smooth", block: "start" });

  } catch (e) {
    alert(e.message);
  }
}

/* ---------------- Dispense (front-end improvements only) ---------------- */
async function validateAndDispense() {
  const btn = document.getElementById("dispenseBtn");
  const msg = document.getElementById("statusMsg");
  const box = document.getElementById("voucherInfo");

  btn.disabled = true;
  btn.textContent = "‚è≥ Validating...";

  try {
    const res = await fetch(
      `${API}/validate/${encodeURIComponent(currentVoucherId)}?sig=${encodeURIComponent(currentSig)}`,
      { method: "POST", headers: { "X-DEVICE-TOKEN": getDeviceToken() } }
    );
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || "Validation failed");

    if (data.already_used) {
      msg.innerHTML = "‚ö†Ô∏è Voucher already used.";
    } else {
      msg.innerHTML = "‚úÖ Fuel Dispensed";
    }

    // ‚úÖ Change big button to Done + disable
    btn.textContent = "‚úî Done";
    btn.disabled = true;

    // ‚úÖ Auto-scroll so attendant sees confirmation
    box.classList.add("flash");
    msg.scrollIntoView({ behavior: "smooth", block: "center" });
    setTimeout(() => box.classList.remove("flash"), 600);

    // Optional: refresh voucher details to show USED immediately
    setTimeout(() => loadVoucher(), 400);

  } catch (e) {
    msg.innerHTML = `‚ùå ${e.message}`;
    btn.disabled = false;
    btn.textContent = "‚úÖ Dispense Fuel";
  }
}

/* ---------------- In-page QR parsing ---------------- */
function parseQR(text) {
  // Supports full URL or relative path
  try {
    const u = new URL(text);
    return {
      voucher: u.searchParams.get("voucher") || "",
      sig: u.searchParams.get("sig") || "",
      dt: u.searchParams.get("dt") || ""
    };
  } catch {
    try {
      const u = new URL(window.location.origin + text);
      return {
        voucher: u.searchParams.get("voucher") || "",
        sig: u.searchParams.get("sig") || "",
        dt: u.searchParams.get("dt") || ""
      };
    } catch {
      return { voucher:"", sig:"", dt:"" };
    }
  }
}

/* ---------------- Scanner ---------------- */
async function startOwnerScan() {
  scanMode = "owner";
  await startScanCommon();
}
async function startVoucherScan() {
  scanMode = "voucher";
  await startScanCommon();
}

async function startScanCommon() {
  // For voucher scanning, pairing is required. For owner scan, not required.
  if (scanMode === "voucher" && !getDeviceToken()) {
    alert("Device not paired. Scan Owner Pair QR first.");
    return;
  }

  const wrap = document.getElementById("scannerWrap");
  const video = document.getElementById("video");
  const title = document.getElementById("scanModeTitle");
  const hint = document.getElementById("scanHint");

  title.textContent = (scanMode === "owner") ? "Scan Owner Pair QR" : "Scan Voucher QR";
  hint.textContent  = (scanMode === "owner")
    ? "Point camera at Owner Pair QR (contains dt=...)"
    : "Point camera at Voucher QR (contains voucher=...&sig=...)";

  wrap.style.display = "block";

  // Hard stop previous stream if any
  stopScan(true);

  try {
    // iOS/PWA camera stability tweaks:
    // - muted + playsinline on video
    // - use ideal facingMode
    // - explicit width/height ideals
    const constraints = {
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    };

    scanStream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = scanStream;

    // Required on iOS: set these again programmatically
    video.setAttribute("playsinline", "");
    video.muted = true;

    await video.play();

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    const tick = () => {
      if (!scanStream) return;

      if (!video.videoWidth || !video.videoHeight) {
        scanLoopId = requestAnimationFrame(tick);
        return;
      }

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const img = ctx.getImageData(0, 0, canvas.width, canvas.height);

      const code = jsQR(img.data, img.width, img.height, { inversionAttempts: "dontInvert" });
      if (code && code.data) {
        const parsed = parseQR(code.data);

        if (scanMode === "owner") {
          if (parsed.dt) {
            saveDeviceToken(parsed.dt);
            setPairState();
            stopScan();
            alert("‚úÖ Device paired successfully!");
            return;
          }
        } else {
          if (parsed.voucher && parsed.sig) {
            currentSig = parsed.sig;
            document.getElementById("voucherInput").value = parsed.voucher;
            stopScan();
            loadVoucher();
            return;
          }
        }
      }

      scanLoopId = requestAnimationFrame(tick);
    };

    tick();
  } catch (e) {
    // Common iPhone causes:
    // - permission denied
    // - not opened from HTTPS
    // - camera already in use
    alert("Camera not available / permission denied.\n\nTry:\n1) Open in Safari/Chrome (not inside some in-app browser)\n2) Use Home Screen app (PWA)\n3) iPhone Settings ‚Üí Safari ‚Üí Camera = Allow\n4) Reload and try again.");
    wrap.style.display = "none";
  }
}

function stopScan(silent=false) {
  const wrap = document.getElementById("scannerWrap");
  if (!silent) wrap.style.display = "none";

  if (scanLoopId) cancelAnimationFrame(scanLoopId);
  scanLoopId = null;

  if (scanStream) {
    try { scanStream.getTracks().forEach(t => t.stop()); } catch(e){}
    scanStream = null;
  }

  const video = document.getElementById("video");
  try { video.pause(); } catch(e){}
  try { video.srcObject = null; } catch(e){}
}
</script>
</body>
</html>
