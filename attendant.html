<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FuelSkip ‚Äì Attendant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QR decode library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0; padding: 16px;
      background: #0f172a;
      display: flex; justify-content: center;
    }
    .wrap { width: 100%; max-width: 420px; }
    h2 { margin: 0 0 16px 0; color: #e5e7eb; text-align: center; }

    .box {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px;
      margin-top: 12px;
      box-shadow: 0 10px 25px rgba(15,23,42,0.25);
    }

    .input-row { display: flex; gap: 8px; align-items: center; margin-top: 10px; }
    input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d4d4d8;
      font-size: 14px;
    }

    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      font-size: 14px;
    }
    button:disabled { opacity: 0.65; cursor: not-allowed; }

    .btn-blue  { background: #3b82f6; color: #fff; }
    .btn-green { background: #10b981; color: #fff; width: 100%; margin-top: 10px; }
    .btn-red   { background: #ef4444; color: #fff; }
    .btn-dark  { background: #111827; color: #fff; }

    .status-chip {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      color: #fff;
      vertical-align: middle;
    }
    .paid { background: #16a34a; }
    .used { background: #6b7280; }
    .pend { background: #f97316; }

    #voucherData p { margin: 4px 0; font-size: 14px; color: #374151; }
    #voucherData strong { color: #111827; }

    #statusMsg { margin-top: 10px; font-size: 14px; font-weight: 900; }
    .mini { margin-top: 8px; font-size: 12px; color: #6b7280; }
    .debug { margin-top: 8px; font-size: 12px; color: #64748b; word-break: break-all; }

    /* Scanner Modal */
    .modalBack {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 9999;
      padding: 12px;
    }
    .modal {
      width: 100%;
      max-width: 460px;
      background: #0b1220;
      color: #e5e7eb;
      border-radius: 16px;
      box-shadow: 0 10px 35px rgba(0,0,0,0.35);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .modalHead {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      font-weight: 900;
      background: rgba(255,255,255,0.04);
    }
    .modalBody {
      padding: 12px 14px 16px 14px;
      background: #ffffff;
      color: #111827;
    }
    .modalBody p {
      margin: 6px 0 10px 0;
      font-size: 13px;
      color: #374151;
      font-weight: 700;
    }
    #video {
      width: 100%;
      border-radius: 12px;
      background: #000;
      display: block;
    }
    .tip {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
      font-weight: 700;
    }
    .btnClose { background:#ef4444; color:#fff; font-weight:900; }
  </style>
</head>

<body>
<div class="wrap">
  <h2>‚õΩ FuelSkip ‚Äì Attendant</h2>

  <!-- PAIRING STATUS -->
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div style="font-size:13px;font-weight:900;">
        Device:
        <span id="pairState" style="font-weight:1000;color:#ef4444;">NOT PAIRED</span>
      </div>
      <button class="btn-red" onclick="resetPairing()">Reset</button>
    </div>

    <div class="mini">
      Pair once using Owner QR (dt=...). After that, scan voucher QR inside this page (don‚Äôt open new tabs).
    </div>

    <div class="debug" id="debugLine"></div>

    <div id="pairActions" style="margin-top:10px; display:none;">
      <button class="btn-dark" style="width:100%;" onclick="openScanner('owner')">
        üîó Scan Owner Pair QR
      </button>
    </div>
  </div>

  <!-- VOUCHER INPUT + SCAN -->
  <div class="box">
    <button class="btn-dark" style="width:100%;" onclick="openScanner('voucher')">
      üì∑ Scan Voucher QR
    </button>

    <div class="input-row">
      <input id="voucherId" placeholder="Paste voucher ID (or scan QR)" />
      <button class="btn-blue" onclick="checkVoucher()">Check</button>
    </div>

    <div class="mini">
      Customer QR usually contains a link like: <code>/attendant.html?voucher=...&sig=...</code>
    </div>
  </div>

  <!-- VOUCHER DETAILS -->
  <div class="box" id="voucherBox" style="display:none;">
    <h3 style="margin:0 0 10px 0;">Voucher Details</h3>
    <div id="voucherData"></div>

    <div id="statusAnchor"></div>
    <div id="statusMsg"></div>

    <button id="dispenseBtn" class="btn-green" onclick="dispenseFuel()" disabled>
      ‚úÖ Dispense Fuel
    </button>
  </div>
</div>

<!-- Scanner Modal -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHead">
      <div id="scanTitle">Scan QR</div>
      <button class="btnClose" onclick="closeScanner()">Close</button>
    </div>
    <div class="modalBody">
      <p id="scanHelp">Point camera at QR‚Ä¶</p>
      <video id="video" playsinline></video>
      <div class="tip">Tip: Use the Home Screen app (PWA) for stable camera + stable pairing.</div>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;

const LS_DEVICE_TOKEN = "FUELSKIP_DEVICE_TOKEN";
const LS_DEVICE_ORIGIN = "FUELSKIP_DEVICE_ORIGIN";

let currentScanMode = "voucher"; // "owner" or "voucher"
let stream = null;
let rafId = null;
let scanning = false;

// ---------- Helpers ----------
function qs(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function setPairedUI(isPaired, tokenPreview="‚Äî") {
  const el = document.getElementById("pairState");
  const dbg = document.getElementById("debugLine");
  const pairActions = document.getElementById("pairActions");

  if (isPaired) {
    el.textContent = "PAIRED";
    el.style.color = "#16a34a";
    pairActions.style.display = "none";
  } else {
    el.textContent = "NOT PAIRED";
    el.style.color = "#ef4444";
    pairActions.style.display = "block";
  }
  const origin = localStorage.getItem(LS_DEVICE_ORIGIN) || window.location.origin;
  dbg.textContent = `Origin: ${origin} ¬∑ Token: ${tokenPreview}`;
}

function getDeviceToken() {
  const t = (localStorage.getItem(LS_DEVICE_TOKEN) || "").trim();
  return t || null;
}

function saveDeviceToken(dt) {
  localStorage.setItem(LS_DEVICE_TOKEN, dt);
  localStorage.setItem(LS_DEVICE_ORIGIN, window.location.origin);
}

function resetPairing() {
  localStorage.removeItem(LS_DEVICE_TOKEN);
  localStorage.removeItem(LS_DEVICE_ORIGIN);
  setPairedUI(false, "‚Äî");
  alert("Pairing reset. Scan Owner Pair QR again.");
}

// ---------- Init pairing from URL dt ----------
(function initPairing() {
  const dt = qs("dt");
  if (dt) {
    saveDeviceToken(dt);
    // clean URL (remove dt so it doesn't re-pair repeatedly)
    const u = new URL(window.location.href);
    u.searchParams.delete("dt");
    window.history.replaceState({}, "", u.toString());
  }

  const token = getDeviceToken();
  if (token) {
    setPairedUI(true, token.slice(0,8) + "‚Ä¶");
  } else {
    setPairedUI(false, "‚Äî");
  }
})();

// ---------- Voucher from URL ----------
(function initVoucherFromURL() {
  const v = qs("voucher");
  if (v) {
    document.getElementById("voucherId").value = v;
    checkVoucher();
    // keep URL as-is (fine), but you can also clean it if you want
  }
})();

// ---------- Scanner ----------
function openScanner(mode) {
  currentScanMode = mode;
  document.getElementById("modalBack").style.display = "flex";
  document.getElementById("scanTitle").textContent = (mode === "owner") ? "Scan Owner Pair QR" : "Scan Voucher QR";
  document.getElementById("scanHelp").textContent =
    (mode === "owner")
      ? "Point camera at Owner Pair QR (contains dt=...)."
      : "Point camera at Voucher QR (contains voucher=...).";

  startCameraAndScan().catch(err => {
    console.error(err);
    alert("Camera error. Please allow camera permission in browser settings.");
    closeScanner();
  });
}

function closeScanner() {
  stopScan();
  document.getElementById("modalBack").style.display = "none";
}

async function startCameraAndScan() {
  if (scanning) return;
  scanning = true;

  const video = document.getElementById("video");

  // Prefer back camera
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: { ideal: "environment" } },
    audio: false
  });

  video.srcObject = stream;

  // iOS sometimes needs a short delay before play()
  await new Promise(res => setTimeout(res, 150));
  await video.play();

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });

  const tick = () => {
    if (!scanning) return;

    if (video.readyState >= 2) {
      const w = video.videoWidth;
      const h = video.videoHeight;
      if (w && h) {
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(video, 0, 0, w, h);
        const img = ctx.getImageData(0, 0, w, h);

        const code = jsQR(img.data, w, h, { inversionAttempts: "attemptBoth" });
        if (code && code.data) {
          handleScannedText(code.data);
          return; // stop inside handler
        }
      }
    }
    rafId = requestAnimationFrame(tick);
  };

  rafId = requestAnimationFrame(tick);
}

function stopScan() {
  scanning = false;
  if (rafId) cancelAnimationFrame(rafId);
  rafId = null;

  const video = document.getElementById("video");
  if (video) video.srcObject = null;

  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

function handleScannedText(text) {
  // Stop scanning immediately (prevents double read)
  stopScan();
  document.getElementById("modalBack").style.display = "none";

  // Some QR contains full URL
  let url = null;
  try { url = new URL(text); } catch(e) { /* not a URL */ }

  if (currentScanMode === "owner") {
    const dt = url ? url.searchParams.get("dt") : (new URLSearchParams(text.split("?")[1] || "")).get("dt");
    if (!dt) return alert("Pair QR invalid (dt missing).");
    saveDeviceToken(dt);
    setPairedUI(true, dt.slice(0,8) + "‚Ä¶");
    alert("Device paired ‚úÖ");
    return;
  }

  // Voucher mode
  let voucher = null;
  let sig = null;

  if (url) {
    voucher = url.searchParams.get("voucher");
    sig = url.searchParams.get("sig");
  } else {
    // could be raw voucher id
    voucher = text.trim();
  }

  if (!voucher) return alert("Voucher ID missing.");
  document.getElementById("voucherId").value = voucher;

  // If sig is present in scanned URL, preserve it in URL for QR signature check flow
  if (sig) {
    const u = new URL(window.location.href);
    u.searchParams.set("voucher", voucher);
    u.searchParams.set("sig", sig);
    window.history.replaceState({}, "", u.toString());
  }

  checkVoucher();
}

// ---------- API ----------
async function checkVoucher() {
  const id = document.getElementById("voucherId").value.trim();
  if (!id) return alert("Enter voucher ID");

  const dt = getDeviceToken(); // pairing token required for validate/dispense
  const sig = qs("sig"); // if attendant opened via customer QR link

  const box = document.getElementById("voucherBox");
  const dataDiv = document.getElementById("voucherData");
  const statusMsg = document.getElementById("statusMsg");
  const btn = document.getElementById("dispenseBtn");

  box.style.display = "block";
  dataDiv.innerHTML = `<p>Loading‚Ä¶</p>`;
  statusMsg.textContent = "";
  btn.disabled = true;
  btn.textContent = "‚úÖ Dispense Fuel";

  // If not paired, show message but still allow viewing voucher basic info (your backend may block it)
  const headers = {};
  if (dt) headers["X-DEVICE-TOKEN"] = dt;

  // If your backend expects signed QR validation, pass sig to /voucher endpoint (if supported)
  const url = sig
    ? `${API}/voucher/${encodeURIComponent(id)}?sig=${encodeURIComponent(sig)}`
    : `${API}/voucher/${encodeURIComponent(id)}`;

  const res = await fetch(url, { headers, cache:"no-store" });
  const v = await res.json();

  if (!res.ok) {
    dataDiv.innerHTML = `<p style="color:#b91c1c;font-weight:900;">${v.detail || "Validation failed"}</p>`;
    // Scroll to status area
    document.getElementById("statusAnchor").scrollIntoView({ behavior:"smooth", block:"start" });
    return;
  }

  const st = (v.status || "").toLowerCase();
  const chipClass = st === "paid" ? "paid" : st === "used" ? "used" : "pend";

  dataDiv.innerHTML = `
    <p><strong>ID:</strong> ${v.id}</p>
    <p><strong>Customer:</strong> ${v.customer_name || "Walk-in"} (${v.customer_phone || "-"})</p>
    <p><strong>Fuel Type:</strong> ${v.fuel_type || "-"}</p>
    <p><strong>Amount:</strong> ‚Çπ${Number(v.amount||0).toLocaleString("en-IN")}</p>
    <p><strong>Litres:</strong> ${Number(v.litres||0)} L</p>
    <p><strong>Vehicle:</strong> ${(v.vehicle_type||"-")} ¬∑ ${(v.vehicle_no||"-")}</p>
    <p><strong>Status:</strong> <span class="status-chip ${chipClass}">${st.toUpperCase()}</span></p>
    <p><strong>QR Signature:</strong> <span style="font-weight:900;color:#16a34a;">OK</span></p>
  `;

  if (!dt) {
    statusMsg.innerHTML = `‚ùå Validation failed: Unauthorized (device not paired).`;
    statusMsg.style.color = "#b91c1c";
    btn.disabled = true;
    document.getElementById("statusAnchor").scrollIntoView({ behavior:"smooth", block:"start" });
    return;
  }

  if (st === "paid") {
    statusMsg.textContent = "‚úÖ Ready to dispense.";
    statusMsg.style.color = "#166534";
    btn.disabled = false;
  } else if (st === "used") {
    statusMsg.textContent = "‚ö†Ô∏è Voucher already used.";
    statusMsg.style.color = "#6b7280";
    btn.disabled = true;
  } else {
    statusMsg.textContent = "‚è≥ Not paid yet / pending.";
    statusMsg.style.color = "#b45309";
    btn.disabled = true;
  }

  // Auto-scroll to status so attendant sees it immediately
  document.getElementById("statusAnchor").scrollIntoView({ behavior:"smooth", block:"start" });
}

async function dispenseFuel() {
  const id = document.getElementById("voucherId").value.trim();
  if (!id) return;

  const dt = getDeviceToken();
  if (!dt) return alert("Device not paired.");

  const btn = document.getElementById("dispenseBtn");
  const statusMsg = document.getElementById("statusMsg");

  btn.disabled = true;
  btn.textContent = "Processing‚Ä¶";

  const res = await fetch(`${API}/voucher/${encodeURIComponent(id)}/use`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-DEVICE-TOKEN": dt
    },
    body: JSON.stringify({})
  });

  const data = await res.json();

  if (!res.ok) {
    btn.disabled = false;
    btn.textContent = "‚úÖ Dispense Fuel";
    statusMsg.textContent = "‚ùå Dispense failed: " + (data.detail || "Unknown error");
    statusMsg.style.color = "#b91c1c";
    document.getElementById("statusAnchor").scrollIntoView({ behavior:"smooth", block:"start" });
    return;
  }

  // ‚úÖ Front-end UX fix requested:
  // - Show Done
  // - Disable button
  // - Auto-scroll to status
  statusMsg.textContent = "‚úî Dispensed. Voucher marked USED.";
  statusMsg.style.color = "#166534";

  btn.textContent = "‚úî Done";
  btn.disabled = true;

  // Refresh voucher details so status shows USED
  await checkVoucher();

  document.getElementById("statusAnchor").scrollIntoView({ behavior:"smooth", block:"start" });
}
</script>
</body>
</html>
