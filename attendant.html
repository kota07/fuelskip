<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FuelSkip - Attendant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 50% -20%, #1f2b44, #0b1220 60%, #070b14);
      color:#0f172a;
    }
    .wrap{max-width:560px;margin:0 auto}
    h1{margin:6px 0 14px;color:#e5e7eb;font-weight:900;letter-spacing:.2px;text-align:center}
    .card{
      background:#ffffff;
      border-radius:18px;
      box-shadow:0 14px 30px rgba(2,6,23,.35);
      padding:16px;
      margin-bottom:14px;
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .muted{color:#64748b;font-size:13px;line-height:1.35}
    .pill{
      display:inline-block;padding:5px 10px;border-radius:999px;font-weight:900;font-size:12px;
      letter-spacing:.3px
    }
    .ok{background:#dcfce7;color:#166534}
    .bad{background:#fee2e2;color:#b91c1c}
    .btn{
      border:none;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer;
      box-shadow:0 10px 20px rgba(2,6,23,.12);
    }
    .btn:active{transform:scale(.98)}
    .btn-dark{background:#111827;color:#fff}
    .btn-blue{background:#3b82f6;color:#fff}
    .btn-green{background:#10b981;color:#fff}
    .btn-red{background:#ef4444;color:#fff}
    .btn-disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid #e2e8f0;
      font-size:15px;
      outline:none;
    }
    .scanBox{
      background:#0b1220;
      border-radius:16px;
      padding:12px;
      color:#e5e7eb;
    }
    .modalBack{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(520px,100%);
      background:#fff;border-radius:18px;overflow:hidden;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .modalHeader{
      padding:14px 14px;background:#0b1220;color:#fff;font-weight:900;
      display:flex;align-items:center;justify-content:space-between;
    }
    .modalBody{padding:14px}
    #qrReader{width:100%;border-radius:14px;overflow:hidden}
    .kv{margin:6px 0;font-size:15px}
    .kv b{display:inline-block;min-width:110px}
    .statusLine{
      margin-top:10px;
      font-weight:900;
      font-size:16px;
    }
    .statusOk{color:#166534}
    .statusWarn{color:#b45309}
    .statusBad{color:#b91c1c}
    .bigBtn{width:100%;font-size:18px;padding:14px 14px;border-radius:16px}
    .hint{
      margin-top:8px;font-size:12px;color:#64748b;
      background:#f1f5f9;border:1px solid #e2e8f0;padding:10px;border-radius:14px
    }
    .divider{height:1px;background:#e2e8f0;margin:12px 0}
  </style>
</head>

<body>
<div class="wrap">
  <h1>‚õΩ FuelSkip ‚Äì Attendant</h1>

  <div class="card" id="pairCard">
    <div class="row">
      <div style="font-weight:900;font-size:18px">
        Device:
        <span id="pairState" class="pill bad">NOT PAIRED</span>
      </div>
      <button class="btn btn-red" id="resetBtn">Reset</button>
    </div>

    <div class="muted" style="margin-top:8px">
      Pair once using Owner QR (<code>dt=...</code>). After that, scan voucher QR inside this page (don‚Äôt open new tabs).
      <div style="margin-top:6px">
        Origin: <span id="originTxt"></span> ¬∑ Token: <span id="tokTxt">‚Äî</span>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <button class="btn btn-dark" id="scanOwnerBtn">üîó Scan Owner Pair QR</button>
      <button class="btn btn-dark" id="scanVoucherBtn">üì∑ Scan Voucher QR</button>
    </div>

    <div class="hint">
      Tip: For iPhone, use Safari or the Home Screen app (PWA). Some in-app browsers block camera.
    </div>
  </div>

  <div class="card">
    <div class="scanBox">
      <div class="row" style="align-items:flex-end">
        <div style="flex:1">
          <div style="font-weight:900;margin-bottom:8px">Voucher ID / Link</div>
          <input id="voucherInput" placeholder="Paste voucher ID or scanned link" />
          <div class="muted" style="margin-top:8px;color:#cbd5e1">
            Customer QR usually contains a link like: <code>/attendant.html?voucher=...&sig=...</code>
          </div>
        </div>
        <div style="min-width:120px">
          <button class="btn btn-blue" style="width:100%" id="checkBtn">Check</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card" id="detailsCard" style="display:none">
    <div style="font-weight:900;font-size:20px;margin-bottom:10px">Voucher Details</div>
    <div id="details"></div>

    <div id="statusBox" style="margin-top:10px"></div>

    <div style="margin-top:12px">
      <button class="btn btn-green bigBtn" id="dispenseBtn">‚úÖ Dispense Fuel</button>
    </div>

    <div class="hint" id="dispenseHint" style="display:none"></div>
  </div>
</div>

<!-- Modal for scanning -->
<div class="modalBack" id="modalBack">
  <div class="modal">
    <div class="modalHeader">
      <div id="modalTitle">Scan QR</div>
      <button class="btn btn-red" id="modalClose" style="padding:8px 12px;border-radius:12px">Close</button>
    </div>
    <div class="modalBody">
      <div class="muted" id="modalHelp" style="margin-bottom:10px"></div>
      <div id="qrReader"></div>
    </div>
  </div>
</div>

<script>
  const API = window.location.origin;

  const LS_DEVICE_TOKEN = "FUELSKIP_DEVICE_TOKEN";  // persists pairing
  const LS_ORIGIN = "FUELSKIP_ORIGIN";

  const elPairState = document.getElementById("pairState");
  const elTokTxt = document.getElementById("tokTxt");
  const elOriginTxt = document.getElementById("originTxt");

  const elVoucherInput = document.getElementById("voucherInput");
  const elCheckBtn = document.getElementById("checkBtn");

  const elDetailsCard = document.getElementById("detailsCard");
  const elDetails = document.getElementById("details");
  const elStatusBox = document.getElementById("statusBox");
  const elDispenseBtn = document.getElementById("dispenseBtn");
  const elDispenseHint = document.getElementById("dispenseHint");

  const modalBack = document.getElementById("modalBack");
  const modalTitle = document.getElementById("modalTitle");
  const modalHelp = document.getElementById("modalHelp");
  const modalClose = document.getElementById("modalClose");
  const qrReaderDiv = document.getElementById("qrReader");

  let lastVoucher = null; // current loaded voucher object
  let qrScanner = null;
  let scanMode = null; // "owner" | "voucher"

  function getDeviceToken(){
    return (localStorage.getItem(LS_DEVICE_TOKEN) || "").trim();
  }

  function setDeviceToken(t){
    localStorage.setItem(LS_DEVICE_TOKEN, t);
  }

  function clearDevice(){
    localStorage.removeItem(LS_DEVICE_TOKEN);
    localStorage.removeItem(LS_ORIGIN);
    renderPairState();
  }

  function renderPairState(){
    const tok = getDeviceToken();
    const origin = localStorage.getItem(LS_ORIGIN) || API;
    elOriginTxt.textContent = origin;
    if(tok){
      elPairState.textContent = "PAIRED";
      elPairState.className = "pill ok";
      elTokTxt.textContent = tok.slice(0,8) + "‚Ä¶";
    }else{
      elPairState.textContent = "NOT PAIRED";
      elPairState.className = "pill bad";
      elTokTxt.textContent = "‚Äî";
    }
  }

  function parseVoucherFromText(txt){
    const t = (txt || "").trim();
    if(!t) return { voucher_id:"", sig:"" };

    // If full URL, parse query
    try{
      const u = new URL(t);
      const voucher_id = u.searchParams.get("voucher") || "";
      const sig = u.searchParams.get("sig") || "";
      if(voucher_id) return { voucher_id, sig };
    }catch(e){}

    // If just query string
    if(t.includes("voucher=")){
      const qs = t.includes("?") ? t.split("?")[1] : t;
      const p = new URLSearchParams(qs);
      return { voucher_id: p.get("voucher") || "", sig: p.get("sig") || "" };
    }

    // else treat as voucher id only
    return { voucher_id: t, sig:"" };
  }

  async function apiGetVoucher(voucher_id, sig){
    const tok = getDeviceToken();
    const headers = {};
    if(tok) headers["X-DEVICE-TOKEN"] = tok;
    if(sig) headers["X-QR-SIGNATURE"] = sig;

    const res = await fetch(`${API}/vouchers/${encodeURIComponent(voucher_id)}`, { headers, cache:"no-store" });
    const data = await res.json().catch(()=> ({}));
    return { ok: res.ok, status: res.status, data };
  }

  async function apiDispense(voucher_id){
    const tok = getDeviceToken();
    const headers = { "Content-Type":"application/json" };
    if(tok) headers["X-DEVICE-TOKEN"] = tok;

    const res = await fetch(`${API}/vouchers/${encodeURIComponent(voucher_id)}/use`, {
      method:"POST",
      headers,
      body: JSON.stringify({})
    });
    const data = await res.json().catch(()=> ({}));
    return { ok: res.ok, status: res.status, data };
  }

  function scrollToStatus(){
    const target = elDetailsCard;
    target.scrollIntoView({ behavior:"smooth", block:"start" });
    setTimeout(()=> {
      elStatusBox.scrollIntoView({ behavior:"smooth", block:"center" });
    }, 250);
  }

  function renderVoucher(v){
    lastVoucher = v;
    elDetailsCard.style.display = "block";
    elDispenseHint.style.display = "none";
    elDispenseHint.textContent = "";

    const st = (v.status || "").toUpperCase();
    const statusPill = st === "USED"
      ? `<span class="pill" style="background:#e0f2fe;color:#075985">USED</span>`
      : st === "PAID"
        ? `<span class="pill ok">PAID</span>`
        : `<span class="pill bad">${st || "UNKNOWN"}</span>`;

    elDetails.innerHTML = `
      <div class="kv"><b>ID:</b> ${v.id || "-"}</div>
      <div class="kv"><b>Customer:</b> ${(v.customer_name || "Walk-in")} (${(v.customer_phone || "-")})</div>
      <div class="kv"><b>Fuel Type:</b> ${((v.fuel_type || "PETROL").toString()).toUpperCase()}</div>
      <div class="kv"><b>Amount:</b> ‚Çπ${Number(v.amount||0).toLocaleString("en-IN")}</div>
      <div class="kv"><b>Litres:</b> ${Number(v.litres||0).toFixed(2)} L</div>
      <div class="kv"><b>Vehicle:</b> ${(v.vehicle_type || "-")}  ¬∑  ${(v.vehicle_no || "-")}</div>
      <div class="kv"><b>Status:</b> ${statusPill}</div>
      <div class="kv"><b>QR Signature:</b> <span class="${v.qr_ok ? "statusOk":"statusBad"}" style="font-weight:900">
        ${v.qr_ok ? "OK" : "INVALID"}
      </span></div>
    `;

    // Status / action section
    if(st === "USED"){
      elStatusBox.innerHTML = `<div class="statusLine statusWarn">‚ö†Ô∏è Voucher already used.</div>`;
      setDoneButton();
      return;
    }

    if(!getDeviceToken()){
      elStatusBox.innerHTML = `<div class="statusLine statusBad">‚ùå Validation failed: device not paired.</div>`;
      resetDispenseButton();
      return;
    }

    if(!v.qr_ok){
      elStatusBox.innerHTML = `<div class="statusLine statusBad">‚ùå QR signature invalid. Do not dispense.</div>`;
      resetDispenseButton();
      return;
    }

    if(st === "PAID"){
      elStatusBox.innerHTML = `<div class="statusLine statusOk">‚úÖ Ready to dispense.</div>`;
      resetDispenseButton();
      return;
    }

    elStatusBox.innerHTML = `<div class="statusLine statusBad">‚ùå Not payable state.</div>`;
    resetDispenseButton();
  }

  function resetDispenseButton(){
    elDispenseBtn.textContent = "‚úÖ Dispense Fuel";
    elDispenseBtn.className = "btn btn-green bigBtn";
    elDispenseBtn.disabled = false;
    elDispenseBtn.classList.remove("btn-disabled");
  }

  function setDoneButton(){
    elDispenseBtn.textContent = "‚úî Done";
    elDispenseBtn.className = "btn btn-green bigBtn";
    elDispenseBtn.disabled = true;
    elDispenseBtn.classList.add("btn-disabled");
  }

  async function onCheck(){
    const parsed = parseVoucherFromText(elVoucherInput.value);
    if(!parsed.voucher_id){
      alert("Voucher ID missing");
      return;
    }
    const r = await apiGetVoucher(parsed.voucher_id, parsed.sig);
    if(!r.ok){
      const msg = (r.data && (r.data.detail || r.data.message)) || "Check failed";
      elDetailsCard.style.display = "block";
      elDetails.innerHTML = "";
      elStatusBox.innerHTML = `<div class="statusLine statusBad">‚ùå ${msg}</div>`;
      resetDispenseButton();
      scrollToStatus();
      return;
    }
    // Backend may return qr_ok field; if not, treat signature ok if provided
    const v = r.data || {};
    if(typeof v.qr_ok === "undefined"){
      v.qr_ok = true;
    }
    renderVoucher(v);
    scrollToStatus();
  }

  async function onDispense(){
    if(!lastVoucher || !lastVoucher.id) return;

    // prevent double taps
    elDispenseBtn.disabled = true;
    elDispenseBtn.classList.add("btn-disabled");
    elDispenseBtn.textContent = "Dispensing‚Ä¶";

    const r = await apiDispense(lastVoucher.id);
    if(!r.ok){
      resetDispenseButton();
      const msg = (r.data && (r.data.detail || r.data.message)) || "Dispense failed";

      elStatusBox.innerHTML = `<div class="statusLine statusBad">‚ùå Dispense failed: ${msg}</div>`;

      // Helpful hint if it looks like bunk mismatch / not found
      if(String(msg).toLowerCase().includes("not found")){
        elDispenseHint.style.display = "block";
        elDispenseHint.textContent =
          "Hint: This often happens if the voucher was created for a different bunk than this paired device. Re-pair using the correct Owner Pair QR for that bunk, then try again.";
      }else{
        elDispenseHint.style.display = "none";
      }

      scrollToStatus();
      return;
    }

    // Success: mark UI as USED and lock button
    elStatusBox.innerHTML = `<div class="statusLine statusOk">‚úÖ Dispensed. Voucher marked USED.</div>`;
    setDoneButton();

    // Also refresh voucher details to show USED badge
    try{
      const rr = await apiGetVoucher(lastVoucher.id, "");
      if(rr.ok){
        const v = rr.data || {};
        if(typeof v.qr_ok === "undefined") v.qr_ok = true;
        renderVoucher(v);
      }
    }catch(e){}

    scrollToStatus();
  }

  function openScanner(mode){
    scanMode = mode;
    modalBack.style.display = "flex";
    qrReaderDiv.innerHTML = ""; // reset

    modalTitle.textContent = mode === "owner" ? "Scan Owner Pair QR" : "Scan Voucher QR";
    modalHelp.textContent = mode === "owner"
      ? "Point camera at Owner Pair QR (contains dt=...)."
      : "Point camera at Voucher QR (contains voucher=...&sig=...).";

    // Start scanner
    qrScanner = new Html5Qrcode("qrReader");

    const config = { fps: 10, qrbox: { width: 240, height: 240 } };

    qrScanner.start(
      { facingMode: "environment" },
      config,
      (decodedText) => {
        // success
        onScanResult(decodedText);
      },
      () => {}
    ).catch((err)=>{
      alert("Camera not available. Use manual paste or open in Safari/Chrome.");
      closeScanner();
    });
  }

  function closeScanner(){
    modalBack.style.display = "none";
    if(qrScanner){
      qrScanner.stop().catch(()=>{}).finally(()=>{
        qrScanner.clear();
        qrScanner = null;
      });
    }
  }

  function onScanResult(text){
    if(scanMode === "owner"){
      // Expect dt token inside scanned url
      try{
        const u = new URL(text);
        const dt = u.searchParams.get("dt");
        if(!dt){
          alert("Owner QR invalid (dt missing).");
          return;
        }
        setDeviceToken(dt);
        localStorage.setItem(LS_ORIGIN, u.origin);
        renderPairState();
        closeScanner();
        alert("Paired ‚úÖ");
      }catch(e){
        // if plain text includes dt=
        if(String(text).includes("dt=")){
          const qs = text.includes("?") ? text.split("?")[1] : text;
          const p = new URLSearchParams(qs);
          const dt = p.get("dt");
          if(dt){
            setDeviceToken(dt);
            localStorage.setItem(LS_ORIGIN, API);
            renderPairState();
            closeScanner();
            alert("Paired ‚úÖ");
            return;
          }
        }
        alert("Owner QR invalid.");
      }
      return;
    }

    // voucher scan
    elVoucherInput.value = text;
    closeScanner();
    onCheck();
  }

  // Buttons
  document.getElementById("scanOwnerBtn").addEventListener("click", ()=> openScanner("owner"));
  document.getElementById("scanVoucherBtn").addEventListener("click", ()=> openScanner("voucher"));
  modalClose.addEventListener("click", closeScanner);
  modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeScanner(); });

  elCheckBtn.addEventListener("click", onCheck);
  elDispenseBtn.addEventListener("click", onDispense);

  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(confirm("Reset pairing on this device?")){
      clearDevice();
      alert("Cleared. Pair again using Owner QR.");
    }
  });

  // Auto-pair if dt exists in URL (Owner QR may open this page)
  window.addEventListener("load", ()=>{
    renderPairState();
    const params = new URLSearchParams(window.location.search);
    const dt = params.get("dt");
    if(dt){
      setDeviceToken(dt);
      localStorage.setItem(LS_ORIGIN, API);
      renderPairState();
      history.replaceState({}, "", window.location.pathname); // clean URL
      setTimeout(()=> alert("Paired ‚úÖ"), 50);
    }

    // If voucher link opened (voucher=...&sig=...), prefill and check
    const voucher = params.get("voucher");
    const sig = params.get("sig");
    if(voucher){
      elVoucherInput.value = `${API}/attendant.html?voucher=${encodeURIComponent(voucher)}&sig=${encodeURIComponent(sig||"")}`;
      setTimeout(()=> onCheck(), 100);
      history.replaceState({}, "", window.location.pathname); // clean URL
    }
  });
</script>
</body>
</html>
