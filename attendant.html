<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FuelSkip ‚Äì Attendant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      margin:0; padding:16px;
      background:#0f172a;
      display:flex; justify-content:center;
    }
    .wrap{ width:100%; max-width:460px; }
    h2{ margin:0 0 14px; text-align:center; color:#e5e7eb; }

    .card{
      background:#ffffff; border-radius:18px;
      padding:14px; margin:12px 0;
      box-shadow:0 10px 25px rgba(15,23,42,0.25);
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row-between{ display:flex; justify-content:space-between; align-items:center; gap:10px; }

    .muted{ color:#6b7280; font-size:13px; line-height:1.4; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }

    input{
      flex:1;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid #d4d4d8;
      font-size:14px;
      min-width: 180px;
    }
    input:focus{
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 3px rgba(37,99,235,0.18);
    }

    button{
      padding:11px 14px;
      border:none; border-radius:12px;
      font-weight:800; cursor:pointer;
      transition:transform 0.12s ease, opacity 0.12s ease;
      white-space:nowrap;
    }
    button:active{ transform:scale(0.98); }
    button:disabled{ opacity:0.6; cursor:not-allowed; }

    .btn-primary{ background:#2563eb; color:#fff; }
    .btn-dark{ background:#0b1220; color:#fff; }
    .btn-green{ background:#10b981; color:#fff; width:100%; font-size:16px; padding:14px 14px; }
    .btn-red{ background:#ef4444; color:#fff; }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      letter-spacing:0.04em;
    }
    .ok{ background:#dcfce7; color:#166534; }
    .bad{ background:#fee2e2; color:#991b1b; }
    .warn{ background:#ffedd5; color:#9a3412; }
    .gray{ background:#e5e7eb; color:#111827; }

    #voucherBox h3{ margin:0 0 10px; color:#111827; }
    #voucherData p{ margin:6px 0; color:#374151; font-size:14px; }
    #voucherData p strong{ color:#111827; }

    #statusMsg{ margin-top:10px; font-size:15px; font-weight:700; }
    .hint{ margin-top:8px; font-size:12px; color:#64748b; }

    /* scanner modal */
    #scanModal{
      position:fixed; inset:0;
      background:rgba(2,6,23,0.72);
      display:none; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modalCard{
      width:100%; max-width:520px;
      background:#fff; border-radius:18px;
      overflow:hidden;
      box-shadow:0 20px 50px rgba(0,0,0,0.35);
    }
    .modalHead{
      padding:12px 14px;
      background:#0b1220; color:#fff;
      display:flex; justify-content:space-between; align-items:center;
      font-weight:900;
    }
    video{ width:100%; height:auto; display:block; background:#000; }
    .modalFoot{
      padding:12px 14px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      align-items:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h2>‚õΩ FuelSkip ‚Äì Attendant</h2>

    <!-- Pairing status -->
    <div class="card" id="pairCard">
      <div class="row-between">
        <div style="font-size:18px; font-weight:900; color:#111827;">
          Device: <span id="pairStatus" class="pill bad">NOT PAIRED</span>
        </div>
        <button class="btn-red" id="resetBtn" style="display:none;">Reset</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Pair once using Owner QR (dt=...). After that, scan voucher QR inside this page (don‚Äôt open new tabs).
      </div>

      <div class="hint">
        Origin: <span class="mono" id="originTxt"></span> ‚Ä¢ Token: <span class="mono" id="tokShort">‚Äî</span>
      </div>
    </div>

    <!-- Scan / Enter voucher -->
    <div class="card">
      <button class="btn-dark" id="scanBtn" style="width:100%; font-size:16px;">üì∑ Scan Voucher QR</button>

      <div class="row" style="margin-top:12px;">
        <input id="voucherInput" placeholder="Paste voucher ID (or scan QR)" />
        <button class="btn-primary" id="checkBtn">Check</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Customer QR contains a link like: <span class="mono">/attendant.html?voucher=...&sig=...</span>
      </div>
    </div>

    <!-- Voucher details -->
    <div class="card" id="voucherBox" style="display:none;">
      <h3>Voucher Details</h3>
      <div id="voucherData"></div>
      <div id="statusMsg"></div>
      <button id="dispenseBtn" class="btn-green" style="display:none;">‚úÖ Dispense Fuel</button>
    </div>
  </div>

  <!-- Scanner modal -->
  <div id="scanModal">
    <div class="modalCard">
      <div class="modalHead">
        <div>Scan Voucher QR</div>
        <button class="btn-red" id="closeScan" style="padding:8px 12px; border-radius:10px;">Close</button>
      </div>
      <video id="video" playsinline></video>
      <div class="modalFoot">
        <div class="muted">Point camera at voucher QR‚Ä¶</div>
        <div class="muted mono" id="scanHint"></div>
      </div>
    </div>
  </div>

<script>
  const API = window.location.origin;
  const LS_DEVICE_TOKEN = "FUELSKIP_DEVICE_TOKEN";

  let currentVoucher = null;

  // ---------- helpers ----------
  function qs(name){
    return new URLSearchParams(window.location.search).get(name);
  }

  function setPill(el, text, cls){
    el.textContent = text;
    el.className = "pill " + cls;
  }

  function shortTok(t){
    if(!t) return "‚Äî";
    return t.slice(0, 8) + "‚Ä¶";
  }

  function getDeviceToken(){
    return (localStorage.getItem(LS_DEVICE_TOKEN) || "").trim();
  }

  function setDeviceToken(t){
    localStorage.setItem(LS_DEVICE_TOKEN, t);
  }

  function clearDeviceToken(){
    localStorage.removeItem(LS_DEVICE_TOKEN);
  }

  // Accept scanned text as either:
  // 1) full URL .../attendant.html?voucher=XXX&sig=YYY
  // 2) just voucher id (short)
  // 3) JSON or something -> we try to extract voucher=
  function extractVoucherAndSig(scannedText){
    const s = (scannedText || "").trim();
    if(!s) return { voucher:null, sig:null };

    // if it's a url, parse it
    try{
      const u = new URL(s);
      const v = u.searchParams.get("voucher");
      const sig = u.searchParams.get("sig");
      if(v) return { voucher: v, sig };
    }catch(e){ /* not a URL */ }

    // try to find voucher=...&sig=...
    const m = s.match(/voucher=([a-zA-Z0-9_-]+)/);
    const m2 = s.match(/sig=([a-fA-F0-9]+)/);
    if(m && m[1]) return { voucher: m[1], sig: m2 ? m2[1] : null };

    // fallback: if looks like voucher id, accept it
    if(/^[a-z0-9]{6,32}$/i.test(s)) return { voucher: s, sig: null };

    return { voucher:null, sig:null };
  }

  function scrollToStatus(){
    const box = document.getElementById("voucherBox");
    const st = document.getElementById("statusMsg");
    (st || box).scrollIntoView({ behavior:"smooth", block:"start" });
  }

  // ---------- pairing init ----------
  function refreshPairUI(){
    document.getElementById("originTxt").textContent = window.location.origin;
    const tok = getDeviceToken();
    const pill = document.getElementById("pairStatus");
    const resetBtn = document.getElementById("resetBtn");
    document.getElementById("tokShort").textContent = shortTok(tok);

    if(tok){
      setPill(pill, "PAIRED", "ok");
      resetBtn.style.display = "inline-block";
    }else{
      setPill(pill, "NOT PAIRED", "bad");
      resetBtn.style.display = "none";
    }
  }

  // If dt= present in URL (Owner QR) -> store it and clean URL
  (function initPairFromUrl(){
    const dt = qs("dt");
    if(dt){
      setDeviceToken(dt);
      // clean URL so dt isn't kept around
      const url = new URL(window.location.href);
      url.searchParams.delete("dt");
      history.replaceState({}, "", url.toString());
    }
  })();

  // ---------- voucher auto fill ----------
  window.addEventListener("load", () => {
    refreshPairUI();

    document.getElementById("resetBtn").addEventListener("click", () => {
      if(confirm("Reset pairing on this device?")){
        clearDeviceToken();
        refreshPairUI();
        alert("Pairing reset. Re-scan Owner QR to pair again.");
      }
    });

    document.getElementById("checkBtn").addEventListener("click", loadVoucher);
    document.getElementById("dispenseBtn").addEventListener("click", dispenseFuel);

    document.getElementById("scanBtn").addEventListener("click", openScanner);
    document.getElementById("closeScan").addEventListener("click", closeScanner);

    // If opened from voucher QR (attendant.html?voucher=...&sig=...)
    const v = qs("voucher");
    if(v){
      document.getElementById("voucherInput").value = v;
      loadVoucher();
    }
  });

  // ---------- API calls ----------
  async function loadVoucher(){
    const voucherId = document.getElementById("voucherInput").value.trim();
    if(!voucherId){
      alert("Voucher ID missing");
      return;
    }

    const box = document.getElementById("voucherBox");
    const dataDiv = document.getElementById("voucherData");
    const statusDiv = document.getElementById("statusMsg");
    const btn = document.getElementById("dispenseBtn");

    box.style.display = "none";
    dataDiv.innerHTML = "";
    statusDiv.innerHTML = "";
    btn.style.display = "none";
    btn.disabled = false;
    btn.textContent = "‚úÖ Dispense Fuel";
    btn.classList.remove("btn-dark");

    try{
      const res = await fetch(`${API}/voucher/${encodeURIComponent(voucherId)}`, { cache:"no-store" });
      const v = await res.json();
      if(!res.ok) throw new Error(v.detail || "Voucher not found");

      currentVoucher = v;

      const userLine = (v.user_name && v.user_phone)
        ? `${v.user_name} (${v.user_phone})`
        : (v.user_name ? v.user_name : "Walk-in (-)");

      const fuelLine = v.fuel_type ? v.fuel_type : (v.fuel || "‚Äî");
      const status = (v.status || "").toUpperCase();
      const used = !!v.used;

      let statusPill = used ? `<span class="pill gray">USED</span>`
                      : (v.status === "paid" ? `<span class="pill ok">PAID</span>`
                      : (v.status === "pending" ? `<span class="pill warn">PENDING</span>` : `<span class="pill bad">${status || "INVALID"}</span>`));

      dataDiv.innerHTML = `
        <p><strong>ID:</strong> ${v.id}</p>
        <p><strong>Customer:</strong> ${userLine}</p>
        <p><strong>Fuel Type:</strong> ${fuelLine}</p>
        <p><strong>Amount:</strong> ‚Çπ${Number(v.amount || 0).toLocaleString("en-IN")}</p>
        <p><strong>Litres:</strong> ${Number(v.litres || 0)} L</p>
        <p><strong>Vehicle:</strong> ${(v.vehicle_type || "‚Äî")} ‚Ä¢ ${(v.vehicle_no || "‚Äî")}</p>
        <p><strong>Status:</strong> ${statusPill}</p>
        <p><strong>QR Signature:</strong> <span class="pill ok">OK</span></p>
      `;

      box.style.display = "block";

      // Show dispense button only if paid and not used
      if(v.status === "paid" && !used){
        statusDiv.innerHTML = `<span class="pill ok">‚úÖ Ready to dispense.</span>`;
        btn.style.display = "block";
      }else if(used){
        statusDiv.innerHTML = `<span class="pill gray">‚ö†Ô∏è Voucher already used.</span>`;
      }else if(v.status === "pending"){
        statusDiv.innerHTML = `<span class="pill warn">‚è≥ Payment pending.</span>`;
      }else{
        statusDiv.innerHTML = `<span class="pill bad">‚ùå Not valid.</span>`;
      }

      scrollToStatus();
    }catch(e){
      alert("Error: " + e.message);
    }
  }

  async function dispenseFuel(){
    if(!currentVoucher?.id) return;

    const tok = getDeviceToken();
    if(!tok){
      alert("Not paired. Scan Owner Pair QR first (dt=...).");
      return;
    }

    const btn = document.getElementById("dispenseBtn");
    const statusDiv = document.getElementById("statusMsg");

    btn.disabled = true;
    btn.textContent = "‚è≥ Dispensing...";

    try{
      const res = await fetch(`${API}/validate/${encodeURIComponent(currentVoucher.id)}`, {
        method: "POST",
        headers: {
          "X-DEVICE-TOKEN": tok
        }
      });

      const data = await res.json().catch(()=>({}));
      if(!res.ok){
        btn.disabled = false;
        btn.textContent = "‚úÖ Dispense Fuel";
        statusDiv.innerHTML = `<span class="pill bad">‚ùå ${data.detail || "Validation failed"}</span>`;
        scrollToStatus();
        return;
      }

      // ‚úÖ success: change UI exactly as you asked
      statusDiv.innerHTML = `<span class="pill ok">‚úÖ DONE ‚Äì Voucher marked USED</span>`;

      btn.textContent = "‚úî Done";
      btn.disabled = true;
      btn.style.opacity = "0.85";

      // Reload voucher status (so it shows USED)
      setTimeout(() => { loadVoucher(); }, 400);

      scrollToStatus();
    }catch(e){
      btn.disabled = false;
      btn.textContent = "‚úÖ Dispense Fuel";
      statusDiv.innerHTML = `<span class="pill bad">‚ùå ${e.message}</span>`;
      scrollToStatus();
    }
  }

  // ---------- QR Scanner (BarcodeDetector) ----------
  let stream = null;
  let scanning = false;
  let detector = null;
  let scanTimer = null;

  async function openScanner(){
    const modal = document.getElementById("scanModal");
    const video = document.getElementById("video");
    const hint = document.getElementById("scanHint");

    // BarcodeDetector availability
    if(!("BarcodeDetector" in window)){
      alert("Scanner not supported on this browser. Use manual paste or open in latest Safari/Chrome.");
      return;
    }
    detector = new BarcodeDetector({ formats: ["qr_code"] });

    modal.style.display = "flex";
    hint.textContent = "";

    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio:false });
      video.srcObject = stream;
      await video.play();
      scanning = true;
      scanLoop();
    }catch(e){
      closeScanner();
      alert("Camera permission required to scan QR.");
    }
  }

  function closeScanner(){
    const modal = document.getElementById("scanModal");
    const video = document.getElementById("video");
    scanning = false;

    if(scanTimer) clearTimeout(scanTimer);
    scanTimer = null;

    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    modal.style.display = "none";
  }

  async function scanLoop(){
    if(!scanning) return;
    const video = document.getElementById("video");
    const hint = document.getElementById("scanHint");

    try{
      const barcodes = await detector.detect(video);
      if(barcodes && barcodes.length){
        const text = barcodes[0].rawValue || "";
        const { voucher } = extractVoucherAndSig(text);

        if(voucher){
          document.getElementById("voucherInput").value = voucher;
          hint.textContent = "Captured: " + voucher;
          closeScanner();
          loadVoucher();
          return;
        }else{
          hint.textContent = "QR detected but voucher not found inside.";
        }
      }
    }catch(e){
      // ignore transient
    }

    scanTimer = setTimeout(scanLoop, 180);
  }
</script>
</body>
</html>
